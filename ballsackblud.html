<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atlasfn - Secure Payments</title>
  
  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://api.stripe.com http://localhost:3000 https://*.onrender.com; frame-src https://js.stripe.com;">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous"/>
  <style>
    :root {
      --bg: #0f0f11;
      --card: #16161a;
      --text: #e0e0e0;
      --accent: #a855f7;
      --accent-dark: #8b35d4;
      --border: #2a2a32;
      --topbar: #1e1f22;
      --logo-bg: url('atlas_logo.png');
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    
    html {
      scroll-behavior: smooth;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes slideInDown {
      from {
        transform: translateY(-40px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    body {
      font-family: 'Sora', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      animation: fadeIn 1s ease-in-out;
      position: relative;
      overflow-x: hidden;
      cursor: none !important;
      -webkit-font-smoothing: antialiased;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    * {
      cursor: none !important;
    }

    button,
    a,
    input,
    select,
    textarea {
      cursor: none !important;
    }

    /* Hex Grid Background Canvas */
    #hexCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(168, 85, 247, 0.04);
      border: 1px solid rgba(168, 85, 247, 0.15);
      pointer-events: none;
      z-index: -1;
      opacity: 1;
      will-change: contents;
      image-rendering: pixelated;
    }
    
    /* Landing Page */
    .landing-page {
      color: #f0e9ff;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, rgba(20,10,40,0.98), rgba(30,5,50,0.98));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(20,10,40,0.98), rgba(30,5,50,0.98));
      backdrop-filter: blur(10px);
    }

    .landing-page.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .landing-content {
      text-align: center;
      max-width: 600px;
      padding: 2rem;
    }

    .landing-logo {
      margin-bottom: 2rem;
      animation: none !important;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .landing-title {
      font-size: 4rem;
      margin-bottom: 1rem;
      background: linear-gradient(90deg, #a855f7, #ec4899, #f97316);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 20px rgba(168, 85, 247, 0.4));
      font-family: 'Sora', system-ui, sans-serif;
      letter-spacing: 3px;
    }

    .landing-subtitle {
      font-size: 1.3rem;
      color: #aaa;
      margin-bottom: 3rem;
      line-height: 1.8;
    }

    .landing-btn {
      padding: 1.2rem 3rem;
      font-size: 1.3rem;
      border: none;
      border-radius: 50px;
      background: linear-gradient(90deg, #a855f7, #ec4899);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Sora', system-ui, sans-serif;
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
      letter-spacing: 2px;
    }

    .landing-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 15px 40px rgba(168, 85, 247, 0.6);
    }

    .landing-login-prompt {
      margin-top: 2rem;
      padding: 1.5rem;
      background: rgba(168, 85, 247, 0.1);
      border: 2px solid #a855f7;
      border-radius: 16px;
      animation: none !important;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
      50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); }
    }

    .landing-login-prompt h3 {
      color: #a855f7;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    .landing-login-prompt p {
      color: #ccc;
      margin-bottom: 1.5rem;
    }

    .landing-auth-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .landing-auth-btn {
      padding: 0.8rem 2rem;
      border: 2px solid #a855f7;
      border-radius: 50px;
      background: transparent;
      color: #a855f7;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Sora', system-ui, sans-serif;
    }

    .landing-auth-btn:hover {
      background: #a855f7;
      color: #fff;
      transform: translateY(-2px);
    }
    
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #fff; }

    @keyframes breathingPurple {
      0% {
        text-shadow: 0 0 15px rgba(168, 85, 247, 0.3), 0 0 30px rgba(168, 85, 247, 0.2);
        filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.4)) drop-shadow(0 0 20px rgba(168, 85, 247, 0.2));
      }
      50% {
        text-shadow: 0 0 30px rgba(168, 85, 247, 0.8), 0 0 60px rgba(168, 85, 247, 0.5);
        filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.8)) drop-shadow(0 0 40px rgba(168, 85, 247, 0.5));
      }
      100% {
        text-shadow: 0 0 15px rgba(168, 85, 247, 0.3), 0 0 30px rgba(168, 85, 247, 0.2);
        filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.4)) drop-shadow(0 0 20px rgba(168, 85, 247, 0.2));
      }
    }

    header {
      background: rgba(30, 31, 34, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 10100;
      border-bottom: none;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      will-change: transform;
    }
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 100%;
      width: 100%;
      margin: 0;
      gap: 1rem;
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .atlas-logo {
      width: 32px !important;
      height: 32px !important;
      border-radius: 50%;
      filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.5)) !important;
    }
    .logo {
      font-size: 2.2rem;
      font-weight: 900;
      background: linear-gradient(90deg, #a855f7, #ec4899, #a855f7);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
      filter: drop-shadow(0 0 10px rgba(236, 72, 153, 0.4));
      letter-spacing: 2px;
    }
    .nav-links { 
      display: flex; 
      gap: 0.5rem; 
      font-weight: 500;
      align-items: center;
    }
    .nav-links a {
      padding: 0.4rem 0.8rem;
      transition: all 0.2s;
      position: relative;
      color: #b5bac1;
      font-size: 0.875rem;
      border-radius: 4px;
      text-decoration: none;
    }
    .nav-links a:hover {
      color: #dbdee1;
      background: rgba(168, 85, 247, 0.12);
    }
    
    .redeem-btn {
      background: linear-gradient(135deg, #a855f7, #d946ef);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
    }
    
    .redeem-btn:hover {
      background: linear-gradient(135deg, #8b35d4, #c026d3);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
    }
    
    #nav-auth { display: flex; gap: 0.25rem; align-items: center; }
    .nav-auth-hidden { display: none !important; }

    /* Hamburger Menu Button */
    .hamburger-menu {
      position: relative;
      top: 0;
      left: 0;
      z-index: 10110;
      background: rgba(168, 85, 247, 0.1);
      border: 2px solid var(--accent);
      border-radius: 12px;
      width: 50px;
      height: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.3s;
      padding: 0;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }

    .hamburger-menu.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .hamburger-menu:hover {
      background: rgba(168, 85, 247, 0.2);
      transform: scale(1.05);
    }

    .hamburger-menu span {
      width: 25px;
      height: 3px;
      background: var(--accent);
      border-radius: 3px;
      transition: all 0.3s;
    }

    .hamburger-menu:hover span {
      background: #fff;
    }

    /* Dropdown Menu */
    .sidebar-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, #16161a 0%, #0a0a0c 100%);
      border-bottom: 2px solid var(--accent);
      z-index: 10500;
      transform: translateY(-110%);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.35s ease, opacity 0.35s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      padding: 1.5rem 5% 1.75rem;
    }

    .sidebar-menu.active {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar-header {
      padding: 0 0 1rem 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: none;
    }

    .sidebar-header h2 {
      color: var(--accent);
      font-size: 1.4rem;
      margin: 0;
    }

    .sidebar-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 2.5rem;
      cursor: pointer;
      transition: all 0.3s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .sidebar-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #ff6b6b;
      transform: rotate(90deg);
    }

    .sidebar-content {
      padding: 1rem 0 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
    }

    .sidebar-section {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      color: #9aa0aa;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin: 0.5rem 0 0.2rem;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 0.9rem;
      padding: 1rem 1.1rem;
      margin-bottom: 0;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      text-decoration: none;
      font-size: 1.1rem;
      transition: all 0.3s;
      position: relative;
    }

    .sidebar-item:hover {
      background: rgba(168, 85, 247, 0.2);
      border-color: var(--accent);
      transform: translateX(-5px);
    }

    .sidebar-item i {
      font-size: 1.3rem;
      color: var(--accent);
      width: 30px;
      text-align: center;
    }

    .panel-action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.6rem;
      grid-column: 1 / -1;
    }

    .panel-action-btn {
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: #d8dbe2;
      font-size: 0.95rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .panel-action-btn:hover {
      background: rgba(168, 85, 247, 0.18);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .sidebar-badge {
      position: absolute;
      right: 1rem;
      background: linear-gradient(135deg, #ff6b6b, #ff0055);
      color: #fff;
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .sidebar-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .modern-modal {
      display: none;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 11000;
      padding: 2rem;
    }

    .modern-modal.active {
      display: flex;
    }

    /* Modal Tabs */
    .modern-modal-tabs {
      display: flex;
      gap: 0.5rem;
      padding: 0 2rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-tab {
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      color: #888;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
    }

    .modal-tab:hover {
      color: var(--text);
    }

    .modal-tab.active {
      color: var(--accent);
    }

    .modal-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }

    /* Tab Content */
    .support-tab-content,
    .settings-tab-content {
      display: none;
    }

    .support-tab-content.active,
    .settings-tab-content.active {
      display: block;
    }

    /* Form Groups */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text);
      font-weight: 600;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0a0a0c;
      color: var(--text);
      font-family: inherit;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    .form-group small {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    /* Settings Options */
    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: rgba(168, 85, 247, 0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .settings-option h4 {
      margin: 0 0 0.5rem 0;
      color: var(--text);
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #333;
      transition: 0.4s;
      border-radius: 30px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--accent);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }

    /* Ticket Cards */
    .ticket-card {
      background: rgba(168, 85, 247, 0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }

    .ticket-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .ticket-status {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .ticket-status.open {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .ticket-status.in-progress {
      background: rgba(249, 115, 22, 0.2);
      color: #f97316;
    }

    .ticket-status.closed {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .ticket-priority {
      padding: 0.3rem 0.6rem;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .ticket-priority.low {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .ticket-priority.medium {
      background: rgba(249, 115, 22, 0.2);
      color: #f97316;
    }

    .ticket-priority.high {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* Order History Table */
    .order-table {
      width: 100%;
      border-collapse: collapse;
    }

    .order-table th,
    .order-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .order-table th {
      color: var(--accent);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    .order-table td {
      color: var(--text);
    }

    .order-table tr:hover {
      background: rgba(168, 85, 247, 0.05);
    }

    .btn {
      padding: 0.7rem 1.5rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-primary {
      background: var(--accent);
      color: #000;
    }
    .btn-primary:hover { background: #fff; transform: translateY(-2px); }

    .hero {
      text-align: center;
      padding: 8rem 5% 6rem;
      
      position: relative;
      overflow: hidden;
    }
    
    .hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(168,85,247,0.15), transparent);
      border-radius: 50%;
      filter: blur(60px);
    }
    .hero h1 {
      font-size: 3.8rem;
      margin-bottom: 1rem;
      color: #a855f7;
      filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.3));
    }
    .hero p {
      font-size: 1.4rem;
      max-width: 700px;
      margin: 0 auto 2.5rem;
      color: #a855f7;
    }

    .info-box {
      margin-top: 2rem;
      padding: 1rem 1.5rem;
      background: transparent;
      border: 1px solid var(--accent);
      border-radius: 12px;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
    }

    .info-box p {
      margin: 0;
      color: var(--accent);
      font-size: 0.95rem;
    }

    .info-box i {
      margin-right: 0.3rem;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 0 5%; }

    .payment-section {
      text-align: center;
      padding: 4rem 0;
      background: transparent;
    }

    .payment-section h2 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      background: linear-gradient(180deg, #a855f7 0%, #000 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .payment-section p {
      font-size: 1.1rem;
      color: transparent;
      background: linear-gradient(180deg, #a855f7 0%, #000 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 3rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .faq-section {
      padding: 4rem 0 5rem;
    }

    .faq-section h2 {
      font-size: 2.4rem;
      margin-bottom: 1rem;
      background: linear-gradient(90deg, var(--accent), #ff00aa);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }

    .faq-section p.section-intro {
      text-align: center;
      color: #aaa;
      margin-bottom: 2.5rem;
    }

    .faq-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.2rem;
    }

    .faq-item {
      background: rgba(22, 22, 26, 0.4);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.2rem;
      backdrop-filter: blur(10px);
    }

    .faq-item h3 {
      color: var(--accent);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .faq-item p {
      color: #bbb;
      font-size: 0.95rem;
    }

    .payment-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      max-width: 1200px;
      margin: 0 auto 3rem;
    }

    .product-card {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.35s;
      position: relative;
      overflow: hidden;
    }

    .product-card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      opacity: 0;
      transition: opacity 0.35s;
      z-index: -1;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45);
    }

    .product-card:hover::before {
      opacity: 0.25;
    }

    .product-card-image {
      width: 100%;
      height: 180px;
      background: #000;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: #a855f7;
      border: 1px solid var(--border);
    }

    .product-card-image i {
      color: transparent;
      background-image: linear-gradient(180deg, #a855f7 0%, #000 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .product-card-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: linear-gradient(135deg, #00d4ff, #00a0c8);
      color: #000;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .product-card-title {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
      color: #fff;
    }

    .product-card-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: #00d4ff;
      margin-bottom: 0.5rem;
    }

    .product-card-desc {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 1rem;
    }

    .btn-pay {
      width: 100%;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 50px;
      background: var(--accent);
      color: #000;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-pay:hover {
      background: #fff;
      transform: translateY(-2px);
    }

    #card-element {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0a0a0c;
      color: var(--text);
      margin: 1rem 0;
      font-family: inherit;
      font-size: 16px;
      min-height: 40px;
    }

    /* Stripe card element text visibility */
    .StripeElement {
      color: var(--text) !important;
      font-size: 16px !important;
    }

    .StripeElement::placeholder {
      color: #666 !important;
    }

    .payment-form-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      max-width: 400px;
      margin: 0 auto 4rem;
    }

    .product-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 11000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .product-detail-modal.active {
      display: flex;
    }

    .product-detail-content {
      background: rgba(22, 22, 26, 0.6);
      border: 1px solid var(--border);
      border-radius: 20px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 0;
      position: relative;
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      backdrop-filter: blur(15px);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .product-detail-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      color: var(--text);
      transition: all 0.3s;
      z-index: 10;
    }

    .product-detail-close:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #ff6b6b;
      transform: rotate(90deg);
    }

    .product-detail-header {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      padding: 2rem;
    }

    .product-detail-image {
      width: 100%;
      height: 350px;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(0, 212, 255, 0.15) 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5rem;
      color: var(--accent);
      border: 1px solid var(--border);
    }

    .product-detail-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .product-detail-badge {
      display: inline-block;
      background: linear-gradient(135deg, #00d4ff, #00a0c8);
      color: #000;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 1rem;
      width: fit-content;
    }

    .product-detail-title {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: #fff;
    }

    .product-detail-price {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), #ff00aa);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }

    .product-detail-desc {
      font-size: 1rem;
      color: #aaa;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .product-detail-body {
      padding: 0 2rem 2rem;
    }

    .product-variants {
      margin-bottom: 2rem;
    }

    .product-variants h4 {
      color: var(--text);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .variant-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.8rem;
    }

    .variant-option {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .variant-option:hover {
      background: rgba(168, 85, 247, 0.1);
      border-color: var(--accent);
    }

    .variant-option.selected {
      background: rgba(168, 85, 247, 0.2);
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
    }

    .variant-label {
      font-size: 0.9rem;
      color: var(--text);
      margin-bottom: 0.3rem;
    }

    .variant-price {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .product-quantity {
      margin-bottom: 2rem;
    }

    .product-quantity h4 {
      color: var(--text);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .quantity-btn {
      width: 45px;
      height: 45px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quantity-btn:hover {
      background: rgba(168, 85, 247, 0.2);
      border-color: var(--accent);
    }

    .quantity-display {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
      min-width: 50px;
      text-align: center;
    }

    .product-actions {
      display: flex;
      gap: 1rem;
    }

    .btn-add-cart,
    .btn-buy-now {
      flex: 1;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-add-cart {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--accent);
      color: var(--accent);
    }

    .btn-add-cart:hover {
      background: rgba(168, 85, 247, 0.2);
      transform: translateY(-2px);
    }

    .btn-buy-now {
      background: linear-gradient(135deg, var(--accent), #ff00aa);
      color: #000;
    }

    .btn-buy-now:hover {
      background: linear-gradient(135deg, #ff00aa, var(--accent));
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
    }

    @media (max-width: 768px) {
      .product-detail-header {
        grid-template-columns: 1fr;
      }

      .product-detail-image {
        height: 250px;
      }

      .variant-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }

      .product-actions {
        flex-direction: column;
      }
    }

    .form-group {
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text);
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0a0a0c;
      color: var(--text);
      font-size: 1rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
    }

    /* Auth Modal Styles */
    .auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 11000;
    }

    .auth-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    .auth-modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 400px;
      width: 90%;
      animation: slideInDown 0.4s ease-out;
    }

    .auth-modal-content h2 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      color: var(--accent);
    }

    .auth-modal-content .form-group {
      margin-bottom: 1.2rem;
    }

    .auth-modal-content .form-group input {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0a0a0c;
      color: var(--text);
      font-size: 0.95rem;
    }

    .auth-modal-content .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
    }

    .auth-modal-btn {
      width: 100%;
      padding: 0.8rem;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
      margin-bottom: 1rem;
    }

    .auth-modal-btn:hover {
      background: #fff;
      transform: translateY(-2px);
    }

    .auth-modal-toggle {
      text-align: center;
      color: #888;
      font-size: 0.9rem;
    }

    .auth-modal-toggle a {
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
    }

    .auth-modal-toggle a:hover {
      text-decoration: underline;
    }

    .auth-error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid #ff6b6b;
      color: #ff6b6b;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      display: none;
    }

    .auth-error.show {
      display: block;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .notif-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .notif-btn {
      position: relative;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .notif-btn:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
    }

    .notif-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      background: #ff6b6b;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.35);
    }

    .notif-dropdown {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      min-width: 280px;
      max-width: 340px;
      background: #121218;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
      padding: 0.6rem;
      display: none;
      z-index: 3000;
    }

    .notif-dropdown.open {
      display: block;
      animation: fadeIn 0.2s ease-in-out;
    }

    .notif-item {
      padding: 0.6rem 0.7rem;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      color: var(--text);
      transition: all 0.2s;
    }

    .notif-item:hover {
      background: rgba(0, 212, 255, 0.08);
    }

    .notif-item.unread {
      border: 1px solid rgba(0, 212, 255, 0.2);
      background: rgba(0, 212, 255, 0.06);
    }

    .notif-time {
      color: #aaa;
      font-size: 0.75rem;
    }

    .notif-empty {
      color: #888;
      font-size: 0.85rem;
      padding: 0.6rem;
      text-align: center;
    }

    .user-name {
      color: var(--text);
      font-weight: 500;
    }

    .logout-btn {
      padding: 0.5rem 1rem;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: #ff5252;
      transform: translateY(-2px);
    }

    .staff-btn {
      padding: 0.5rem 1rem;
      background: linear-gradient(90deg, #a855f7, #ec4899);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      font-weight: 600;
    }

    .staff-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(168, 85, 247, 0.4);
    }

    /* Staff Panel */
    .staff-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      overflow-y: auto;
      padding: 2rem;
    }

    .staff-panel.active {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    .staff-panel-content {
      background: linear-gradient(180deg, #16161a, #0a0a0c);
      border: 2px solid #a855f7;
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.3);
    }

    .staff-panel-content h2 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(90deg, #a855f7, #ec4899);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .staff-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(168, 85, 247, 0.1);
      border: 1px solid #a855f7;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2rem;
      color: #a855f7;
      margin-bottom: 0.5rem;
    }

    .stat-card p {
      color: #aaa;
      font-size: 0.9rem;
    }

    .users-list {
      margin-top: 2rem;
    }

    .users-list h3 {
      color: var(--text);
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .user-item {
      background: rgba(168, 85, 247, 0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.2rem;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }

    .user-item:hover {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.1);
    }

    .user-item.blacklisted {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }

    .user-item.timed-out {
      border-color: #ffa500;
      background: rgba(255, 165, 0, 0.1);
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .user-details {
      flex: 1;
    }

    .user-details h4 {
      color: var(--text);
      margin-bottom: 0.3rem;
      font-size: 1.1rem;
    }

    .user-details p {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
    }

    .user-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .badge {
      padding: 0.3rem 0.8rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-staff {
      background: linear-gradient(90deg, #a855f7, #ec4899);
      color: white;
    }

    .badge-blacklisted {
      background: #ff6b6b;
      color: white;
    }

    .badge-timeout {
      background: #ffa500;
      color: white;
    }

    .user-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .action-btn-timeout {
      background: #ffa500;
      color: white;
    }

    .action-btn-timeout:hover {
      background: #ff8c00;
      transform: translateY(-2px);
    }

    .action-btn-blacklist {
      background: #ff6b6b;
      color: white;
    }

    .action-btn-blacklist:hover {
      background: #ff5252;
      transform: translateY(-2px);
    }

    .action-btn-restore {
      background: #00d4ff;
      color: #000;
    }

    .action-btn-restore:hover {
      background: #00bfff;
      transform: translateY(-2px);
    }

    .action-btn-staff {
      background: #a855f7;
      color: white;
    }

    .action-btn-staff:hover {
      background: #9333ea;
      transform: translateY(-2px);
    }

    .action-btn-request {
      background: #ff6b00;
      color: white;
    }

    .action-btn-request:hover {
      background: #cc5500;
      transform: translateY(-2px);
    }

    .close-staff-btn {
      width: 100%;
      padding: 0.8rem;
      margin-top: 2rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .close-staff-btn:hover {
      background: var(--border);
    }

    /* Head Staff Panel */
    .head-staff-btn {
      padding: 0.5rem 1rem;
      background: linear-gradient(90deg, #dc2626, #991b1b);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      font-weight: 600;
    }

    .head-staff-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
    }

    .head-staff-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      overflow-y: auto;
      padding: 2rem;
    }

    .head-staff-panel.active {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    .head-staff-panel-content {
      background: linear-gradient(180deg, #1a0606, #0a0a0a);
      border: 2px solid #dc2626;
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(220, 38, 38, 0.3);
    }

    .head-staff-panel-content h2 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(90deg, #dc2626, #991b1b);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .badge-head-staff {
      background: linear-gradient(90deg, #dc2626, #991b1b);
      color: white;
    }

    /* Dev Panel */
    .dev-btn {
      padding: 0.5rem 1rem;
      background: linear-gradient(90deg, #ff0080, #ff6b00);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      font-weight: 600;
    }

    .dev-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 0, 128, 0.4);
    }

    .dev-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      overflow-y: auto;
      padding: 2rem;
    }

    .dev-panel.active {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    .dev-panel-content {
      background: linear-gradient(180deg, #1a0a0a, #0a0a0a);
      border: 2px solid #ff0080;
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 1000px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(255, 0, 128, 0.3);
    }

    .dev-panel-content h2 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(90deg, #ff0080, #ff6b00);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Shared Panel UI */
    .panel-shell {
      background: linear-gradient(180deg, rgba(168, 85, 247, 0.22) 0%, rgba(0, 0, 0, 0.92) 100%);
      border: 1px solid rgba(168, 85, 247, 0.45);
      border-radius: 20px;
      padding: 2.5rem;
      max-width: 1000px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
      position: relative;
      backdrop-filter: blur(14px);
    }

    .panel-shell::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 22px;
      background: conic-gradient(from 0deg, transparent 0deg, rgba(168, 85, 247, 0.9) 90deg, transparent 180deg, rgba(168, 85, 247, 0.4) 270deg, transparent 360deg);
      animation: none !important;
      z-index: -1;
      filter: blur(2px);
    }

    .panel-shell::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(168, 85, 247, 0.18) 0%, rgba(0, 0, 0, 0.88) 100%);
      z-index: -1;
    }

    @keyframes panelGlowSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .panel-shell-dev {
      border-color: rgba(255, 0, 128, 0.45);
      box-shadow: 0 30px 80px rgba(255, 0, 128, 0.2);
    }

    .panel-shell-head {
      border-color: rgba(220, 38, 38, 0.45);
      box-shadow: 0 30px 80px rgba(220, 38, 38, 0.2);
    }

    .panel-shell-staff {
      border-color: rgba(168, 85, 247, 0.45);
      box-shadow: 0 30px 80px rgba(168, 85, 247, 0.2);
    }

    .panel-shell-owner {
      border-color: rgba(255, 149, 0, 0.55);
      box-shadow: 0 30px 80px rgba(255, 149, 0, 0.22);
    }

    .dev-panel-content.panel-shell,
    .head-staff-panel-content.panel-shell,
    .staff-panel-content.panel-shell {
      border-radius: 20px;
      padding: 2.5rem;
      max-width: 1000px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      margin-bottom: 1.5rem;
    }

    .panel-header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .panel-logo {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      border: 1px solid rgba(168, 85, 247, 0.45);
      background: rgba(10, 10, 12, 0.6);
      padding: 6px;
      object-fit: contain;
      filter: drop-shadow(0 0 14px rgba(168, 85, 247, 0.8));
    }

    .panel-title {
      font-size: 2rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .panel-shell-dev .panel-title {
      background: linear-gradient(90deg, #ff0080, #ff6b00);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .panel-shell-head .panel-title {
      background: linear-gradient(90deg, #dc2626, #991b1b);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .panel-shell-staff .panel-title {
      background: linear-gradient(90deg, #a855f7, #7c3aed);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .panel-shell-owner .panel-title {
      background: linear-gradient(90deg, #ff9500, #ff6b00);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .panel-subtitle {
      color: #9aa0aa;
      font-size: 0.95rem;
      margin-top: 0.35rem;
    }

    .panel-role {
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .panel-role-dev {
      background: linear-gradient(90deg, #ff0080, #ff6b00);
      color: #0a0a0c;
    }

    .panel-role-head {
      background: linear-gradient(90deg, #dc2626, #991b1b);
      color: #fff;
    }

    .panel-role-staff {
      background: linear-gradient(90deg, #a855f7, #7c3aed);
      color: #0a0a0c;
    }

    .panel-role-owner {
      background: linear-gradient(90deg, #ff9500, #ff6b00);
      color: #0a0a0c;
    }

    .panel-perms {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .panel-perm {
      padding: 0.5rem 0.9rem;
      border-radius: 12px;
      background: rgba(168, 85, 247, 0.08);
      border: 1px solid rgba(168, 85, 247, 0.25);
      color: #cfd2d8;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-perm strong {
      color: #fff;
    }

    .panel-block {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .panel-block h3 {
      margin-bottom: 1rem;
      font-size: 1.15rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .panel-input {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0a0a0c;
      color: var(--text);
      font-size: 0.95rem;
    }

    .dev-sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .dev-section {
      background: rgba(255, 0, 128, 0.05);
      border: 1px solid rgba(255, 0, 128, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .dev-section h3 {
      color: #ff0080;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .dev-action-btn {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 0.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .dev-action-btn-danger {
      background: #ff0080;
      color: white;
    }

    .dev-action-btn-danger:hover {
      background: #cc0066;
      transform: translateY(-2px);
    }

    .dev-action-btn-warning {
      background: #ff6b00;
      color: white;
    }

    .dev-action-btn-warning:hover {
      background: #cc5500;
      transform: translateY(-2px);
    }

    .dev-action-btn-info {
      background: #00d4ff;
      color: #000;
    }

    .dev-action-btn-info:hover {
      background: #00bfff;
      transform: translateY(-2px);
    }

    .dev-input {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 0.5rem;
      border: 1px solid rgba(255, 0, 128, 0.3);
      border-radius: 8px;
      background: #0a0a0c;
      color: var(--text);
      font-size: 0.9rem;
    }

    .dev-input:focus {
      outline: none;
      border-color: #ff0080;
      box-shadow: 0 0 0 2px rgba(255, 0, 128, 0.1);
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .analytics-card {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid #00d4ff;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .analytics-card h4 {
      font-size: 2rem;
      color: #00d4ff;
      margin-bottom: 0.3rem;
    }

    .analytics-card p {
      color: #888;
      font-size: 0.85rem;
    }

    .maintenance-mode-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a0a1a, #0a0a1a);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      flex-direction: column;
      text-align: center;
      padding: 2rem;
    }

    .maintenance-mode-overlay.active {
      display: flex;
    }

    .maintenance-mode-overlay h1 {
      font-size: 3rem;
      color: #ff0080;
      margin-bottom: 1rem;
    }

    .maintenance-mode-overlay p {
      font-size: 1.2rem;
      color: #888;
      max-width: 600px;
      margin-bottom: 2rem;
    }

    .badge-dev {
      background: linear-gradient(90deg, #ff0080, #ff6b00);
      color: white;
    }

    .badge-ipban {
      background: #ff0000;
      color: white;
    }

    .badge-apiban {
      background: #ff6b00;
      color: white;
    }

    /* Permissions Panel */
    .permissions-btn {
      padding: 0.5rem 1rem;
      background: linear-gradient(90deg, #00d4ff, #0099bb);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      font-weight: 600;
    }

    .permissions-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
    }

    .permissions-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      overflow-y: auto;
      padding: 2rem;
    }

    .permissions-panel.active {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    .permissions-panel-content {
      background: linear-gradient(180deg, #0a1a1a, #0a0a0a);
      border: 2px solid #00d4ff;
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 212, 255, 0.3);
    }

    .permissions-panel-content h2 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(90deg, #00d4ff, #0099bb);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .permission-item {
      background: rgba(0, 212, 255, 0.05);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 12px;
      padding: 1.2rem;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }

    .permission-item:hover {
      border-color: #00d4ff;
      background: rgba(0, 212, 255, 0.1);
    }

    .permission-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .permission-details {
      flex: 1;
    }

    .permission-details h4 {
      color: var(--text);
      margin-bottom: 0.3rem;
      font-size: 1.1rem;
    }

    .permission-details p {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
    }

    .permission-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .panel-message {
      display: none;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      margin: 1rem 0;
      font-size: 0.9rem;
      border: 1px solid transparent;
    }

    .panel-message.show {
      display: block;
    }

    .panel-message.info {
      background: rgba(0, 212, 255, 0.08);
      border-color: rgba(0, 212, 255, 0.4);
      color: #8be9ff;
    }

    .panel-message.success {
      background: rgba(0, 255, 136, 0.08);
      border-color: rgba(0, 255, 136, 0.4);
      color: #7dffb7;
    }

    .panel-message.error {
      background: rgba(255, 107, 107, 0.08);
      border-color: rgba(255, 107, 107, 0.4);
      color: #ff9b9b;
    }

    .panel-controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .panel-select {
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0a0a0c;
      color: var(--text);
      font-size: 0.9rem;
    }

    .ban-list {
      margin-top: 0.75rem;
      display: none;
      border-top: 1px solid var(--border);
      padding-top: 0.75rem;
    }

    .ban-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 0.6rem;
      background: rgba(255, 255, 255, 0.02);
    }

    .ban-item button {
      padding: 0.45rem 0.75rem;
      border: none;
      border-radius: 8px;
      background: #ff6b6b;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .ban-item button:hover {
      background: #ff5252;
      transform: translateY(-1px);
    }

    .request-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.9rem 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.02);
      margin-bottom: 0.8rem;
    }

    .request-item.highlight {
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
    }

    .request-meta {
      color: #aaa;
      font-size: 0.85rem;
    }

    .request-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .request-actions button {
      padding: 0.45rem 0.9rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .request-actions .approve-btn {
      background: #00d4ff;
      color: #000;
    }

    .request-actions .deny-btn {
      background: #ff6b6b;
      color: white;
    }

    .request-actions button:hover {
      transform: translateY(-1px);
    }

    .action-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      padding: 1.5rem;
    }

    .action-modal.active {
      display: flex;
      animation: fadeIn 0.2s ease-in-out;
    }

    .action-modal-content {
      background: linear-gradient(180deg, #121218, #0a0a0c);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.8rem;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .action-modal-content h3 {
      margin-bottom: 0.8rem;
      color: #fff;
      font-size: 1.4rem;
    }

    .action-modal-content p {
      color: #bbb;
      margin-bottom: 1.2rem;
      line-height: 1.5;
    }

    .action-modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .modal-confirm,
    .modal-cancel {
      padding: 0.6rem 1.2rem;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .modal-confirm {
      background: #00d4ff;
      color: #000;
    }

    .modal-confirm.danger {
      background: #ff6b6b;
      color: #fff;
    }

    .modal-confirm.warning {
      background: #ff6b00;
      color: #fff;
    }

    .modal-cancel {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .modal-confirm:hover,
    .modal-cancel:hover {
      transform: translateY(-1px);
    }

    #global-toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 13000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 1px solid transparent;
      background: #121218;
      color: #fff;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      font-size: 0.9rem;
    }

    .toast.success {
      border-color: rgba(0, 255, 136, 0.6);
      color: #7dffb7;
    }

    .toast.error {
      border-color: rgba(255, 107, 107, 0.6);
      color: #ff9b9b;
    }

    .ban-banner {
      position: fixed;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%) translateX(120%);
      padding: 0.85rem 1.1rem;
      background: rgba(18, 18, 24, 0.95);
      border: 1px solid rgba(255, 107, 107, 0.6);
      border-radius: 12px;
      color: #ff9b9b;
      font-weight: 700;
      letter-spacing: 0.2px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.45);
      z-index: 13000;
      transition: transform 0.25s ease-out, opacity 0.25s ease-out;
      opacity: 0;
      max-width: 260px;
      text-transform: lowercase;
    }

    .ban-banner.show {
      transform: translateY(-50%) translateX(0);
      opacity: 1;
    }

    .test-mode-banner {
      position: fixed;
      left: 50%;
      top: 1rem;
      transform: translateX(-50%);
      background: rgba(255, 107, 0, 0.95);
      color: #0a0a0c;
      padding: 0.6rem 1rem;
      border-radius: 12px;
      z-index: 14000;
      display: none;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
    }

    .test-mode-banner button {
      background: #0a0a0c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.35rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
    }

    .test-mode-banner.show {
      display: flex;
    }

    .privacy-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 12, 0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 15000;
      padding: 2rem;
      text-align: center;
    }

    .privacy-overlay.active {
      display: flex;
    }

    .privacy-overlay-content {
      max-width: 520px;
      border: 1px solid rgba(255, 107, 107, 0.45);
      border-radius: 16px;
      background: #121218;
      padding: 2rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
    }

    .privacy-overlay-content h3 {
      margin-bottom: 0.75rem;
      color: #ff9b9b;
      font-size: 1.3rem;
    }

    .privacy-overlay-content p {
      color: #c9c9d1;
      font-size: 0.95rem;
    }

    .grant-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .grant-btn-staff {
      background: #a855f7;
      color: white;
    }

    .grant-btn-staff:hover {
      background: #9333ea;
      transform: translateY(-2px);
    }

    .grant-btn-dev {
      background: #ff0080;
      color: white;
    }

    .grant-btn-dev:hover {
      background: #cc0066;
      transform: translateY(-2px);
    }

    .grant-btn-revoke {
      background: #ff6b6b;
      color: white;
    }

    .grant-btn-revoke:hover {
      background: #ff5252;
      transform: translateY(-2px);
    }

    /* Custom Payment System Styles */
    .payment-method-card {
      background: rgba(168, 85, 247, 0.1);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .payment-method-card:hover {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.2);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2);
    }

    .payment-method-card i {
      font-size: 2rem;
      color: #a855f7;
    }

    .payment-method-card p {
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0;
    }

    .payment-method-card.selected {
      border-color: #00d4ff;
      background: rgba(0, 212, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }

    .payment-method-card.selected i {
      color: #00d4ff;
      animation: none !important;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Transaction History */
    .transaction-item {
      background: rgba(168, 85, 247, 0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .transaction-item:hover {
      background: rgba(168, 85, 247, 0.1);
      border-color: #a855f7;
    }

    .transaction-info {
      flex: 1;
    }

    .transaction-id {
      color: var(--accent);
      font-family: monospace;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .transaction-product {
      color: var(--text);
      margin: 0.25rem 0;
      font-size: 0.95rem;
    }

    .transaction-date {
      color: #888;
      font-size: 0.8rem;
    }

    .transaction-status {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .transaction-status.completed {
      background: rgba(0, 255, 136, 0.2);
      color: #7dffb7;
    }

    .transaction-status.processing {
      background: rgba(0, 212, 255, 0.2);
      color: #00d4ff;
    }

    .transaction-status.failed {
      background: rgba(255, 107, 107, 0.2);
      color: #ff9b9b;
    }

    .transaction-status.refunded {
      background: rgba(255, 165, 0, 0.2);
      color: #ffb347;
    }

    .transaction-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: #00d4ff;
      text-align: right;
      margin-left: 1rem;
    }

    /* Owner Panel Styles */
    .owner-tab-btn {
      transition: all 0.3s ease;
    }

    .owner-tab-btn:hover {
      color: #ff6b00 !important;
    }

    .owner-tab-content {
      animation: fadeIn 0.3s ease-in-out;
    }

    .payment-card {
      background: rgba(168, 85, 247, 0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .payment-card:hover {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.1);
    }

    .payment-card-info {
      flex: 1;
    }

    .payment-card-number {
      font-family: monospace;
      font-size: 1.1rem;
      color: var(--text);
      margin: 0.5rem 0;
      letter-spacing: 2px;
    }

    .payment-card-holder {
      color: #888;
      font-size: 0.9rem;
    }

    .payment-card-expiry {
      color: #666;
      font-size: 0.85rem;
      margin-top: 0.3rem;
    }

    .payment-card-badge {
      display: inline-block;
      background: linear-gradient(135deg, #a855f7, #ec4899);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 1rem;
    }

    .payment-card-default {
      background: #00d4ff;
      color: #000;
    }

    .payment-card-actions {
      display: flex;
      gap: 0.5rem;
    }

    .payment-card-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .payment-card-btn-delete {
      background: #ff6b6b;
      color: white;
    }

    .payment-card-btn-delete:hover {
      background: #ff5252;
      transform: translateY(-2px);
    }

    .payout-item {
      background: rgba(255, 107, 0, 0.05);
      border: 1px solid rgba(255, 107, 0, 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .payout-info {
      flex: 1;
    }

    .payout-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ff6b00;
    }

    .payout-date {
      color: #888;
      font-size: 0.85rem;
      margin-top: 0.3rem;
    }

    .payout-status {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .payout-status.pending {
      background: rgba(255, 165, 0, 0.2);
      color: #ffb347;
    }

    .payout-status.completed {
      background: rgba(0, 255, 136, 0.2);
      color: #7dffb7;
    }

    .payout-status.failed {
      background: rgba(255, 107, 107, 0.2);
      color: #ff9b9b;
    }

    footer {
      background: #0a0a0c;
      padding: 4rem 5% 2rem;
      text-align: center;
      border-top: 1px solid var(--border);
    }
    .footer-links { display: flex; justify-content: center; gap: 2rem; margin: 1.5rem 0; flex-wrap: wrap; }
    .footer-links a { color: #888; font-size: 0.95rem; }
    .footer-links a:hover { color: var(--accent); }

    @media (max-width: 768px) {
      .hero h1 { font-size: 2.8rem; }
      .nav-links { display: none; } /* add burger menu if needed */
    }

    /* Custom Crosshair Cursor */
    * {
      cursor: none !important;
    }

    /* Allow normal cursor on inputs and interactive elements */
    input, textarea, select, button, a {
      cursor: pointer !important;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    textarea {
      cursor: text !important;
    }

    .crosshair {
      position: fixed;
      width: 30px;
      height: 30px;
      pointer-events: none;
      z-index: 13000;
      transform: translate(-50%, -50%);
      will-change: left, top;
      transition: none;
      display: block;
      visibility: visible;
      left: 0;
      top: 0;
      opacity: 1;
    }

    .crosshair::before,
    .crosshair::after {
      content: '';
      position: absolute;
      background: linear-gradient(90deg, #a855f7, #d946ef);
      box-shadow: 0 0 15px #a855f7, 0 0 30px rgba(168, 85, 247, 0.8);
      z-index: 13001;
    }

    .crosshair::before {
      width: 4px;
      height: 100%;
      left: 50%;
      transform: translateX(-50%);
    }

    .crosshair::after {
      height: 4px;
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
    }

    .crosshair-center {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle, #fff 0%, #a855f7 70%);
      border: 2px solid #a855f7;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateZ(0);
      box-shadow: 0 0 20px #a855f7, 0 0 40px rgba(168, 85, 247, 0.9), inset 0 0 8px #fff;
      will-change: auto;
      z-index: 13002;
    }

    /* Shockwave Animation - Removed */

  </style>
</head>
<body>
  <!-- Hex Grid Background Canvas -->
  <canvas id="hexCanvas"></canvas>

  <!-- Sidebar Menu -->
  <div class="sidebar-menu" id="sidebarMenu">
    <div class="sidebar-header">
      <h2><i class="fas fa-user-circle"></i> Account Menu</h2>
      <button class="sidebar-close" onclick="toggleSidebar()"></button>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-section"><i class="fas fa-bolt"></i> Panels</div>
      <div class="panel-action-grid">
        <button class="panel-action-btn" type="button">Fly</button>
        <button class="panel-action-btn" type="button">Godmode</button>
        <button class="panel-action-btn" type="button">Invisible</button>
        <button class="panel-action-btn" type="button">Set Health</button>
        <button class="panel-action-btn" type="button">Set Jump</button>
        <button class="panel-action-btn" type="button">Set Speed</button>
      </div>
      <div class="sidebar-section"><i class="fas fa-user"></i> Account</div>
      <a href="#" class="sidebar-item" onclick="openOrderHistory()">
        <i class="fas fa-shopping-bag"></i>
        <span>Order History</span>
      </a>
      <a href="#" class="sidebar-item" onclick="openSupport()">
        <i class="fas fa-headset"></i>
        <span>Support</span>
        <span class="sidebar-badge" id="ticketBadge" style="display: none;">0</span>
      </a>
      <a href="#" class="sidebar-item" onclick="openSettings()">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
      <a href="#" class="sidebar-item" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span>Sign Out</span>
      </a>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Landing Page -->
  <div class="landing-page hidden" id="landingPage" style="display: none;">
    <div class="landing-content">
      <div class="landing-logo">
        <img src="atlas_logo.png" class="atlas-logo" alt="Atlasfn Logo" width="150" height="150" style="filter: drop-shadow(0 0 30px rgba(168, 85, 247, 0.8)); object-fit: contain;" onerror="handleLogoError(this)">
      </div>
      
      <h1 class="landing-title">ATLASFN</h1>
      <p class="landing-subtitle">Secure payment platform powered by cutting-edge technology</p>
      
      <!-- Content that changes based on login status -->
      <div id="landingLoggedIn" style="display: none;">
        <button class="landing-btn" onclick="goToStore()">PURCHASE ACCESS</button>
      </div>
      
      <div id="landingLoggedOut">
        <div class="landing-login-prompt">
          <h3> Secure Access Required</h3>
          <p>Please sign in to access the store</p>
          <div class="landing-auth-buttons">
            <button class="landing-auth-btn" onclick="window.open('login.html', '_blank')">LOG IN</button>
            <button class="landing-auth-btn" onclick="window.open('signup.html', '_blank')">SIGN UP</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Crosshair Cursor -->
  <div class="crosshair" id="crosshair">
    <div class="crosshair-center"></div>
  </div>

  <header>
    <nav>
      <button class="hamburger-menu" id="hamburgerBtn" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="nav-links">
        <a href="purchase.html">Purchase</a>
        <a href="#">About</a>
        <a href="#faq">FAQ</a>
        <a href="https://discord.gg/Y6jVxPVV" target="_blank" title="Join our Discord">
          <i class="fab fa-discord"></i> Discord
        </a>
        <button onclick="openRedeemModal()" class="redeem-btn">
          <i class="fas fa-ticket-alt"></i> Redeem Panel Key
        </button>
      </div>
    </nav>
  </header>

  <!-- Add Funds Modal -->
  <div class="auth-modal" id="addFundsModal">
    <div class="auth-modal-content">
      <h2><i class="fas fa-wallet"></i> Add Funds to Wallet</h2>
      <div class="auth-error" id="fundsError"></div>
      <p style="font-size: 14px; color: #888; margin-bottom: 15px;">Current Balance: <span style="color: #a855f7; font-weight: bold;">$<span id="currentBalance">0.00</span></span></p>
      
      <div class="form-group">
        <label>Amount to Add ($)</label>
        <input type="number" id="fundsAmount" placeholder="10.00" min="0.50" step="0.01">
      </div>
      
      <div class="form-group">
        <label>Quick Select</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
          <button class="auth-modal-btn" style="background: rgba(168, 85, 247, 0.5); font-size: 12px; padding: 8px;" onclick="setFundsAmount(10)">$10</button>
          <button class="auth-modal-btn" style="background: rgba(168, 85, 247, 0.5); font-size: 12px; padding: 8px;" onclick="setFundsAmount(25)">$25</button>
          <button class="auth-modal-btn" style="background: rgba(168, 85, 247, 0.5); font-size: 12px; padding: 8px;" onclick="setFundsAmount(50)">$50</button>
          <button class="auth-modal-btn" style="background: rgba(168, 85, 247, 0.5); font-size: 12px; padding: 8px;" onclick="setFundsAmount(100)">$100</button>
          <button class="auth-modal-btn" style="background: rgba(168, 85, 247, 0.5); font-size: 12px; padding: 8px;" onclick="setFundsAmount(250)">$250</button>
          <button class="auth-modal-btn" style="background: rgba(168, 85, 247, 0.5); font-size: 12px; padding: 8px;" onclick="setFundsAmount(500)">$500</button>
        </div>
      </div>

      <div style="border-top: 1px solid #333; margin: 20px 0; padding-top: 20px;">
        <h4 style="color: #d946ef; margin-bottom: 15px; font-size: 14px;"> Payment Information</h4>
        
        <div class="form-group">
          <label>Cardholder Name</label>
          <input type="text" id="fundsCardName" placeholder="John Doe">
        </div>

        <div class="form-group">
          <label>Card Number</label>
          <input type="text" id="fundsCardNumber" placeholder="4111 1111 1111 1111" maxlength="19" oninput="formatCardNumber(this)">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="form-group">
            <label>Expiry (MM/YY)</label>
            <input type="text" id="fundsCardExpiry" placeholder="12/25" maxlength="5" oninput="formatExpiry(this)">
          </div>
          <div class="form-group">
            <label>CVV</label>
            <input type="text" id="fundsCardCVV" placeholder="123" maxlength="4" inputmode="numeric">
          </div>
        </div>
      </div>

      <button class="auth-modal-btn" style="background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%); margin-top: 15px;" onclick="completeFundsTransaction()">Add Funds</button>
      <button class="auth-modal-btn" style="background: transparent; border: 1px solid var(--border); color: var(--text); margin-top: 0.5rem;" onclick="closeAddFundsModal()">Cancel</button>
    </div>
  </div>

  <!-- Maintenance Mode Overlay -->
  <div class="maintenance-mode-overlay" id="maintenanceOverlay">
    <img src="atlas_logo.png" class="atlas-logo" alt="Atlasfn Logo" width="200" height="200" style="filter: drop-shadow(0 0 30px rgba(168, 85, 247, 0.8)); margin-bottom: 2rem;" onerror="handleLogoError(this)">
    <h1><i class="fas fa-tools"></i> MAINTENANCE MODE</h1>
    <p>The site is currently under maintenance. We'll be back soon with improvements!</p>
    <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">Administrators can still access all features.</p>
  </div>


  <!-- Dev Panel -->
  <div class="dev-panel" id="devPanel">
    <div class="dev-panel-content panel-shell panel-shell-dev">
      <div class="panel-header">
        <div class="panel-header-left">
          <img src="atlas_logo.png" class="panel-logo" alt="Atlasfn Logo" onerror="handleLogoError(this)">
          <div>
            <h2 class="panel-title"><i class="fas fa-code"></i> Developer Control Panel</h2>
            <p class="panel-subtitle">Full system access, enforcement, and configuration controls</p>
          </div>
        </div>
        <span class="panel-role panel-role-dev">Developer</span>
      </div>
      <div class="panel-perms">
        <span class="panel-perm"><i class="fas fa-user-shield"></i> Manage roles</span>
        <span class="panel-perm"><i class="fas fa-ban"></i> Ban / IP / API</span>
        <span class="panel-perm"><i class="fas fa-database"></i> Data control</span>
        <span class="panel-perm"><i class="fas fa-tools"></i> Maintenance</span>
      </div>
      <div id="dev-message" class="panel-message"></div>
      
      <div class="dev-sections">
        <!-- Account Management -->
        <div class="dev-section">
          <h3><i class="fas fa-user-slash"></i> Account Management</h3>
          <input type="email" id="dev-target-email" class="dev-input" placeholder="Enter user email">
          <button class="dev-action-btn dev-action-btn-danger" onclick="deleteAccount()">
            <i class="fas fa-trash"></i> Delete Account
          </button>
          <button class="dev-action-btn dev-action-btn-danger" onclick="permanentBan()">
            <i class="fas fa-ban"></i> Permanent Ban
          </button>
        </div>

        <!-- IP Management -->
        <div class="dev-section">
          <h3><i class="fas fa-network-wired"></i> IP Management</h3>
          <input type="text" id="dev-ip-address" class="dev-input" placeholder="Enter IP address (e.g., 192.168.1.1)">
          <button class="dev-action-btn dev-action-btn-danger" onclick="ipBan()">
            <i class="fas fa-ban"></i> IP Ban
          </button>
          <button class="dev-action-btn dev-action-btn-info" onclick="viewIPBans()">
            <i class="fas fa-list"></i> View IP Bans (<span id="ipBanCount">0</span>)
          </button>
          <div id="dev-ip-bans" class="ban-list"></div>
        </div>

        <!-- API Management -->
        <div class="dev-section">
          <h3><i class="fas fa-plug"></i> API Management</h3>
          <input type="email" id="dev-api-email" class="dev-input" placeholder="Enter user email">
          <button class="dev-action-btn dev-action-btn-warning" onclick="apiBan()">
            <i class="fas fa-ban"></i> API Ban User
          </button>
          <button class="dev-action-btn dev-action-btn-info" onclick="viewAPIBans()">
            <i class="fas fa-list"></i> View API Bans (<span id="apiBanCount">0</span>)
          </button>
          <div id="dev-api-bans" class="ban-list"></div>
        </div>

        <!-- Panel Granter -->
        <div class="dev-section">
          <h3><i class="fas fa-unlock-alt"></i> Panel Granter</h3>
          <input type="email" id="dev-grant-email" class="dev-input" placeholder="Enter user email">
          <button class="dev-action-btn dev-action-btn-info" onclick="grantAllPanelsByEmail()">
            <i class="fas fa-unlock"></i> Grant All Panels
          </button>
        </div>

        <!-- User Moderation -->
        <div class="dev-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-user-slash"></i> User Moderation</h3>
          <p style="color: #888; margin-bottom: 1rem;">Timeout durations: 30 min, 1 hr, 5 hr, 24 hr, 48 hr, or 1 week.</p>
          <div class="panel-controls">
            <label for="dev-timeout-duration" style="color: #aaa; font-size: 0.85rem;">Timeout duration</label>
            <select id="dev-timeout-duration" class="panel-select">
              <option value="30">30 min</option>
              <option value="60">1 hr</option>
              <option value="300">5 hr</option>
              <option value="1440">24 hr</option>
              <option value="2880">48 hr</option>
              <option value="10080">1 week</option>
            </select>
          </div>
          <div id="dev-users-container">
            <!-- Users will be loaded here -->
          </div>
        </div>

        <!-- User Permissions Management -->
        <div class="dev-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-user-shield"></i> User Permissions Management</h3>
          <div id="dev-permissions-list" style="margin-top: 1rem; max-height: 400px; overflow-y: auto;">
            <!-- Users will be loaded here -->
          </div>
        </div>

        <!-- Ban Requests -->
        <div class="dev-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-flag"></i> Ban Requests</h3>
          <div id="dev-ban-requests" style="margin-top: 1rem;">
            <!-- Requests will be loaded here -->
          </div>
        </div>

        <!-- User Overview -->
        <div class="dev-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-chart-bar"></i> User Overview</h3>
          <div class="analytics-grid" style="margin-bottom: 1.5rem;">
            <div class="analytics-card">
              <h4 id="overview-total-users">0</h4>
              <p>Total Users</p>
            </div>
            <div class="analytics-card">
              <h4 id="overview-active-users">0</h4>
              <p>Active Users</p>
            </div>
            <div class="analytics-card">
              <h4 id="overview-staff-count">0</h4>
              <p>Staff Members</p>
            </div>
            <div class="analytics-card">
              <h4 id="overview-banned-count">0</h4>
              <p>Banned Users</p>
            </div>
          </div>
          <div id="dev-user-overview" style="max-height: 400px; overflow-y: auto;">
            <!-- User list will be loaded here -->
          </div>
        </div>

        <!-- Maintenance Mode -->
        <div class="dev-section">
          <h3><i class="fas fa-tools"></i> Maintenance Mode</h3>
          <button class="dev-action-btn dev-action-btn-warning" id="maintenanceText" onclick="toggleMaintenance()">
            <i class="fas fa-toggle-off"></i> Enable Maintenance
          </button>
        </div>

        <!-- Database Management -->
        <div class="dev-section">
          <h3><i class="fas fa-database"></i> Database Management</h3>
          <button class="dev-action-btn dev-action-btn-danger" onclick="wipeAllUsers()">
            <i class="fas fa-broom"></i> Wipe All Users
          </button>
          <p style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem;"> This will delete all user accounts (except dev@atlasfn.com)</p>
        </div>

        <!-- Payment Management -->
        <div class="dev-section" style="grid-column: 1 / -1;">
          <h3><i class="fas fa-credit-card"></i> Payment Transaction Management</h3>
          <div style="margin-bottom: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="stat-card" style="border-color: #00d4ff; background: rgba(0, 212, 255, 0.1);">
              <h3 id="totalTransactions" style="color: #00d4ff;">0</h3>
              <p>Total Transactions</p>
            </div>
            <div class="stat-card" style="border-color: #a855f7; background: rgba(168, 85, 247, 0.1);">
              <h3 id="totalRevenue" style="color: #a855f7;">$0.00</h3>
              <p>Total Revenue</p>
            </div>
          </div>
          <button class="dev-action-btn dev-action-btn-info" onclick="refreshPaymentStats()">
            <i class="fas fa-sync"></i> Refresh Stats
          </button>
          <button class="dev-action-btn dev-action-btn-warning" onclick="exportTransactions()">
            <i class="fas fa-download"></i> Export Transactions (CSV)
          </button>
          <div id="dev-transactions-list" style="margin-top: 1rem; max-height: 400px; overflow-y: auto;">
            <!-- Transactions will be loaded here -->
          </div>
        </div>

        <!-- Owner Panel Access -->
        <div class="dev-section">
          <h3><i class="fas fa-crown"></i> Owner Controls</h3>
          <button class="dev-action-btn dev-action-btn-danger" onclick="openOwnerPanel()">
            <i class="fas fa-lock"></i> Open Owner Panel
          </button>
          <button class="dev-action-btn dev-action-btn-info" onclick="enterTestMode()">
            <i class="fas fa-user"></i> Test As Normal User
          </button>
        </div>
      </div>

      <button class="close-staff-btn" onclick="closeDevPanel()">Close Panel</button>
    </div>
  </div>

  <!-- Owner Panel (Dev Only) -->
  <div class="head-staff-panel" id="ownerPanel">
    <div class="head-staff-panel-content panel-shell panel-shell-owner" style="max-width: 1200px;">
      <div class="panel-header">
        <div class="panel-header-left">
          <img src="atlas_logo.png" class="panel-logo" alt="Atlasfn Logo" onerror="handleLogoError(this)">
          <div>
            <h2 class="panel-title"><i class="fas fa-crown"></i> Owner Control Panel</h2>
            <p class="panel-subtitle">Executive dashboard, payouts, and earnings management</p>
          </div>
        </div>
        <span class="panel-role panel-role-owner">Owner</span>
      </div>
      <div class="panel-perms">
        <span class="panel-perm"><i class="fas fa-chart-line"></i> Revenue analytics</span>
        <span class="panel-perm"><i class="fas fa-money-bill"></i> Payout management</span>
        <span class="panel-perm"><i class="fas fa-credit-card"></i> Payment methods</span>
        <span class="panel-perm"><i class="fas fa-eye"></i> Full visibility</span>
      </div>
      <div id="owner-message" class="panel-message"></div>

      <!-- Revenue Dashboard -->
      <div style="margin-bottom: 2rem;">
        <h3 style="color: #ff6b00; margin-bottom: 1rem;"><i class="fas fa-chart-bar"></i> Revenue Dashboard</h3>
        <div class="staff-stats">
          <div class="stat-card" style="border-color: #ff6b00; background: rgba(255, 107, 0, 0.1);">
            <h3 id="owner-total-revenue" style="color: #ff6b00;">$0.00</h3>
            <p>Total Revenue</p>
          </div>
          <div class="stat-card" style="border-color: #ff6b00; background: rgba(255, 107, 0, 0.1);">
            <h3 id="owner-total-payouts" style="color: #ff6b00;">$0.00</h3>
            <p>Total Payouts</p>
          </div>
          <div class="stat-card" style="border-color: #ff6b00; background: rgba(255, 107, 0, 0.1);">
            <h3 id="owner-pending-payout" style="color: #ff6b00;">$0.00</h3>
            <p>Pending Payout</p>
          </div>
          <div class="stat-card" style="border-color: #ff6b00; background: rgba(255, 107, 0, 0.1);">
            <h3 id="owner-total-transactions" style="color: #ff6b00;">0</h3>
            <p>Total Transactions</p>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="owner-tabs" style="margin-bottom: 2rem; display: flex; gap: 0.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
        <button class="owner-tab-btn active" onclick="switchOwnerTab('overview')" style="padding: 0.5rem 1rem; border: none; background: transparent; color: var(--text); border-bottom: 2px solid #ff6b00; cursor: pointer; font-weight: 600;">
          <i class="fas fa-chart-pie"></i> Overview
        </button>
        <button class="owner-tab-btn" onclick="switchOwnerTab('payouts')" style="padding: 0.5rem 1rem; border: none; background: transparent; color: #888; cursor: pointer; font-weight: 600;">
          <i class="fas fa-money-bill"></i> Payouts
        </button>
        <button class="owner-tab-btn" onclick="switchOwnerTab('users')" style="padding: 0.5rem 1rem; border: none; background: transparent; color: #888; cursor: pointer; font-weight: 600;">
          <i class="fas fa-users"></i> Users
        </button>
      </div>

      <!-- Overview Tab -->
      <div id="owner-overview-tab" class="owner-tab-content active">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-pie"></i> Overview</h3>
        <div class="users-list">
          <h4>Recent Transactions</h4>
          <div id="owner-transactions-list" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
            <p style="color: #888; text-align: center;">No transactions yet</p>
          </div>
        </div>
      </div>

      <!-- Payouts Tab -->
      <div id="owner-payouts-tab" class="owner-tab-content" style="display: none;">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-money-bill"></i> Payout Management</h3>
        
        <div style="background: rgba(255, 107, 0, 0.05); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
          <h4 style="margin-bottom: 0.5rem; color: #ff6b00;">Available Balance</h4>
          <div style="font-size: 2.5rem; font-weight: 700; color: #ff6b00; margin-bottom: 1rem;" id="available-balance">$0.00</div>
          <button class="dev-action-btn" style="background: #ff6b00; color: #000;" onclick="openWithdrawModal()">
            <i class="fas fa-arrow-down"></i> Withdraw Earnings
          </button>
        </div>

        <h4 style="margin-bottom: 1rem;">Payout History</h4>
        <div id="owner-payout-history" style="max-height: 400px; overflow-y: auto;">
          <p style="color: #888; text-align: center;">No payouts yet</p>
        </div>
      </div>

      <!-- Payment Methods Tab (Hidden) -->
      <div id="owner-payment-methods-tab" class="owner-tab-content" style="display: none;">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-credit-card"></i> Payment Methods</h3>
        
        <div id="owner-cards-list" style="margin-bottom: 2rem;">
          <!-- Cards will not be displayed to owners for security -->
        </div>
      </div>

      <!-- Users Tab -->
      <div id="owner-users-tab" class="owner-tab-content" style="display: none;">
        <h3 style="margin-bottom: 1rem;"><i class="fas fa-users"></i> User Management</h3>
        <div id="owner-users-container" style="margin-top: 1rem;">
          <!-- Users will be dynamically loaded here -->
        </div>
      </div>

      <button class="close-staff-btn" onclick="closeOwnerPanel()">Close Panel</button>
    </div>
  </div>

  <!-- Add Payment Method Modal -->
  <div class="modern-modal" id="addCardModal" style="display: none;">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <h2><i class="fas fa-credit-card"></i> Add Payment Method</h2>
        <button class="modern-modal-close" onclick="closeAddCardModal()"></button>
      </div>
      <div class="modern-modal-body">
        <form id="addCardForm" onsubmit="savePaymentMethod(event)" style="display: grid; gap: 1rem;">
          <div class="form-group">
            <label>Payment Method Type</label>
            <select id="cardType" required style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
              <option value="credit_card">Credit/Debit Card</option>
              <option value="bank_account">Bank Account</option>
              <option value="paypal">PayPal</option>
            </select>
          </div>

          <div id="credit-card-fields">
            <div class="form-group">
              <label>Cardholder Full Name</label>
              <input type="text" id="cardName" placeholder="John Doe" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
            </div>
            <div class="form-group">
              <label>Card Number</label>
              <input type="text" id="cardNumber" placeholder="   1234" maxlength="19" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);" oninput="formatCardNumber(this)">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label>Expiry Date (MM/YY)</label>
                <input type="text" id="cardExpiry" placeholder="12/25" maxlength="5" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);" oninput="formatExpiry(this)">
              </div>
              <div class="form-group">
                <label>CVV</label>
                <input type="text" id="cardCVV" placeholder="123" maxlength="4" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
              </div>
            </div>
          </div>

          <div id="bank-account-fields" style="display: none;">
            <div class="form-group">
              <label>Account Holder Name</label>
              <input type="text" id="bankName" placeholder="John Doe" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
            </div>
            <div class="form-group">
              <label>Routing Number</label>
              <input type="text" id="bankRouting" placeholder="123456789" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
            </div>
            <div class="form-group">
              <label>Account Number</label>
              <input type="text" id="bankAccount" placeholder=" 1234" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
            </div>
          </div>

          <div id="paypal-fields" style="display: none;">
            <div class="form-group">
              <label>PayPal Email</label>
              <input type="email" id="paypalEmail" placeholder="your@paypal.com" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
            </div>
          </div>

          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="dev-action-btn" style="background: #a855f7; flex: 1;">
              <i class="fas fa-save"></i> Save Payment Method
            </button>
            <button type="button" class="dev-action-btn" style="background: transparent; border: 1px solid var(--border); color: var(--text); flex: 1;" onclick="closeAddCardModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div class="modern-modal" id="withdrawModal" style="display: none;">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <h2><i class="fas fa-arrow-down"></i> Withdraw Earnings</h2>
        <button class="modern-modal-close" onclick="closeWithdrawModal()"></button>
      </div>
      <div class="modern-modal-body">
        <form id="withdrawForm" onsubmit="processWithdrawal(event)">
          <div style="background: rgba(255, 107, 0, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
            <p style="color: #888; font-size: 0.9rem;">Available Balance</p>
            <h3 id="withdraw-available" style="color: #ff6b00; font-size: 2rem;">$0.00</h3>
          </div>

          <div class="form-group">
            <label>Select Payment Method</label>
            <select id="withdrawMethod" required style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
              <option value="">-- Choose a payment method --</option>
            </select>
          </div>

          <div class="form-group">
            <label>Withdrawal Amount (USD)</label>
            <input type="number" id="withdrawAmount" placeholder="Amount to withdraw" min="10" step="0.01" required style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
            <p style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;">Minimum withdrawal: $10.00 | Fee: 2.5% + $0.30</p>
          </div>

          <div class="form-group">
            <label for="withdrawNotes">Notes (optional)</label>
            <textarea id="withdrawNotes" placeholder="Add any notes..." rows="3" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);"></textarea>
          </div>

          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="dev-action-btn" style="background: #ff6b00; color: #000; flex: 1;">
              <i class="fas fa-check"></i> Confirm Withdrawal
            </button>
            <button type="button" class="dev-action-btn" style="background: transparent; border: 1px solid var(--border); color: var(--text); flex: 1;" onclick="closeWithdrawModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Head Staff Panel -->
  <div class="head-staff-panel" id="headStaffPanel">
    <div class="head-staff-panel-content panel-shell panel-shell-head">
      <div class="panel-header">
        <div class="panel-header-left">
          <img src="atlas_logo.png" class="panel-logo" alt="Atlasfn Logo" onerror="handleLogoError(this)">
          <div>
            <h2 class="panel-title"><i class="fas fa-crown"></i> Head Staff Control Panel</h2>
            <p class="panel-subtitle">Moderation, escalations, and enforcement tools</p>
          </div>
        </div>
        <span class="panel-role panel-role-head">Head Staff</span>
      </div>
      <div class="panel-perms">
        <span class="panel-perm"><i class="fas fa-user-check"></i> Promote staff</span>
        <span class="panel-perm"><i class="fas fa-ban"></i> Blacklist users</span>
        <span class="panel-perm"><i class="fas fa-plug"></i> API bans</span>
        <span class="panel-perm"><i class="fas fa-clock"></i> Timeouts</span>
      </div>
      <div id="head-staff-message" class="panel-message"></div>
      
      <div class="staff-stats">
        <div class="stat-card">
          <h3 id="head-stat-total-users">0</h3>
          <p>Total Users</p>
        </div>
        <div class="stat-card">
          <h3 id="head-stat-active-users">0</h3>
          <p>Active Users</p>
        </div>
        <div class="stat-card">
          <h3 id="head-stat-blacklisted">0</h3>
          <p>Blacklisted</p>
        </div>
        <div class="stat-card">
          <h3 id="head-stat-timed-out">0</h3>
          <p>Timed Out</p>
        </div>
      </div>

      <div class="panel-block">
        <h3><i class="fas fa-plug"></i> API Moderation</h3>
        <input type="email" id="head-api-email" class="panel-input" placeholder="Enter user email">
        <button class="action-btn action-btn-blacklist" onclick="apiBanFromHead()">
          <i class="fas fa-ban"></i> API Ban User
        </button>
        <button class="action-btn action-btn-restore" onclick="viewAPIBansFromHead()">
          <i class="fas fa-list"></i> View API Bans
        </button>
        <div id="head-api-bans" class="ban-list"></div>
      </div>

      <div class="users-list">
        <h3><i class="fas fa-users"></i> User Management</h3>
        <div id="head-users-container">
          <!-- Users will be dynamically loaded here -->
        </div>
      </div>

      <button class="close-staff-btn" onclick="closeHeadStaffPanel()">Close Panel</button>
    </div>
  </div>

  <!-- Staff Panel -->
  <div class="staff-panel" id="staffPanel">
    <div class="staff-panel-content panel-shell panel-shell-staff">
      <div class="panel-header">
        <div class="panel-header-left">
          <img src="atlas_logo.png" class="panel-logo" alt="Atlasfn Logo" onerror="handleLogoError(this)">
          <div>
            <h2 class="panel-title"><i class="fas fa-shield-alt"></i> Staff Control Panel</h2>
            <p class="panel-subtitle">Daily moderation tools and user safety controls</p>
          </div>
        </div>
        <span class="panel-role panel-role-staff">Staff</span>
      </div>
      <div class="panel-perms">
        <span class="panel-perm"><i class="fas fa-clock"></i> Timeout users</span>
        <span class="panel-perm"><i class="fas fa-flag"></i> Ban requests</span>
        <span class="panel-perm"><i class="fas fa-users"></i> User overview</span>
      </div>
      <div id="staff-message" class="panel-message"></div>
      
      <div class="staff-stats">
        <div class="stat-card">
          <h3 id="stat-total-users">0</h3>
          <p>Total Users</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-active-users">0</h3>
          <p>Active Users</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-blacklisted">0</h3>
          <p>Blacklisted</p>
        </div>
        <div class="stat-card">
          <h3 id="stat-timed-out">0</h3>
          <p>Timed Out</p>
        </div>
      </div>

      <div class="users-list">
        <h3><i class="fas fa-users"></i> User Management</h3>
        <div class="panel-controls">
          <label for="staff-timeout-duration" style="color: #aaa; font-size: 0.85rem;">Timeout duration</label>
          <select id="staff-timeout-duration" class="panel-select">
            <option value="30">30 min</option>
            <option value="60">1 hr</option>
            <option value="300">5 hr</option>
            <option value="1440">24 hr</option>
            <option value="2880">48 hr</option>
            <option value="10080">1 week</option>
          </select>
        </div>
        <div id="users-container">
          <!-- Users will be dynamically loaded here -->
        </div>
      </div>

      <button class="close-staff-btn" onclick="closeStaffPanel()">Close Panel</button>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div class="product-detail-modal" id="productDetailModal">
    <div class="product-detail-content">
      <div class="product-detail-close" onclick="closeProductDetail()"></div>
      
      <div class="product-detail-header">
        <div class="product-detail-image" id="modalProductImage">
          <i class="fas fa-key"></i>
        </div>
        
        <div class="product-detail-info">
          <span class="product-detail-badge" id="modalProductBadge">In Stock</span>
          <h2 class="product-detail-title" id="modalProductTitle">Access Key</h2>
          <div class="product-detail-price" id="modalProductPrice">$3.99</div>
          <p class="product-detail-desc" id="modalProductDesc">Get instant access to all Atlas FN features.</p>
        </div>
      </div>

      <div class="product-detail-body">
        <div class="product-variants">
          <h4>Select Variant</h4>
          <div class="variant-grid" id="variantGrid">
            <!-- Variants will be inserted here dynamically -->
          </div>
        </div>

        <div class="product-quantity">
          <h4>Quantity</h4>
          <div class="quantity-controls">
            <button class="quantity-btn" onclick="decreaseQuantity()"></button>
            <span class="quantity-display" id="quantityDisplay">1</span>
            <button class="quantity-btn" onclick="increaseQuantity()">+</button>
          </div>
        </div>

        <div class="product-actions">
          <button class="btn-add-cart" onclick="addToCart()">
            <i class="fas fa-shopping-cart"></i> Add to Cart
          </button>
          <button class="btn-buy-now" onclick="buyNow()">
            <i class="fas fa-bolt"></i> Buy Now
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Redeem Key Modal -->
  <div class="modern-modal" id="redeemModal">
    <div class="modern-modal-content" style="max-width: 450px;">
      <div class="modern-modal-header">
        <h2><i class="fas fa-ticket-alt"></i> Redeem Panel Key</h2>
        <button class="modern-modal-close" onclick="closeRedeemModal()"></button>
      </div>
      <div class="modern-modal-body">
        <p style="color: #cbd5f5; margin-bottom: 1.5rem;">Enter your panel access key to unlock your permissions.</p>
        <div class="form-group">
          <label>Access Key</label>
          <input type="text" id="redeemKey" placeholder="ATL_XXXXX_XXXXX" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text); font-family: monospace;">
        </div>
        <div id="redeemError" style="color: #ff6b6b; font-size: 0.9rem; margin-top: 0.5rem; display: none;"></div>
        <button onclick="redeemPanelKey()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #d946ef); border: none; border-radius: 8px; color: #fff; font-weight: 600; margin-top: 1.5rem; cursor: pointer;">
          <i class="fas fa-unlock"></i> Redeem Key
        </button>
        <button onclick="openOwnerAccessPrompt()" style="width: 100%; padding: 0.8rem; background: transparent; border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 0.85rem; margin-top: 0.5rem; cursor: pointer;">
          <i class="fas fa-crown"></i> Owner? Click here
        </button>
      </div>
    </div>
  </div>

  <!-- Redeem Success Modal -->
  <div class="modern-modal" id="redeemSuccessModal">
    <div class="modern-modal-content" style="max-width: 450px;">
      <div class="modern-modal-header">
        <h2><i class="fas fa-check-circle"></i> Redeemed Successfully</h2>
        <button class="modern-modal-close" onclick="closeRedeemSuccessModal()"></button>
      </div>
      <div class="modern-modal-body">
        <p style="color: #cbd5f5; margin-bottom: 1.5rem;">Your key has been redeemed. Access granted to <span id="redeemSuccessName" style="color: var(--accent);"></span>.</p>
        <button onclick="openRedeemPanel()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #d946ef); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer;">
          <i class="fas fa-external-link-alt"></i> Open Panel
        </button>
        <button onclick="closeRedeemSuccessModal()" style="width: 100%; padding: 0.8rem; background: transparent; border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 0.85rem; margin-top: 0.5rem; cursor: pointer;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Owner Access Modal -->
  <div class="modern-modal" id="accessModal">
    <div class="modern-modal-content" style="max-width: 450px;">
      <div class="modern-modal-header">
        <h2><i class="fas fa-crown"></i> Owner Verification</h2>
        <button class="modern-modal-close" onclick="closeAccessModal()"></button>
      </div>
      <div class="modern-modal-body">
        <p style="color: #cbd5f5; margin-bottom: 1.5rem;">Enter the owner master password.</p>
        <div class="form-group">
          <label>Master Password</label>
          <input type="password" id="accessPassword" placeholder="Enter master password" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
        </div>
        <div id="accessError" style="color: #ff6b6b; font-size: 0.9rem; margin-top: 0.5rem; display: none;"></div>
        <button onclick="verifyOwnerPassword()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #d946ef); border: none; border-radius: 8px; color: #fff; font-weight: 600; margin-top: 1.5rem; cursor: pointer;">
          <i class="fas fa-lock-open"></i> Unlock Owner Panel
        </button>
      </div>
    </div>
  </div>

  <!-- Owner Panel Modal -->
  <div class="modern-modal" id="ownerPanelModal">
    <div class="modern-modal-content" style="max-width: 600px;">
      <div class="modern-modal-header">
        <h2><i class="fas fa-crown"></i> Owner Control Panel</h2>
        <button class="modern-modal-close" onclick="closeOwnerPanel()"></button>
      </div>
      <div class="modern-modal-body">
        <div class="modern-modal-tabs" style="margin-bottom: 2rem;">
          <button class="modal-tab active" onclick="switchOwnerTab('generate')">Generate Keys</button>
          <button class="modal-tab" onclick="switchOwnerTab('manage')">Manage Keys</button>
        </div>

        <!-- Generate Tab -->
        <div id="generateTab" class="support-tab-content active">
          <h3 style="margin-bottom: 1rem; color: var(--accent);">Generate Access Key</h3>
          <div class="form-group">
            <label>Panel Name</label>
            <input type="text" id="panelName" placeholder="e.g., Developer Panel, Admin Panel" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
          </div>
          <div class="form-group">
            <label>Key Type</label>
            <select id="keyType" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
              <option value="admin">Admin (Full Access)</option>
              <option value="moderator">Moderator (Limited Access)</option>
              <option value="viewer">Viewer (Read-Only)</option>
              <option value="custom">Custom Permission</option>
            </select>
          </div>
          <button onclick="generateKey()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #d946ef); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer; margin-top: 1rem;">
            <i class="fas fa-plus"></i> Generate Key
          </button>
          <div id="generatedKeyDisplay" style="margin-top: 1.5rem; padding: 1rem; background: #0a0a0c; border: 1px solid #a855f7; border-radius: 8px; display: none;">
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 0.5rem;">Generated Key:</p>
            <div style="display: flex; gap: 0.5rem;">
              <input type="text" id="generatedKeyValue" readonly style="flex: 1; padding: 0.8rem; background: #16161a; border: 1px solid var(--border); border-radius: 6px; color: var(--accent); font-family: monospace; font-size: 0.85rem;">
              <button onclick="copyToClipboard('generatedKeyValue')" style="padding: 0.8rem 1rem; background: #a855f7; border: none; border-radius: 6px; color: #fff; cursor: pointer;">
                <i class="fas fa-copy"></i> Copy
              </button>
            </div>
          </div>
        </div>

        <!-- Manage Tab -->
        <div id="manageTab" class="support-tab-content">
          <h3 style="margin-bottom: 1rem; color: var(--accent);">Active Keys</h3>
          <div id="keysList" style="max-height: 400px; overflow-y: auto;">
            <p style="text-align: center; color: #888; padding: 2rem;">No keys generated yet.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order History Modal -->
  <div class="modern-modal" id="orderHistoryModal">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <h2><i class="fas fa-shopping-bag"></i> Order History</h2>
        <button class="modern-modal-close" onclick="closeOrderHistory()"></button>
      </div>
      <div class="modern-modal-body" id="orderHistoryContent">
        <p style="text-align: center; color: #888; padding: 2rem;">No orders yet. Make your first purchase!</p>
      </div>
    </div>
  </div>

  <!-- Support/Tickets Modal -->
  <div class="modern-modal" id="supportModal">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <h2><i class="fas fa-headset"></i> Support Center</h2>
        <button class="modern-modal-close" onclick="closeSupport()"></button>
      </div>
      <div class="modern-modal-tabs">
        <button class="modal-tab active" onclick="switchSupportTab('tickets')">My Tickets</button>
        <button class="modal-tab" onclick="switchSupportTab('new')">Create Ticket</button>
        <button class="modal-tab" id="allTicketsTab" onclick="switchSupportTab('all')" style="display: none;">All Tickets <span id="staffTicketBadge" style="background: #ff6b6b; color: #fff; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.75rem; margin-left: 0.5rem; display: none;"></span></button>
      </div>
      <div class="modern-modal-body">
        <div id="ticketsTab" class="support-tab-content active">
          <div id="ticketsList">
            <p style="text-align: center; color: #888; padding: 2rem;">No tickets yet.</p>
          </div>
        </div>
        <div id="newTicketTab" class="support-tab-content">
          <form id="newTicketForm" onsubmit="createTicket(event)">
            <div class="form-group">
              <label>Subject</label>
              <input type="text" id="ticketSubject" placeholder="Brief description of your issue" required>
            </div>
            <div class="form-group">
              <label>Priority</label>
              <select id="ticketPriority" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="form-group">
              <label>Message</label>
              <textarea id="ticketMessage" rows="5" placeholder="Describe your issue in detail..." required style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text); resize: vertical;"></textarea>
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; padding: 1rem; border: none; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #a855f7); color: #000; font-weight: 700; cursor: pointer;">
              <i class="fas fa-paper-plane"></i> Submit Ticket
            </button>
          </form>
        </div>
        <div id="allTicketsTab" class="support-tab-content">
          <div id="allTicketsList">
            <p style="text-align: center; color: #888; padding: 2rem;">No tickets yet.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket Chat Modal -->
  <div class="modern-modal" id="ticketChatModal">
    <div class="modern-modal-content" style="max-width: 700px;">
      <div class="modern-modal-header">
        <h2><i class="fas fa-comments"></i> Ticket #<span id="chatTicketId"></span></h2>
        <button class="modern-modal-close" onclick="closeTicketChat()"></button>
      </div>
      <div class="modern-modal-body">
        <div style="background: #0a0a0c; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 0.5rem 0; color: var(--accent);" id="chatTicketSubject"></h3>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span class="ticket-status" id="chatTicketStatus"></span>
            <span class="ticket-priority" id="chatTicketPriority"></span>
          </div>
          <small style="color: #888;" id="chatTicketDate"></small>
        </div>
        <div id="ticketMessagesContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; background: #16161a; border-radius: 8px;">
          <!-- Messages will be loaded here -->
        </div>
        <form id="ticketReplyForm" onsubmit="sendTicketMessage(event)" style="display: flex; gap: 0.5rem;">
          <input type="text" id="ticketReplyInput" placeholder="Type your message..." required style="flex: 1; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);">
          <button type="submit" style="padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #a855f7, #d946ef); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer;">
            <i class="fas fa-paper-plane"></i> Send
          </button>
        </form>
        <div id="ticketCloseSection" style="margin-top: 1rem; display: none;">
          <button onclick="closeTicketByStaff()" style="width: 100%; padding: 0.8rem; background: #ff6b6b; border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer;">
            <i class="fas fa-times-circle"></i> Close Ticket
          </button>
        </div>
      </div>
    </div>
  </div>

  <section class="hero">
    <h1>Access Keys.<br>Fast, Secure Checkout.</h1>
    <p>Choose your access duration and complete checkout securely in minutes.</p>
  </section>

  <section class="payment-section" id="purchase">
    <div class="container">
      <h2 style="font-size: 2.5rem; margin-bottom: 1rem; text-align: center;">Choose Your Access</h2>
      <p style="text-align: center; color: #a06aff; margin-bottom: 2.5rem;">Select your preferred duration and checkout securely</p>
      
      <div class="payment-container">
        <div class="product-card" onclick="goToProductCheckout('test')" style="cursor: pointer;">
          <div class="product-card-badge">Test</div>
          <div class="product-card-image"><i class="fas fa-flask"></i></div>
          <div class="product-card-title">Test Purchase</div>
          <div class="product-card-price">$0.50</div>
          <div class="product-card-desc">Test the payment system</div>
          <button class="btn-pay" type="button">Select Plan</button>
        </div>
        
        <div class="product-card" onclick="goToProductCheckout('1_day')" style="cursor: pointer;">
          <div class="product-card-badge">In Stock</div>
          <div class="product-card-image"><i class="fas fa-key"></i></div>
          <div class="product-card-title">1 Day Access</div>
          <div class="product-card-price">$3.99</div>
          <div class="product-card-desc">24-hour access to all features</div>
          <button class="btn-pay" type="button">Select Plan</button>
        </div>
        
        <div class="product-card" onclick="goToProductCheckout('1_week')" style="cursor: pointer;">
          <div class="product-card-badge">In Stock</div>
          <div class="product-card-image"><i class="fas fa-key"></i></div>
          <div class="product-card-title">1 Week Access</div>
          <div class="product-card-price">$9.99</div>
          <div class="product-card-desc">7 days of full access</div>
          <button class="btn-pay" type="button">Select Plan</button>
        </div>
        
        <div class="product-card" onclick="goToProductCheckout('1_month')" style="cursor: pointer;">
          <div class="product-card-badge">In Stock</div>
          <div class="product-card-image"><i class="fas fa-key"></i></div>
          <div class="product-card-title">1 Month Access</div>
          <div class="product-card-price">$19.99</div>
          <div class="product-card-desc">30 days with premium support</div>
          <button class="btn-pay" type="button">Select Plan</button>
        </div>
        
        <div class="product-card" onclick="goToProductCheckout('3_months')" style="cursor: pointer;">
          <div class="product-card-badge">Popular</div>
          <div class="product-card-image"><i class="fas fa-crown"></i></div>
          <div class="product-card-title">3 Months Access</div>
          <div class="product-card-price">$39.99</div>
          <div class="product-card-desc">90 days of premium access</div>
          <button class="btn-pay" type="button">Select Plan</button>
        </div>
        
        <div class="product-card" onclick="goToProductCheckout('lifetime')" style="cursor: pointer;">
          <div class="product-card-badge">Best Value</div>
          <div class="product-card-image"><i class="fas fa-star"></i></div>
          <div class="product-card-title">Lifetime Access</div>
          <div class="product-card-price">$99.99</div>
          <div class="product-card-desc">Unlimited access forever</div>
          <button class="btn-pay" type="button">Select Plan</button>
        </div>
      </div>
    </div>
  </section>

  <section class="faq-section" id="faq">
    <div class="container">
      <h2>FAQ</h2>
      <p class="section-intro">Common store, account, and access questions.</p>
      <div class="faq-grid">
        <div class="faq-item">
          <h3>Do I need to create an account to purchase?</h3>
          <p>No! You can checkout as a guest. Creating an account is optional and provides benefits like order history and faster future purchases.</p>
        </div>
        <div class="faq-item">
          <h3>My payment failed. What should I do?</h3>
          <p>Verify your card details, billing address, and available balance. Try again or use a different card.</p>
        </div>
        <div class="faq-item">
          <h3>I was charged but didnt receive an access key.</h3>
          <p>Check your email inbox and spam folder. If you still dont see it, contact support with your receipt email.</p>
        </div>
        <div class="faq-item">
          <h3>My access key says invalid.</h3>
          <p>Copy and paste the key exactly and avoid extra spaces. If it still fails, reset your key from your account page.</p>
        </div>
        <div class="faq-item">
          <h3>Can I change the email tied to my key?</h3>
          <p>Yes. Update your account email first, then request a key reissue from the store page.</p>
        </div>
        <div class="faq-item">
          <h3>I cant log in.</h3>
          <p>Confirm your email and password. If you forgot your password, use the reset flow or contact support.</p>
        </div>
        <div class="faq-item">
          <h3>Why am I not receiving verification emails?</h3>
          <p>Check spam and promotions folders, and make sure your email provider isnt blocking automated mail.</p>
        </div>
        <div class="faq-item">
          <h3>Can I upgrade my access duration?</h3>
          <p>Yes. Purchase the new duration and the system will extend your access time automatically.</p>
        </div>
        <div class="faq-item">
          <h3>Is my payment information stored here?</h3>
          <p>No. Payments are processed securely by Stripe. We never store your card details.</p>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-links">
      <a href="#">Terms of Service</a>
      <a href="#">Privacy Policy</a>
      <a href="#">Contact</a>
      <a href="#">API Docs</a>
      <a href="#">Status</a>
    </div>
    <p style="color:#555; font-size:0.9rem;">&copy; 2026 Atlasfn. All rights reserved. Secure payments powered by Stripe.</p>
  </footer>

  <div id="global-toast"></div>
  <div id="ban-banner" class="ban-banner"></div>
  <div id="testModeBanner" class="test-mode-banner">
    <span>Test mode active (normal user)</span>
    <button type="button" onclick="exitTestMode()">Exit Test Mode</button>
  </div>
  <div id="privacyOverlay" class="privacy-overlay">
    <div class="privacy-overlay-content">
      <h3>Protected View</h3>
      <p id="privacyMessage">This page is protected. Please close developer tools and refresh.</p>
    </div>
  </div>

  <div class="action-modal" id="actionModal">
    <div class="action-modal-content">
      <h3 id="actionModalTitle">Confirm Action</h3>
      <p id="actionModalMessage"></p>
      <div class="action-modal-actions">
        <button class="modal-cancel" type="button" onclick="closeActionModal()">Cancel</button>
        <button class="modal-confirm" type="button" id="actionModalConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <div class="action-modal" id="banRequestModal">
    <div class="action-modal-content">
      <h3 id="banRequestTitle">Ban Request</h3>
      <p id="banRequestTarget"></p>
      <div class="form-group" style="margin-top: 1rem;">
        <label for="banRequestReason">Reason (required)</label>
        <textarea id="banRequestReason" rows="4" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text); font-size: 0.95rem; resize: vertical;" placeholder="Describe what the user did..."></textarea>
      </div>
      <div class="action-modal-actions">
        <button class="modal-cancel" type="button" onclick="closeBanRequestModal()">Cancel</button>
        <button class="modal-confirm warning" type="button" onclick="submitBanRequest()">Send Request</button>
      </div>
    </div>
  </div>

  <!-- Custom Payment System -->
  <div id="customPaymentModal" class="modern-modal" style="display: none;">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <h2><i class="fas fa-credit-card"></i> Credit Card Payment</h2>
        <button class="modern-modal-close" onclick="closePaymentMethodModal()"></button>
      </div>
      <div class="modern-modal-body">
        <div id="paymentMethodsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          <div class="payment-method-card" onclick="selectPaymentMethod('credit_card')">
            <i class="fas fa-credit-card"></i>
            <p>Credit/Debit Card</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>

  <script>
    // ====== PRODUCTS DISPLAY ======
    function goToProductCheckout(productKey) {
      localStorage.setItem('selectedProduct', productKey);
      window.location.href = 'purchase.html?product=' + productKey;
    }

    console.log(' Atlas FN loaded');

    // ====== STRIPE CONFIGURATION ======
    // IMPORTANT: Paste your Stripe keys from https://dashboard.stripe.com/apikeys
    const STRIPE_CONFIG = {
      // Your Stripe Publishable Key (starts with pk_test_ or pk_live_)
      publishableKey: 'pk_live_51T2ZQBCOhVW1Fv0S9OFkNFyPbHp3qZSifECjfOyNVCV1EAxAxRe2BxYx62gu4k08AWvf6Jos2UbHEZS2AXbbSlox00kVF5dmSr',
      
      //  SECURITY WARNING: NEVER PUT YOUR SECRET KEY HERE! 
      // Secret keys (sk_live_...) must ONLY be used on a secure backend server
      // Putting them in HTML/JavaScript exposes them to anyone who views your site
      // For real payments, you MUST create a backend API endpoint
      secretKey: '', // DO NOT PUT SECRET KEY HERE - USE BACKEND SERVER ONLY
      
      isTestMode: false // Set to true for testing with test keys
    };

    let stripe = null;

    function initializeStripe() {
      if (STRIPE_CONFIG.publishableKey && !STRIPE_CONFIG.publishableKey.includes('YOUR_PUBLISHABLE')) {
        try {
          stripe = Stripe(STRIPE_CONFIG.publishableKey);
          console.log(' Stripe initialized - Ready for payments');
          return true;
        } catch (error) {
          console.error(' Stripe error:', error);
          return false;
        }
      } else {
        console.warn(' Stripe keys not configured yet. Paste your keys in STRIPE_CONFIG.');
        return false;
      }
    }
  </script>

  <script>
    // ====== CUSTOM PAYMENT SYSTEM ======
    
    // Check if user is developer
    function isDevUser() {
      const flags = getCurrentUserFlags();
      return !!flags.isDev;
    }
    
    // Update test purchase option visibility
    function updateTestOptionVisibility() {
      const accessSelect = document.getElementById('access-duration');
      if (!accessSelect) return;
      
      const isDev = isDevUser();
      let testOption = accessSelect.querySelector('option[value="test"]');
      
      if (isDev) {
        // Add test option if it doesn't exist
        if (!testOption) {
          testOption = document.createElement('option');
          testOption.value = 'test';
          testOption.textContent = 'Test Purchase (50) - $0.50';
          accessSelect.insertBefore(testOption, accessSelect.firstChild);
        }
        testOption.style.display = 'block';
      } else {
        // Remove test option if it exists
        if (testOption) {
          testOption.remove();
        }
      }
      
      console.log(' Test option updated - Dev:', isDev, 'Visible:', isDev);
    }
    
    // ====== CUSTOM PAYMENT SYSTEM ======
    
    // Payment Manager Object
    const paymentSystem = {
      transactions: [],
      orders: [],
      selectedMethod: null,
      pendingPayment: null,
      
      // Initialize custom payment system
      init() {
        this.loadTransactions();
        this.loadOrders();
        setupPaymentUI();
      },
      
      // Load transactions from localStorage
      loadTransactions() {
        const stored = localStorage.getItem('atlasfn_transactions');
        this.transactions = stored ? JSON.parse(stored) : [];
      },
      
      // Load orders from localStorage
      loadOrders() {
        const stored = localStorage.getItem('atlasfn_orders');
        this.orders = stored ? JSON.parse(stored) : [];
      },
      
      // Save transactions to localStorage
      saveTransactions() {
        localStorage.setItem('atlasfn_transactions', JSON.stringify(this.transactions));
      },
      
      // Save orders to localStorage
      saveOrders() {
        localStorage.setItem('atlasfn_orders', JSON.stringify(this.orders));
      },
      
      // Generate unique transaction ID
      generateTransactionId() {
        return 'TXN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9).toUpperCase();
      },
      
      // Generate unique order ID
      generateOrderId() {
        return 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9).toUpperCase();
      },
      
      // Process payment - REAL CHARGE
      async processPayment(paymentData) {
        try {
          // Validate payment data
          if (!paymentData.amount || paymentData.amount < 0.50) {
            throw new Error('Minimum payment amount is $0.50');
          }
          
          if (!paymentData.email) {
            throw new Error('Email is required');
          }
          
          if (!paymentData.method) {
            throw new Error('Payment method is required');
          }
          
          // Check if user has sufficient balance
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const userIndex = users.findIndex(u => u.email === paymentData.email);
          
          if (userIndex === -1) {
            throw new Error('User account not found');
          }
          
          const user = users[userIndex];
          const userBalance = user.balance || 0;
          
          if (userBalance < paymentData.amount) {
            throw new Error(`Insufficient balance. Your balance: $${userBalance.toFixed(2)}, Amount needed: $${paymentData.amount.toFixed(2)}`);
          }
          
          // Create transaction
          const transaction = {
            id: this.generateTransactionId(),
            orderId: this.generateOrderId(),
            timestamp: new Date().toISOString(),
            amount: paymentData.amount,
            currency: paymentData.currency || 'USD',
            method: paymentData.method,
            status: 'processing',
            isTest: false,
            isReal: true,
            customer: {
              email: paymentData.email,
              name: paymentData.name,
              phone: paymentData.phone,
              address: paymentData.address
            },
            product: paymentData.product,
            metadata: paymentData.metadata || {}
          };
          
          // Process payment - DEDUCT FROM USER BALANCE
          const result = await this.processRealPayment(transaction, user, userIndex, users);
          
          if (result.success) {
            transaction.status = 'completed';
            transaction.processedAt = new Date().toISOString();
            transaction.receipt = result.receipt;
            
            // Create order with access key
            const order = {
              id: transaction.orderId,
              transactionId: transaction.id,
              timestamp: transaction.timestamp,
              customer: transaction.customer,
              product: transaction.product,
              amount: transaction.amount,
              status: 'fulfilled',
              accessKey: this.generateAccessKey()
            };
            
            // SAVE REAL TRANSACTION
            this.transactions.push(transaction);
            this.orders.push(order);
            this.saveTransactions();
            this.saveOrders();
            
            // SEND INVOICE EMAIL
            this.sendInvoiceEmail(transaction, order);
            
            console.log(' PAYMENT PROCESSED:', transaction.id, 'Amount: $' + transaction.amount);
            
            return { success: true, transaction, order };
          } else {
            transaction.status = 'failed';
            transaction.error = result.error;
            this.transactions.push(transaction);
            this.saveTransactions();
            
            throw new Error(result.error || 'Payment processing failed');
          }
        } catch (error) {
          console.error('Payment error:', error);
          throw error;
        }
      },
      
      // REAL payment processing - deducts from balance
      async processRealPayment(transaction, user, userIndex, users) {
        return new Promise((resolve) => {
          setTimeout(() => {
            try {
              // PERFORM ACTUAL CHARGE
              const previousBalance = user.balance || 0;
              user.balance = previousBalance - transaction.amount;
              
              // ADD TO OWNER BALANCE (earnings)
              const currentOwnerBalance = parseFloat(localStorage.getItem('ownerBalance') || '0');
              const newOwnerBalance = currentOwnerBalance + transaction.amount;
              localStorage.setItem('ownerBalance', newOwnerBalance.toString());
              
              // TRACK EARNINGS TRANSACTION
              const earnings = JSON.parse(localStorage.getItem('ownerEarnings') || '[]');
              earnings.push({
                id: transaction.id,
                orderId: transaction.orderId,
                amount: transaction.amount,
                customerEmail: transaction.customer.email,
                customerName: transaction.customer.name,
                product: transaction.product?.label || 'Unknown',
                timestamp: transaction.timestamp,
                previousBalance: currentOwnerBalance,
                newBalance: newOwnerBalance
              });
              localStorage.setItem('ownerEarnings', JSON.stringify(earnings));
              
              // Save updated user with new balance
              users[userIndex] = user;
              localStorage.setItem('users', JSON.stringify(users));
              
              // Success response
              resolve({
                success: true,
                receipt: {
                  id: 'RCP_' + Date.now(),
                  timestamp: new Date().toISOString(),
                  method: transaction.method,
                  amount: transaction.amount,
                  reference: transaction.id,
                  previousBalance: previousBalance,
                  newBalance: user.balance
                }
              });
              
              console.log(` CHARGED: $${transaction.amount} from ${transaction.customer.email}`);
              console.log(`   Previous Balance: $${previousBalance.toFixed(2)}  New Balance: $${user.balance.toFixed(2)}`);
              console.log(` OWNER EARNINGS: $${currentOwnerBalance.toFixed(2)}  $${newOwnerBalance.toFixed(2)}`);
              
            } catch (error) {
              resolve({
                success: false,
                error: 'Failed to process payment: ' + error.message
              });
            }
          }, 2000);
        });
      },
      
      // Send invoice email
      sendInvoiceEmail(transaction, order) {
        try {
          const invoiceContent = `
INVOICE - Atlas FN Purchase
====================================
Order ID: ${order.id}
Transaction ID: ${transaction.id}
Date: ${new Date(transaction.timestamp).toLocaleString()}

Customer Information:
- Name: ${transaction.customer.name}
- Email: ${transaction.customer.email}
- Phone: ${transaction.customer.phone || 'N/A'}
- Address: ${transaction.customer.address?.street || 'N/A'}, ${transaction.customer.address?.city || ''}, ${transaction.customer.address?.state || ''} ${transaction.customer.address?.zip || ''}

Purchase Details:
- Product: ${transaction.product?.label || 'Atlas Access'}
- Amount: $${transaction.amount.toFixed(2)}
- Currency: ${transaction.currency}
- Payment Method: ${transaction.method}

Access Information:
- Access Key: ${order.accessKey}
- Status: ACTIVE
- Product Duration: ${transaction.product?.label || 'Unknown'}

====================================
Thank you for your purchase!
For support, contact: support@atlasfn.com
====================================
          `;
          
          // In a real system, this would call a backend email service
          // For now, we store it in localStorage for retrieval
          const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
          invoices.push({
            id: order.id,
            transactionId: transaction.id,
            email: transaction.customer.email,
            content: invoiceContent,
            timestamp: transaction.timestamp,
            sent: true
          });
          localStorage.setItem('invoices', JSON.stringify(invoices));
          
          console.log(' Invoice generated and stored for:', transaction.customer.email);
          
          // TODO: Integrate with email service (SendGrid, Nodemailer, etc.)
          // Example: await emailService.send({ to: transaction.customer.email, subject: 'Your Invoice', body: invoiceContent });
          
        } catch (error) {
          console.error('Invoice generation error:', error);
        }
      },
      
      // Generate access key
      generateAccessKey() {
        const parts = [];
        for (let i = 0; i < 4; i++) {
          parts.push(Math.random().toString(36).substr(2, 8).toUpperCase());
        }
        return parts.join('-');
      },
      
      // Get order by ID
      getOrder(orderId) {
        return this.orders.find(o => o.id === orderId);
      },
      
      // STRIPE PAYMENT PROCESSOR
      async processStripePayment(transaction, cardElement) {
        if (!stripe) {
          throw new Error('Stripe not initialized. Configure STRIPE_CONFIG with your API keys.');
        }

        try {
          // Create payment intent via Stripe
          // This would normally be done server-side for security
          const clientSecret = await this.createStripePaymentIntent(transaction.amount, transaction.id);

          if (!clientSecret) {
            throw new Error('Failed to create Stripe payment intent');
          }

          // Confirm payment with card element
          const result = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                name: transaction.customer.name,
                email: transaction.customer.email,
                phone: transaction.customer.phone,
                address: {
                  line1: transaction.customer.address?.street || '',
                  city: transaction.customer.address?.city || '',
                  state: transaction.customer.address?.state || '',
                  postal_code: transaction.customer.address?.zip || ''
                }
              }
            }
          });

          if (result.error) {
            throw new Error(result.error.message);
          }

          if (result.paymentIntent.status === 'succeeded') {
            console.log(' Stripe payment succeeded:', result.paymentIntent.id);
            
            // Add metadata
            transaction.stripePaymentIntentId = result.paymentIntent.id;
            transaction.stripeStatus = 'succeeded';
            
            return {
              success: true,
              stripeId: result.paymentIntent.id,
              receipt: {
                id: result.paymentIntent.id,
                timestamp: new Date().toISOString(),
                method: 'stripe',
                amount: transaction.amount,
                reference: transaction.id
              }
            };
          }

          throw new Error('Stripe payment did not succeed');
        } catch (error) {
          console.error('Stripe payment error:', error);
          throw error;
        }
      },

      // Create Stripe Payment Intent (via secure Vercel Function)
      async createStripePaymentIntent(amount, transactionId) {
        try {
          console.log(' Creating payment intent via secure serverless function...');
          
          // Call our secure Vercel serverless function
          const response = await fetch('/api/create-payment-intent', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              amount: Math.round(amount * 100), // Convert to cents
              currency: 'usd',
              description: `Atlas FN Purchase - ${transactionId}`,
              metadata: {
                transaction_id: transactionId,
                timestamp: new Date().toISOString()
              }
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to create payment intent');
          }

          const data = await response.json();
          console.log(' Payment intent created successfully');
          
          return data.clientSecret;
        } catch (error) {
          console.error(' Payment intent creation error:', error);
          throw new Error('Unable to process payment. Please try again.');
        }
      },

      // Get transaction by ID
      getTransaction(transactionId) {
        return this.transactions.find(t => t.id === transactionId);
      },
      
      // Process refund
      processRefund(transactionId, reason = 'Customer request') {
        const transaction = this.getTransaction(transactionId);
        if (!transaction) {
          return { success: false, error: 'Transaction not found' };
        }
        
        if (transaction.status === 'refunded') {
          return { success: false, error: 'Payment already refunded' };
        }
        
        transaction.status = 'refunded';
        transaction.refundedAt = new Date().toISOString();
        transaction.refundReason = reason;
        
        const order = this.getOrder(transaction.orderId);
        if (order) {
          order.status = 'refunded';
        }
        
        this.saveTransactions();
        this.saveOrders();
        
        return { success: true, transaction };
      },
      
      // Get customer transactions
      getCustomerTransactions(email) {
        return this.transactions.filter(t => t.customer.email === email);
      },
      
      // Get transaction history (staff/admin)
      getAllTransactions(limit = 100) {
        return this.transactions.slice(-limit).reverse();
      }
    };
    
    // Card formatting helpers
    function formatCardNumber(input) {
      let value = input.value.replace(/\s/g, '');
      let formatted = value.replace(/(\d{4})/g, '$1 ').trim();
      input.value = formatted;
    }
    
    function formatExpiry(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
      }
      input.value = value;
    }
    
    // Setup card element fallback UI
    function setupPaymentUI() {
      const cardElement = document.getElementById('card-element');
      if (cardElement) {
        cardElement.innerHTML = `
          <div style="display: grid; gap: 1rem;">
            <div class="form-group">
              <input type="text" id="cardName" placeholder="Full Name" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);" required>
            </div>
            <div class="form-group">
              <input type="text" id="cardNumber" placeholder="Card Number" maxlength="19" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);" oninput="formatCardNumber(this)" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5" style="padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);" oninput="formatExpiry(this)" required>
              <input type="text" id="cardCVV" placeholder="CVV" maxlength="4" style="padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: #0a0a0c; color: var(--text);" required>
            </div>
          </div>
        `;
      }
    }
    
    function selectPaymentMethod(method) {
      paymentSystem.selectedMethod = method;
      closePaymentMethodModal();
      proceedWithPayment();
    }
    
    function closePaymentMethodModal() {
      const modal = document.getElementById('customPaymentModal');
      if (modal) modal.style.display = 'none';
    }
    
    function openPaymentMethodModal() {
      const modal = document.getElementById('customPaymentModal');
      if (modal) modal.style.display = 'flex';
    }

    // ====== LANDING PAGE FUNCTIONS ======

    function checkLandingPageAuth() {
      const currentUser = localStorage.getItem('currentUser');
      const landingPage = document.getElementById('landingPage');
      const landingLoggedIn = document.getElementById('landingLoggedIn');
      const landingLoggedOut = document.getElementById('landingLoggedOut');
      
      if (currentUser) {
        landingLoggedIn.style.display = 'block';
        landingLoggedOut.style.display = 'none';
      } else {
        landingLoggedIn.style.display = 'none';
        landingLoggedOut.style.display = 'block';
      }
    }

    function goToStore() {
      window.location.href = 'purchase.html';
    }

    function openLoginFromLanding() {
      showToast('Login is disabled on this site.', 'info');
    }

    function openSignupFromLanding() {
      showToast('Signup is disabled on this site.', 'info');
    }

    // Initialize landing page on load
    window.addEventListener('DOMContentLoaded', () => {
      // Initialize custom payment system
      if (typeof paymentSystem !== 'undefined') {
        paymentSystem.init();
      }
      
      // Landing page disabled - skip checkLandingPageAuth();
      updateTestOptionVisibility();
      
      const accessSelect = document.getElementById('access-duration');
      if (accessSelect) {
        updateAccessPrice();
        accessSelect.addEventListener('change', updateAccessPrice);
      }
      
      // Autofill form if user is logged in with previous purchases
      if (localStorage.getItem('currentUser')) {
        setTimeout(autofillPurchaseForm, 500);
      }
    })

    const accessKeyPricing = {
      'test': { label: 'Test Purchase (50)', price: 0.50, desc: 'Test the payment system - 50 cents', badge: 'Test', icon: 'fa-flask' },
      '1_day': { label: '1 day', price: 3.99, desc: '24-hour access to all Atlas FN features', badge: 'In Stock', icon: 'fa-key' },
      '1_week': { label: '1 week', price: 9.99, desc: '7 days of unrestricted access to all features', badge: 'In Stock', icon: 'fa-key' },
      '1_month': { label: '1 month', price: 19.99, desc: '30 days of full access with premium support', badge: 'In Stock', icon: 'fa-key' },
      '3_months': { label: '3 months', price: 39.99, desc: '90 days of premium access with priority updates', badge: 'Popular', icon: 'fa-crown' },
      'lifetime': { label: 'lifetime', price: 99.99, desc: 'Unlimited access forever with all future updates', badge: 'Best Value', icon: 'fa-star' }
    };

    // Product Detail Modal Logic
    let selectedProductKey = '1_day';
    let selectedVariant = '1_day';
    let productQuantity = 1;

    function openProductDetail(productKey) {
      selectedProductKey = productKey;
      selectedVariant = productKey;
      productQuantity = 1;

      const product = accessKeyPricing[productKey];
      if (!product) return;

      // Update modal content
      document.getElementById('modalProductTitle').textContent = product.label.charAt(0).toUpperCase() + product.label.slice(1) + ' Access';
      document.getElementById('modalProductPrice').textContent = '$' + product.price.toFixed(2);
      document.getElementById('modalProductDesc').textContent = product.desc;
      document.getElementById('modalProductBadge').textContent = product.badge;
      document.getElementById('modalProductImage').innerHTML = '<i class="fas ' + product.icon + '"></i>';
      document.getElementById('quantityDisplay').textContent = productQuantity;

      // Build variant grid
      const variantGrid = document.getElementById('variantGrid');
      variantGrid.innerHTML = '';

      Object.keys(accessKeyPricing).forEach(key => {
        const variant = accessKeyPricing[key];
        const variantDiv = document.createElement('div');
        variantDiv.className = 'variant-option' + (key === selectedVariant ? ' selected' : '');
        variantDiv.onclick = () => selectVariant(key);
        variantDiv.innerHTML = `
          <div class="variant-label">${variant.label}</div>
          <div class="variant-price">$${variant.price.toFixed(2)}</div>
        `;
        variantGrid.appendChild(variantDiv);
      });

      // Show modal
      document.getElementById('productDetailModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // ===== OWNER ACCESS SYSTEM =====
    const ownerPassword = 'Atl4s$Pr0_Ow9r#2026!SecureK3y';
    const panelKeys = {};

    function openRedeemModal() {
      document.getElementById('redeemModal').classList.add('active');
      document.getElementById('redeemKey').value = '';
      document.getElementById('redeemError').style.display = 'none';
      document.body.style.overflow = 'hidden';
    }

    function closeRedeemModal() {
      document.getElementById('redeemModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function openRedeemSuccess(panelName) {
      const nameEl = document.getElementById('redeemSuccessName');
      if (nameEl) nameEl.textContent = panelName || 'your panel';
      document.getElementById('redeemSuccessModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeRedeemSuccessModal() {
      document.getElementById('redeemSuccessModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function openRedeemPanel() {
      closeRedeemSuccessModal();
      window.open('panel.html', '_blank');
    }

    function openOwnerAccessPrompt() {
      closeRedeemModal();
      setTimeout(() => openAccessModal(), 100);
    }

    function openAccessModal() {
      document.getElementById('accessModal').classList.add('active');
      document.getElementById('accessPassword').value = '';
      document.getElementById('accessError').style.display = 'none';
      document.body.style.overflow = 'hidden';
    }

    function closeAccessModal() {
      document.getElementById('accessModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function redeemPanelKey() {
      const key = document.getElementById('redeemKey').value.trim();
      const errorEl = document.getElementById('redeemError');
      
      const stored = localStorage.getItem('ownerPanelKeys');
      const keys = stored ? JSON.parse(stored) : {};
      
      if (keys[key] && keys[key].active) {
        closeRedeemModal();
        // Store the redeemed key for the user
        localStorage.setItem('userActiveKey', JSON.stringify({
          key: key,
          panel: keys[key].name,
          type: keys[key].type,
          redeemedAt: new Date().toLocaleString()
        }));
        
        // Show staff ticket tab if applicable
        checkStaffAccess();
        openRedeemSuccess(keys[key].name);
      } else {
        errorEl.textContent = 'Invalid or inactive key';
        errorEl.style.display = 'block';
      }
    }

    function checkStaffAccess() {
      const userKey = JSON.parse(localStorage.getItem('userActiveKey') || 'null');
      const allTicketsTab = document.getElementById('allTicketsTab');
      
      if (userKey && ['admin', 'moderator', 'custom'].includes(userKey.type)) {
        // Show staff ticket tab
        if (allTicketsTab) allTicketsTab.style.display = 'block';
        updateStaffTicketBadge();
      } else {
        if (allTicketsTab) allTicketsTab.style.display = 'none';
      }
    }

    // Check staff access on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkStaffAccess();
    });

    function verifyOwnerPassword() {
      const password = document.getElementById('accessPassword').value;
      const errorEl = document.getElementById('accessError');
      
      if (password === ownerPassword) {
        closeAccessModal();
        loadOwnerPanel();
        openOwnerPanel();
      } else {
        errorEl.textContent = 'Incorrect password';
        errorEl.style.display = 'block';
      }
    }

    function openOwnerPanel() {
      document.getElementById('ownerPanelModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeOwnerPanel() {
      document.getElementById('ownerPanelModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function switchOwnerTab(tabName) {
      // Hide all tabs
      document.getElementById('generateTab').classList.remove('active');
      document.getElementById('manageTab').classList.remove('active');
      
      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Update active button
      const buttons = document.querySelectorAll('.modal-tab');
      buttons.forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
    }

    function generateKey() {
      const panelName = document.getElementById('panelName').value.trim();
      const keyType = document.getElementById('keyType').value;
      
      if (!panelName) {
        showToast('Please enter a panel name', 'error');
        return;
      }
      
      // Generate a random key
      const key = 'ATL_' + Math.random().toString(36).substr(2, 9).toUpperCase() + '_' + Date.now().toString(36).toUpperCase();
      
      panelKeys[key] = {
        name: panelName,
        type: keyType,
        created: new Date().toLocaleString(),
        active: true
      };
      
      localStorage.setItem('ownerPanelKeys', JSON.stringify(panelKeys));
      
      // Display the generated key
      document.getElementById('generatedKeyValue').value = key;
      document.getElementById('generatedKeyDisplay').style.display = 'block';
      
      // Clear form
      document.getElementById('panelName').value = '';
      document.getElementById('keyType').value = 'admin';
      
      showToast('Key generated successfully!', 'success');
      updateKeysList();
    }

    function loadOwnerPanel() {
      const stored = localStorage.getItem('ownerPanelKeys');
      if (stored) {
        Object.assign(panelKeys, JSON.parse(stored));
      }
      updateKeysList();
    }

    function updateKeysList() {
      const keysList = document.getElementById('keysList');
      const keys = Object.entries(panelKeys);
      
      if (keys.length === 0) {
        keysList.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">No keys generated yet.</p>';
        return;
      }
      
      keysList.innerHTML = keys.map(([key, data]) => `
        <div style="padding: 1rem; background: #0a0a0c; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
              <p style="color: var(--accent); font-weight: 600; margin: 0;">${data.name}</p>
              <p style="color: #888; font-size: 0.85rem; margin: 0.25rem 0 0 0;">Type: ${data.type} | Created: ${data.created}</p>
            </div>
            <button onclick="deleteKey('${key}')" style="padding: 0.5rem 1rem; background: #ff6b6b; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" readonly value="${key}" style="flex: 1; padding: 0.6rem; background: #16161a; border: 1px solid var(--border); border-radius: 6px; color: var(--accent); font-family: monospace; font-size: 0.8rem;">
            <button onclick="copyToClipboard_key('${key}')" style="padding: 0.6rem 1rem; background: #a855f7; border: none; border-radius: 6px; color: #fff; cursor: pointer;">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function deleteKey(key) {
      if (confirm('Are you sure you want to delete this key?')) {
        delete panelKeys[key];
        localStorage.setItem('ownerPanelKeys', JSON.stringify(panelKeys));
        updateKeysList();
        showToast('Key deleted', 'success');
      }
    }

    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      element.select();
      document.execCommand('copy');
      showToast('Copied to clipboard!', 'success');
    }

    function copyToClipboard_key(key) {
      const temp = document.createElement('textarea');
      temp.value = key;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand('copy');
      document.body.removeChild(temp);
      showToast('Key copied!', 'success');
    }

    function closeProductDetail() {
      document.getElementById('productDetailModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function selectVariant(variantKey) {
      selectedVariant = variantKey;
      const variant = accessKeyPricing[variantKey];
      
      // Update selected state
      document.querySelectorAll('.variant-option').forEach(option => {
        option.classList.remove('selected');
      });
      event.target.closest('.variant-option').classList.add('selected');

      // Update price
      document.getElementById('modalProductPrice').textContent = '$' + variant.price.toFixed(2);
    }

    function increaseQuantity() {
      if (productQuantity < 99) {
        productQuantity++;
        document.getElementById('quantityDisplay').textContent = productQuantity;
      }
    }

    function decreaseQuantity() {
      if (productQuantity > 1) {
        productQuantity--;
        document.getElementById('quantityDisplay').textContent = productQuantity;
      }
    }

    function addToCart() {
      // For now, just show a toast notification
      showToast('Added to cart! (Cart feature coming soon)', 'success');
      closeProductDetail();
    }

    function buyNow() {
      // Select the variant and scroll to payment form
      const variant = selectedVariant || '1_day';
      
      // Set the selected product in the dropdown
      const accessSelect = document.getElementById('access-duration');
      if (accessSelect) {
        accessSelect.value = variant;
        updateAccessPrice();
      }
      
      closeProductDetail();
      
      // Scroll to the store/payment section
      const storeView = document.getElementById('store-view');
      if (storeView) {
        storeView.style.display = 'block';
        storeView.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      showToast('Ready to checkout! Fill in your details below.', 'success');
    }

    function updateAccessPrice() {
      const select = document.getElementById('access-duration');
      const amountInput = document.getElementById('access-amount');
      if (!select || !amountInput) return;

      const selected = accessKeyPricing[select.value];
      if (!selected) return;

      amountInput.value = selected.price.toFixed(2);
    }

    function autofillPurchaseForm() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      if (!currentUser) return;

      // Get last saved customer data from transactions if they exist
      const transactions = paymentSystem.transactions.filter(t => t.isReal && t.status === 'completed' && t.customer.email === currentUser.email);
      if (transactions.length === 0) return;

      const lastTransaction = transactions[transactions.length - 1];
      const customer = lastTransaction.customer;

      // Autofill form fields (no saving)
      const nameField = document.getElementById('donor-name');
      const emailField = document.getElementById('donor-email');
      const phoneField = document.getElementById('donor-phone');
      const addressField = document.getElementById('donor-address');
      const cityField = document.getElementById('donor-city');
      const stateField = document.getElementById('donor-state');
      const zipField = document.getElementById('donor-zip');

      if (nameField && customer.name) nameField.value = customer.name;
      if (emailField && customer.email) emailField.value = customer.email;
      if (phoneField && customer.phone) phoneField.value = customer.phone;
      if (addressField && customer.address) addressField.value = customer.address.street || '';
      if (cityField && customer.address) cityField.value = customer.address.city || '';
      if (stateField && customer.address) stateField.value = customer.address.state || '';
      if (zipField && customer.address) zipField.value = customer.address.zip || '';
    }

    function openStoreView() {
      const storeView = document.getElementById('store-view');
      if (!storeView) return;

      // Autofill form if user is logged in and has previous purchases
      autofillPurchaseForm();

      storeView.scrollIntoView({ behavior: 'smooth', block: 'center' });
      const select = document.getElementById('access-duration');
      if (select) {
        select.focus();
      }
    }

    const payButton = document.getElementById('pay-button');
    if (payButton) {
      payButton.addEventListener('click', async (e) => {
      e.preventDefault();

      // Get all form values
      const accessSelect = document.getElementById('access-duration');
      const accessChoice = accessSelect ? accessSelect.value : '';
      const accessInfo = accessKeyPricing[accessChoice];
      const amount = accessInfo ? accessInfo.price : NaN;
      const name = document.getElementById('donor-name').value.trim();
      const email = document.getElementById('donor-email').value.trim();
      const phone = document.getElementById('donor-phone').value.trim();
      const address = document.getElementById('donor-address').value.trim();
      const city = document.getElementById('donor-city').value.trim();
      const state = document.getElementById('donor-state').value.trim();
      const zip = document.getElementById('donor-zip').value.trim();
      const country = document.getElementById('donor-country').value;
      const messageDiv = document.getElementById('payment-message');

      // Validation
      if (!accessInfo || !amount || amount < 0.50) {
        messageDiv.textContent = ' Please select a valid access duration';
        messageDiv.style.color = '#ff6b6b';
        if (accessSelect) accessSelect.focus();
        return;
      }

      if (!name) {
        messageDiv.textContent = ' Please enter your full name';
        messageDiv.style.color = '#ff6b6b';
        document.getElementById('donor-name').focus();
        return;
      }

      if (!email) {
        messageDiv.textContent = ' Please enter your email address';
        messageDiv.style.color = '#ff6b6b';
        document.getElementById('donor-email').focus();
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        messageDiv.textContent = ' Please enter a valid email address';
        messageDiv.style.color = '#ff6b6b';
        document.getElementById('donor-email').focus();
        return;
      }

      if (!address) {
        messageDiv.textContent = ' Please enter your street address';
        messageDiv.style.color = '#ff6b6b';
        document.getElementById('donor-address').focus();
        return;
      }

      if (!city) {
        messageDiv.textContent = ' Please enter your city';
        messageDiv.style.color = '#ff6b6b';
        document.getElementById('donor-city').focus();
        return;
      }

      if (!state) {
        messageDiv.textContent = ' Please enter your state/province';
        messageDiv.style.color = '#ff6b6b';
        document.getElementById('donor-state').focus();
        return;
      }

      if (!zip) {
        messageDiv.textContent = ' Please enter your zip/postal code';
        messageDiv.style.color = '#ff6b6b';
        document.getElementById('donor-zip').focus();
        return;
      }

      // Process payment directly with card
      proceedWithPayment();
      });
    }

    // Proceed with payment after method selection
    async function proceedWithPayment() {
      const messageDiv = document.getElementById('payment-message');
      
      // Validate card fields
      const cardName = document.getElementById('cardName')?.value.trim();
      const cardNumber = document.getElementById('cardNumber')?.value.replace(/\s/g, '');
      const cardExpiry = document.getElementById('cardExpiry')?.value;
      const cardCVV = document.getElementById('cardCVV')?.value;
      
      if (!cardName || cardNumber.length < 13 || !cardExpiry || !cardCVV) {
        messageDiv.textContent = ' Please fill in all card details';
        messageDiv.style.color = '#ff6b6b';
        return;
      }

      const accessSelect = document.getElementById('access-duration');
      const accessChoice = accessSelect.value;
      const accessInfo = accessKeyPricing[accessChoice];
      const name = document.getElementById('donor-name').value.trim();
      const email = document.getElementById('donor-email').value.trim();
      const phone = document.getElementById('donor-phone').value.trim();
      const address = document.getElementById('donor-address').value.trim();
      const city = document.getElementById('donor-city').value.trim();
      const state = document.getElementById('donor-state').value.trim();
      const zip = document.getElementById('donor-zip').value.trim();
      const country = document.getElementById('donor-country').value;

      messageDiv.textContent = ' Processing credit card payment...';
      messageDiv.style.color = '#00d4ff';

      try {
        const result = await paymentSystem.processPayment({
          amount: accessInfo.price,
          currency: 'USD',
          email: email,
          name: name,
          phone: phone,
          method: 'credit_card',
          address: {
            line1: address,
            city: city,
            state: state,
            postal_code: zip,
            country: country
          },
          product: {
            id: accessChoice,
            name: accessInfo.label + ' Access',
            description: accessInfo.desc,
            price: accessInfo.price
          }
        });

        if (result.success) {
          const order = result.order;
          // Store order for receipt page
          localStorage.setItem('lastOrder', JSON.stringify(order));
          messageDiv.textContent = ` Payment successful! Redirecting...`;
          messageDiv.style.color = '#00ff88';
          
          // Redirect to receipt page
          setTimeout(() => {
            window.location.href = '#receipt';
          }, 1500);
        }
      } catch (error) {
        messageDiv.textContent = ` ${error.message}`;
        messageDiv.style.color = '#ff6b6b';
      }
    }

    // Real-time card validation (fallback)
    const cardElement = document.getElementById('card-element');
    if (cardElement) {
      cardElement.addEventListener('change', (event) => {
        const displayError = document.getElementById('payment-message');
        if (event.error) {
          displayError.textContent = event.error.message;
          displayError.style.color = '#ff6b6b';
        } else {
          displayError.textContent = '';
        }
      });
    }

    // ====== AUTHENTICATION FUNCTIONS ======

    // Security: Simple XSS prevention
    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function getCurrentUserProfile() {
      return JSON.parse(localStorage.getItem('currentUserProfile') || 'null');
    }

    function saveCurrentUserProfile(profile) {
      localStorage.setItem('currentUserProfile', JSON.stringify(profile));
    }

    function clearCurrentUserProfile() {
      localStorage.removeItem('currentUserProfile');
    }

    function getRoleFlags(profile) {
      const permissions = Array.isArray(profile && profile.permissions) ? profile.permissions : [];
      const role = profile && profile.role ? profile.role : '';
      const isDev = role === 'dev' || permissions.includes('dev');
      const isHeadStaff = role === 'head_staff' || permissions.includes('head_staff');
      const isStaff = role === 'staff' || permissions.includes('staff') || isHeadStaff || isDev;
      return { isDev, isStaff, isHeadStaff };
    }

    function getCurrentUserFlags() {
      const profile = getCurrentUserProfile();
      if (profile) {
        return getRoleFlags(profile);
      }

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      if (!currentUser) {
        return { isDev: false, isStaff: false, isHeadStaff: false };
      }

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const fullUser = users.find(u => u.id === currentUser.id || u.email === currentUser.email);
      return {
        isDev: !!(fullUser && fullUser.isDev),
        isStaff: !!(fullUser && fullUser.isStaff),
        isHeadStaff: !!(fullUser && fullUser.isHeadStaff)
      };
    }

    function syncCurrentUserToLocal(profile) {
      if (!profile) return;
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const flags = getRoleFlags(profile);
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      if (!currentUser) return;

      const userIndex = users.findIndex(u => u.id === currentUser.id || u.email === currentUser.email);
      const updated = {
        id: currentUser.id,
        name: profile.username || currentUser.name || 'User',
        email: profile.email || currentUser.email,
        createdAt: profile.created_at || new Date().toISOString(),
        isDev: flags.isDev,
        isStaff: flags.isStaff,
        isHeadStaff: flags.isHeadStaff
      };

      if (userIndex === -1) {
        users.push(updated);
      } else {
        users[userIndex] = { ...users[userIndex], ...updated };
      }

      localStorage.setItem('users', JSON.stringify(users));
    }

    function buildProfileUpdatesFromFlags(flags) {
      const permissions = [];
      if (flags.isStaff) permissions.push('staff');
      if (flags.isHeadStaff) permissions.push('head_staff');
      if (flags.isDev) permissions.push('dev');

      let role = 'customer';
      if (flags.isDev) {
        role = 'dev';
      } else if (flags.isHeadStaff) {
        role = 'head_staff';
      } else if (flags.isStaff) {
        role = 'staff';
      }

      return { role, permissions };
    }

    async function updateCurrentUserProfileOnServer(updates) {
      const token = localStorage.getItem('authToken');
      if (!token) return false;

      try {
        const response = await fetch('/api/auth/user', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updates)
        });

        if (!response.ok) {
          return false;
        }

        const data = await response.json();
        if (data && data.user) {
          saveCurrentUserProfile(data.user);
          syncCurrentUserToLocal(data.user);
          updatePanelMenuVisibility();
        }

        return true;
      } catch (error) {
        console.error('Profile update error:', error);
        return false;
      }
    }

    async function fetchCurrentUserProfile() {
      const token = localStorage.getItem('authToken');
      if (!token) return null;

      try {
        const response = await fetch('/api/auth/user', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          clearCurrentUserProfile();
          localStorage.removeItem('authToken');
          localStorage.removeItem('currentUser');
          return null;
        }

        const data = await response.json();
        if (data && data.user) {
          saveCurrentUserProfile(data.user);
          syncCurrentUserToLocal(data.user);
          localStorage.setItem('currentUser', JSON.stringify({
            id: data.user.id,
            name: data.user.username,
            email: data.user.email
          }));
          updatePanelMenuVisibility();
          updateTestOptionVisibility();
          updateNavBar({ name: data.user.username || data.user.email });
          return data.user;
        }

        return null;
      } catch (error) {
        console.error('Profile fetch error:', error);
        return null;
      }
    }

    let actionModalHandler = null;
    let banRequestTarget = null;
    let focusedBanRequestId = null;

    const privacyConfig = {
      blockContextMenu: true,
      blockSelection: true,
      blockHotkeys: true,
      devtoolsOverlay: true,
      integrityCheck: true
    };

    function isTestModeActive() {
      return sessionStorage.getItem('testModeActive') === 'true';
    }

    function showPrivacyOverlay(message) {
      if (isDevUser() || isTestModeActive()) return;
      const overlay = document.getElementById('privacyOverlay');
      const messageEl = document.getElementById('privacyMessage');
      if (!overlay) return;

      if (messageEl && message) {
        messageEl.textContent = message;
      }

      overlay.classList.add('active');
    }

    function setupPrivacyGuards() {
      if (privacyConfig.blockContextMenu) {
        document.addEventListener('contextmenu', (event) => {
          if (isDevUser() || isTestModeActive()) return;
          event.preventDefault();
        });
      }

      if (privacyConfig.blockSelection) {
        document.addEventListener('selectstart', (event) => {
          if (isDevUser() || isTestModeActive()) return;
          if (event.target && event.target.closest && event.target.closest('input, textarea')) {
            return;
          }
          event.preventDefault();
        });

        document.addEventListener('dragstart', (event) => {
          if (isDevUser() || isTestModeActive()) return;
          event.preventDefault();
        });
      }

      if (privacyConfig.blockHotkeys) {
        document.addEventListener('keydown', (event) => {
          if (isDevUser() || isTestModeActive()) return;
          if (typeof event.key !== 'string') {
            return;
          }
          const key = event.key.toLowerCase();
          const ctrl = event.ctrlKey || event.metaKey;
          const shift = event.shiftKey;

          if (key === 'f12' || (ctrl && shift && ['i', 'j', 'c'].includes(key)) || (ctrl && ['u', 's', 'p'].includes(key))) {
            event.preventDefault();
            event.stopPropagation();
            showPrivacyOverlay('This view is protected. Please close developer tools and refresh.');
          }
        }, true);
      }

      if (privacyConfig.devtoolsOverlay) {
        const threshold = 160;
        setInterval(() => {
          if (isDevUser() || isTestModeActive()) return;
          const widthGap = window.outerWidth - window.innerWidth;
          const heightGap = window.outerHeight - window.innerHeight;
          if (widthGap > threshold || heightGap > threshold) {
            showPrivacyOverlay('Developer tools detected. Please close them to continue.');
          }
        }, 800);
      }

      if (privacyConfig.integrityCheck) {
        const baseline = {
          handleSignup: typeof handleSignup === 'function' ? handleSignup.toString() : '',
          handleLogin: typeof handleLogin === 'function' ? handleLogin.toString() : '',
          openDevPanel: typeof openDevPanel === 'function' ? openDevPanel.toString() : ''
        };

        setInterval(() => {
          if (isDevUser() || isTestModeActive()) return;
          if (baseline.handleSignup !== (typeof handleSignup === 'function' ? handleSignup.toString() : '')) {
            showPrivacyOverlay('Integrity check failed. Please refresh.');
          }
          if (baseline.handleLogin !== (typeof handleLogin === 'function' ? handleLogin.toString() : '')) {
            showPrivacyOverlay('Integrity check failed. Please refresh.');
          }
          if (baseline.openDevPanel !== (typeof openDevPanel === 'function' ? openDevPanel.toString() : '')) {
            showPrivacyOverlay('Integrity check failed. Please refresh.');
          }
        }, 1200);
      }
    }


    function showToast(message, type = 'info') {
      const container = document.getElementById('global-toast');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3500);
    }

    let banBannerTimer = null;
    const banPhrases = [
      'bum ahh jit got banned',
      'got da boot',
      'adios amigo'
    ];

    function showUniversalBanMessage() {
      const banner = document.getElementById('ban-banner');
      if (!banner) return;

      const phrase = banPhrases[Math.floor(Math.random() * banPhrases.length)];
      banner.textContent = phrase;
      banner.classList.add('show');

      if (banBannerTimer) {
        clearTimeout(banBannerTimer);
      }

      banBannerTimer = setTimeout(() => {
        banner.classList.remove('show');
      }, 3200);
    }

    function getFallbackLogoDataUrl() {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200">
          <defs>
            <linearGradient id="purpleGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#d8b4fe;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#a855f7;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#581c87;stop-opacity:1" />
            </linearGradient>
          </defs>
          <!-- Left side of A -->
          <polygon points="50,170 100,30 100,170" fill="url(#purpleGrad)" />
          <!-- Right side of A -->
          <polygon points="100,170 150,30 150,170" fill="url(#purpleGrad)" opacity="0.85" />
          <!-- Horizontal bar -->
          <rect x="55" y="110" width="90" height="12" fill="url(#purpleGrad)" />
          <!-- Diagonal line cut -->
          <line x1="70" y1="115" x2="140" y2="165" stroke="rgba(255,255,255,0.25)" stroke-width="10" stroke-linecap="round" />
        </svg>
      `;
      return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
    }function handleLogoError(img) {
      if (img.getAttribute('data-fallback-applied')) return;
      const fallback = getFallbackLogoDataUrl();
      img.setAttribute('data-fallback-applied', 'true');
      img.onerror = null;
      img.src = fallback;
    }

    function setLogoBackground() {
      const logoUrl = 'atlas_logo.png';
      const fallback = getFallbackLogoDataUrl();
      const loader = new Image();

      loader.onload = () => {
        document.documentElement.style.setProperty('--logo-bg', `url('${logoUrl}')`);
      };

      loader.onerror = () => {
        document.documentElement.style.setProperty('--logo-bg', `url('${fallback}')`);
      };

      loader.src = logoUrl;
      
      // Fallback timeout in case the image load event doesn't fire
      setTimeout(() => {
        if (!document.documentElement.style.getPropertyValue('--logo-bg')) {
          document.documentElement.style.setProperty('--logo-bg', `url('${fallback}')`);
        }
      }, 1000);
    }

    function showPanelMessage(panelId, message, type = 'info') {
      const panel = document.getElementById(panelId);
      if (!panel) {
        showToast(message, type);
        return;
      }

      panel.textContent = message;
      panel.className = `panel-message ${type} show`;

      setTimeout(() => {
        panel.classList.remove('show');
      }, 3500);
    }

    function getDevNotifications() {
      return JSON.parse(localStorage.getItem('devNotifications') || '[]');
    }

    function setDevNotifications(notifications) {
      localStorage.setItem('devNotifications', JSON.stringify(notifications));
    }

    function addDevNotification({ message, type = 'ban-request', requestId }) {
      const notifications = getDevNotifications();
      notifications.unshift({
        id: Date.now(),
        type,
        message,
        requestId,
        read: false,
        createdAt: new Date().toISOString()
      });
      setDevNotifications(notifications);
      renderDevNotifications();
    }

    function renderDevNotifications() {
      const dropdown = document.getElementById('dev-notif-dropdown');
      const countEl = document.getElementById('dev-notif-count');
      if (!dropdown || !countEl) return;

      const notifications = getDevNotifications();
      const unreadCount = notifications.filter(n => !n.read).length;

      countEl.textContent = unreadCount;
      countEl.style.display = unreadCount > 0 ? 'flex' : 'none';

      if (notifications.length === 0) {
        dropdown.innerHTML = '<div class="notif-empty">No new notifications.</div>';
        return;
      }

      dropdown.innerHTML = notifications
        .slice(0, 6)
        .map(notification => `
          <div class="notif-item ${notification.read ? '' : 'unread'}" onclick="handleDevNotificationClick(${notification.id})">
            <div>${sanitizeInput(notification.message)}</div>
            <div class="notif-time">${new Date(notification.createdAt).toLocaleString()}</div>
          </div>
        `)
        .join('');
    }

    function toggleDevNotifications() {
      const dropdown = document.getElementById('dev-notif-dropdown');
      if (!dropdown) return;

      if (dropdown.classList.contains('open')) {
        dropdown.classList.remove('open');
        return;
      }

      renderDevNotifications();
      dropdown.classList.add('open');
    }

    function closeDevNotifications() {
      const dropdown = document.getElementById('dev-notif-dropdown');
      if (dropdown) dropdown.classList.remove('open');
    }

    function markAllDevNotificationsRead() {
      const notifications = getDevNotifications().map(notification => ({
        ...notification,
        read: true
      }));
      setDevNotifications(notifications);
      renderDevNotifications();
    }

    function handleDevNotificationClick(notificationId) {
      const notifications = getDevNotifications();
      const index = notifications.findIndex(n => n.id === notificationId);
      if (index !== -1) {
        notifications[index].read = true;
        focusedBanRequestId = notifications[index].requestId || null;
        setDevNotifications(notifications);
      }

      closeDevNotifications();
      openDevPanel();
    }

    function openActionModal({ title, message, confirmText = 'Confirm', confirmClass = '', onConfirm }) {
      const modal = document.getElementById('actionModal');
      const titleEl = document.getElementById('actionModalTitle');
      const messageEl = document.getElementById('actionModalMessage');
      const confirmBtn = document.getElementById('actionModalConfirm');

      titleEl.textContent = title || 'Confirm Action';
      messageEl.textContent = message || '';
      confirmBtn.textContent = confirmText;
      confirmBtn.className = `modal-confirm ${confirmClass}`.trim();

      actionModalHandler = onConfirm || null;
      modal.classList.add('active');
    }

    function closeActionModal() {
      const modal = document.getElementById('actionModal');
      modal.classList.remove('active');
      actionModalHandler = null;
    }

    function openBanRequestModal(targetUser) {
      const modal = document.getElementById('banRequestModal');
      const targetText = document.getElementById('banRequestTarget');
      const reasonInput = document.getElementById('banRequestReason');

      banRequestTarget = targetUser;
      targetText.textContent = `Requesting ban for ${targetUser.email}`;
      reasonInput.value = '';
      modal.classList.add('active');
      reasonInput.focus();
    }

    function openBanRequestModalById(userId, panelMessageId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const target = users.find(u => u.id === userId);

      if (!target) {
        showPanelMessage(panelMessageId, 'User not found.', 'error');
        return;
      }

      openBanRequestModal({
        id: target.id,
        email: target.email,
        panelMessageId
      });
    }

    function closeBanRequestModal() {
      const modal = document.getElementById('banRequestModal');
      modal.classList.remove('active');
      banRequestTarget = null;
    }

    function submitBanRequest() {
      if (!banRequestTarget) return;

      const reasonInput = document.getElementById('banRequestReason');
      const reason = reasonInput.value.trim();
      if (!reason) {
        showToast('Please provide a reason for the ban request.', 'error');
        reasonInput.focus();
        return;
      }

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      if (!currentUser) {
        showToast('You must be logged in to submit a request.', 'error');
        return;
      }

      const requests = JSON.parse(localStorage.getItem('banRequests') || '[]');
      requests.unshift({
        id: Date.now(),
        targetUserId: banRequestTarget.id,
        targetEmail: banRequestTarget.email,
        requestedById: currentUser.id,
        requestedByName: currentUser.name,
        requestedByEmail: currentUser.email,
        reason,
        status: 'pending',
        createdAt: new Date().toISOString()
      });

      localStorage.setItem('banRequests', JSON.stringify(requests));
      addDevNotification({
        message: `Ban request submitted for ${banRequestTarget.email}.`,
        requestId: requests[0].id
      });
      closeBanRequestModal();
      showPanelMessage(banRequestTarget.panelMessageId, 'Ban request sent to developers.', 'success');
      renderBanRequests();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const confirmBtn = document.getElementById('actionModalConfirm');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
          if (typeof actionModalHandler === 'function') {
            actionModalHandler();
          }
          closeActionModal();
        });
      }

      document.addEventListener('click', (event) => {
        const wrapper = document.getElementById('dev-notif-wrapper');
        const dropdown = document.getElementById('dev-notif-dropdown');
        if (!wrapper || !dropdown || !dropdown.classList.contains('open')) return;

        if (!wrapper.contains(event.target)) {
          dropdown.classList.remove('open');
        }
      });
    });

    function getTimeoutDuration(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return null;

      const minutes = parseInt(select.value, 10);
      const labels = {
        30: '30 minutes',
        60: '1 hour',
        300: '5 hours',
        1440: '24 hours',
        2880: '48 hours',
        10080: '1 week'
      };

      if (!labels[minutes]) return null;
      return { minutes, label: labels[minutes] };
    }

    // Security: Basic password hashing (SHA-256)
    async function hashPassword(password) {
      try {
        if (typeof crypto !== 'undefined' && crypto.subtle) {
          const msgBuffer = new TextEncoder().encode(password);
          const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
      } catch (error) {
        // Fall through to basic hash for non-secure contexts.
      }

      let hash = 0;
      for (let i = 0; i < password.length; i++) {
        hash = ((hash << 5) - hash) + password.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash).toString(16).padStart(8, '0');
    }

    // Security: Rate limiting for login attempts
    const loginAttempts = {};
    function checkRateLimit(email) {
      const now = Date.now();
      if (!loginAttempts[email]) {
        loginAttempts[email] = { count: 1, firstAttempt: now };
        return true;
      }
      
      // Reset after 15 minutes
      if (now - loginAttempts[email].firstAttempt > 900000) {
        loginAttempts[email] = { count: 1, firstAttempt: now };
        return true;
      }
      
      // Max 5 attempts per 15 minutes
      if (loginAttempts[email].count >= 5) {
        return false;
      }
      
      loginAttempts[email].count++;
      return true;
    }

    // Update panel menu visibility based on user permissions
    function updatePanelMenuVisibility() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      if (!currentUser) {
        document.getElementById('menu-dev-panel').style.display = 'none';
        document.getElementById('menu-head-panel').style.display = 'none';
        document.getElementById('menu-staff-panel').style.display = 'none';
        document.getElementById('menu-owner-panel').style.display = 'none';
        return;
      }

      const flags = getCurrentUserFlags();
      document.getElementById('menu-dev-panel').style.display = flags.isDev ? 'flex' : 'none';
      document.getElementById('menu-head-panel').style.display = flags.isHeadStaff ? 'flex' : 'none';
      document.getElementById('menu-staff-panel').style.display = flags.isStaff ? 'flex' : 'none';
      document.getElementById('menu-owner-panel').style.display = (flags.isDev && currentUser.email === 'elijahstech09@gmail.com') ? 'flex' : 'none';
      console.log(' Panel Menu Updated:', { isDev: flags.isDev, isStaff: flags.isStaff, isHeadStaff: flags.isHeadStaff });
    }

    // Initialize default dev account
    async function initializeDevAccount() {
      if (localStorage.getItem('authToken')) {
        return;
      }
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      
      // Check if dev account already exists
      const devEmail = 'dev@atlasfn.com';
      const devExists = users.some(u => u.email === devEmail);
      
      if (!devExists) {
        // Create default dev account
        const devPassword = 'DevAdmin123';
        const hashedPassword = await hashPassword(devPassword);
        
        const devUser = {
          id: Date.now(),
          name: 'Developer',
          email: devEmail,
          password: hashedPassword,
          balance: 1000,
          createdAt: new Date().toISOString(),
          isDev: true
        };
        
        users.push(devUser);
        localStorage.setItem('users', JSON.stringify(users));
        console.log(' Dev account created: dev@atlasfn.com / DevAdmin123 (Balance: $1000.00)');
      }
      
      // Initialize owner balance if not exists
      if (!localStorage.getItem('ownerBalance')) {
        localStorage.setItem('ownerBalance', '0');
        localStorage.setItem('ownerEarnings', '[]');
        console.log(' Owner earnings system initialized');
      }
    }

    // Check if user is logged in on page load
    window.addEventListener('DOMContentLoaded', async () => {
      await initializeDevAccount();
      if (localStorage.getItem('authToken')) {
        await fetchCurrentUserProfile();
      }
      checkAccessRestrictions();
      setLogoBackground();
      setupPrivacyGuards();
      applyTestModeOnLoad();
      updateTestOptionVisibility();
      updatePanelMenuVisibility();
      
      // Auth UI removed

      // Landing page disabled - directly accessible
    });

    // ====== STAFF PANEL FUNCTIONS ======

    function checkAccessRestrictions() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      if (!currentUser) return;

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === currentUser.id);

      if (!user) return;

      // Check if user is blacklisted
      if (user.blacklisted) {
        showToast('Your account has been blacklisted. Access denied.', 'error');
        localStorage.removeItem('currentUser');
        setTimeout(() => window.location.reload(), 600);
        return;
      }

      // Check if user is timed out
      if (user.timeoutUntil && new Date(user.timeoutUntil) > new Date()) {
        const timeLeft = Math.ceil((new Date(user.timeoutUntil) - new Date()) / 60000);
        showToast(`Your account is timed out. Access restored in ${timeLeft} minutes.`, 'error');
        localStorage.removeItem('currentUser');
        setTimeout(() => window.location.reload(), 600);
        return;
      }

      // Clear expired timeouts
      if (user.timeoutUntil && new Date(user.timeoutUntil) <= new Date()) {
        user.timeoutUntil = null;
        const userIndex = users.findIndex(u => u.id === user.id);
        users[userIndex] = user;
        localStorage.setItem('users', JSON.stringify(users));
      }
    }

    function openStaffPanel() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) {
        showToast('Access denied. Staff privileges required.', 'error');
        return;
      }

      const flags = getCurrentUserFlags();
      if (!flags.isStaff) {
        showToast('Access denied. Staff privileges required.', 'error');
        return;
      }

      document.getElementById('staffPanel').classList.add('active');
      loadStaffPanel();
    }

    function closeStaffPanel() {
      document.getElementById('staffPanel').classList.remove('active');
    }

    function loadStaffPanel() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const now = new Date();

      // Calculate stats
      const totalUsers = users.length;
      const activeUsers = users.filter(u => !u.blacklisted && (!u.timeoutUntil || new Date(u.timeoutUntil) <= now)).length;
      const blacklisted = users.filter(u => u.blacklisted).length;
      const timedOut = users.filter(u => u.timeoutUntil && new Date(u.timeoutUntil) > now).length;

      document.getElementById('stat-total-users').textContent = totalUsers;
      document.getElementById('stat-active-users').textContent = activeUsers;
      document.getElementById('stat-blacklisted').textContent = blacklisted;
      document.getElementById('stat-timed-out').textContent = timedOut;

      // Load users list
      const container = document.getElementById('users-container');
      container.innerHTML = '';

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No users registered yet.</p>';
        return;
      }

      users.forEach(user => {
        const isBlacklisted = user.blacklisted || false;
        const isTimedOut = user.timeoutUntil && new Date(user.timeoutUntil) > now;
        const isStaff = user.isStaff || false;
        const isHeadStaff = user.isHeadStaff || false;
        const isDev = user.isDev || false;
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const isSelf = user.id === currentUser.id;

        let statusClass = '';
        if (isBlacklisted) statusClass = 'blacklisted';
        else if (isTimedOut) statusClass = 'timed-out';

        let timeoutInfo = '';
        if (isTimedOut) {
          const timeLeft = Math.ceil((new Date(user.timeoutUntil) - now) / 60000);
          timeoutInfo = `<p><i class="fas fa-clock"></i> Timeout expires in ${timeLeft} minutes</p>`;
        }

        const userDiv = document.createElement('div');
        userDiv.className = `user-item ${statusClass}`;
        userDiv.innerHTML = `
          <div class="user-info">
            <div class="user-details">
              <h4><i class="fas fa-user"></i> ${sanitizeInput(user.name || 'User')}</h4>
              <p><i class="fas fa-envelope"></i> ${sanitizeInput(user.email)}</p>
              <p><i class="fas fa-calendar"></i> Joined: ${new Date(user.createdAt).toLocaleDateString()}</p>
              ${timeoutInfo}
              <div class="user-badges">
                ${isDev ? '<span class="badge badge-dev"><i class="fas fa-code"></i> DEVELOPER</span>' : ''}
                ${isHeadStaff ? '<span class="badge badge-head-staff"><i class="fas fa-crown"></i> HEAD STAFF</span>' : ''}
                ${isStaff ? '<span class="badge badge-staff"><i class="fas fa-shield-alt"></i> STAFF</span>' : ''}
                ${isBlacklisted ? '<span class="badge badge-blacklisted"><i class="fas fa-ban"></i> BLACKLISTED</span>' : ''}
                ${isTimedOut ? '<span class="badge badge-timeout"><i class="fas fa-clock"></i> TIMED OUT</span>' : ''}
              </div>
            </div>
            <div class="user-actions">
              ${!isSelf && !isTimedOut && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-timeout" onclick="timeoutUser(${user.id})"><i class="fas fa-clock"></i> Timeout</button>` : ''}
              ${!isSelf && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-request" onclick="openBanRequestModalById(${user.id}, 'staff-message')"><i class="fas fa-flag"></i> Ban Request</button>` : ''}
              ${!isSelf && isTimedOut && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-restore" onclick="restoreUser(${user.id})"><i class="fas fa-undo"></i> Restore Timeout</button>` : ''}
              ${isSelf ? '<span style="color: #888; font-size: 0.85rem;"><i class="fas fa-info-circle"></i> You (cannot modify)</span>' : ''}
            </div>
          </div>
        `;
        container.appendChild(userDiv);
      });
    }

    function timeoutUser(userId) {
      const duration = getTimeoutDuration('staff-timeout-duration');
      if (!duration) {
        showPanelMessage('staff-message', 'Select a valid timeout duration.', 'error');
        return;
      }

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      if (userIndex === -1) {
        showPanelMessage('staff-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Timeout User',
        message: `Timeout ${target.email} for ${duration.label}?`,
        confirmText: 'Timeout',
        confirmClass: 'warning',
        onConfirm: () => {
          const timeoutUntil = new Date();
          timeoutUntil.setMinutes(timeoutUntil.getMinutes() + duration.minutes);
          
          users[userIndex].timeoutUntil = timeoutUntil.toISOString();
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
          if (currentUser && currentUser.id === userId) {
            localStorage.removeItem('currentUser');
          }

          showPanelMessage('staff-message', `User timed out for ${duration.label}.`, 'success');
          loadStaffPanel();
        }
      });
    }

    function blacklistUser(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('staff-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Blacklist User',
        message: `Blacklist ${target.email}? This will block all access.`,
        confirmText: 'Blacklist',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].blacklisted = true;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showUniversalBanMessage();

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
          if (currentUser && currentUser.id === userId) {
            localStorage.removeItem('currentUser');
          }

          showPanelMessage('staff-message', 'User permanently blacklisted.', 'success');
          loadStaffPanel();
        }
      });
    }

    function restoreUser(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('staff-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Restore Access',
        message: `Restore access for ${target.email}?`,
        confirmText: 'Restore',
        onConfirm: () => {
          users[userIndex].blacklisted = false;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showPanelMessage('staff-message', 'User access restored.', 'success');
          loadStaffPanel();
        }
      });
    }

    function toggleStaff(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('staff-message', 'User not found.', 'error');
        return;
      }

      const isCurrentlyStaff = users[userIndex].isStaff || false;

      const target = users[userIndex];
      openActionModal({
        title: isCurrentlyStaff ? 'Revoke Staff' : 'Grant Staff',
        message: isCurrentlyStaff
          ? `Revoke staff privileges from ${target.email}?`
          : `Grant staff privileges to ${target.email}?`,
        confirmText: isCurrentlyStaff ? 'Revoke' : 'Grant',
        confirmClass: isCurrentlyStaff ? 'danger' : '',
        onConfirm: () => {
          users[userIndex].isStaff = !isCurrentlyStaff;
          localStorage.setItem('users', JSON.stringify(users));

          showPanelMessage(
            'staff-message',
            isCurrentlyStaff ? 'Staff privileges revoked.' : 'Staff privileges granted.',
            'success'
          );
          loadStaffPanel();
        }
      });
    }

    function openSignupModal() {
      showToast('Signup is disabled on this site.', 'info');
    }

    function openLoginModal() {
      showToast('Login is disabled on this site.', 'info');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
      }
    }

    function switchToSignup() {
      showToast('Signup is disabled on this site.', 'info');
    }

    function switchToLogin() {
      showToast('Login is disabled on this site.', 'info');
    }

    async function handleSignup() {
      showToast('Signup is disabled on this site.', 'info');
    }

    async function handleLogin() {
      showToast('Login is disabled on this site.', 'info');
    }

    function logout() {
      showToast('Login is disabled on this site.', 'info');
    }

    // ===== WALLET/FUNDS FUNCTIONS =====
    function openAddFundsModal() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) {
        showToast('Please log in to add funds', 'error');
        return;
      }
      
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === currentUser.id || u.email === currentUser.email);
      const balance = user?.balance || 0;
      
      document.getElementById('currentBalance').textContent = balance.toFixed(2);
      document.getElementById('fundsAmount').value = '';
      document.getElementById('fundsError').textContent = '';
      document.getElementById('addFundsModal').classList.add('active');
    }

    function closeAddFundsModal() {
      document.getElementById('addFundsModal').classList.remove('active');
    }

    function setFundsAmount(amount) {
      document.getElementById('fundsAmount').value = amount.toFixed(2);
    }

    async function completeFundsTransaction() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) {
        showToast('Please log in first', 'error');
        return;
      }

      const amountInput = document.getElementById('fundsAmount');
      const amount = parseFloat(amountInput.value);
      const errorDiv = document.getElementById('fundsError');

      // Validate amount
      if (!amount || amount < 0.50) {
        errorDiv.textContent = ' Minimum amount is $0.50';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        amountInput.focus();
        return;
      }

      if (amount > 5000) {
        errorDiv.textContent = ' Maximum amount per transaction is $5000';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        amountInput.focus();
        return;
      }

      // Validate credit card fields
      const cardName = document.getElementById('fundsCardName').value.trim();
      const cardNumber = document.getElementById('fundsCardNumber').value.replace(/\s/g, '');
      const cardExpiry = document.getElementById('fundsCardExpiry').value.trim();
      const cardCVV = document.getElementById('fundsCardCVV').value.trim();

      // Validate cardholder name
      if (!cardName) {
        errorDiv.textContent = ' Please enter cardholder name';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        document.getElementById('fundsCardName').focus();
        return;
      }

      // Validate card number
      if (!cardNumber || cardNumber.length < 13 || cardNumber.length > 19) {
        errorDiv.textContent = ' Please enter a valid card number';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        document.getElementById('fundsCardNumber').focus();
        return;
      }

      // Validate expiry date
      if (!cardExpiry || !cardExpiry.includes('/')) {
        errorDiv.textContent = ' Please enter expiry date in MM/YY format';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        document.getElementById('fundsCardExpiry').focus();
        return;
      }

      const [expMonth, expYear] = cardExpiry.split('/');
      if (!expMonth || !expYear || expMonth.length !== 2 || expYear.length !== 2) {
        errorDiv.textContent = ' Invalid expiry date format';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        document.getElementById('fundsCardExpiry').focus();
        return;
      }

      // Check if card is expired
      const currentYear = new Date().getFullYear() % 100;
      const currentMonth = new Date().getMonth() + 1;
      const expMonthNum = parseInt(expMonth);
      const expYearNum = parseInt(expYear);

      if (expYearNum < currentYear || (expYearNum === currentYear && expMonthNum < currentMonth)) {
        errorDiv.textContent = ' Card has expired';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        document.getElementById('fundsCardExpiry').focus();
        return;
      }

      // Validate CVV
      if (!cardCVV || cardCVV.length < 3 || cardCVV.length > 4) {
        errorDiv.textContent = ' Please enter a valid CVV (3-4 digits)';
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        document.getElementById('fundsCardCVV').focus();
        return;
      }

      try {
        // Show processing status
        errorDiv.textContent = ' Processing payment...';
        errorDiv.style.color = '#00d4ff';
        errorDiv.classList.add('show');

        // Simulate payment processing (in real system, this would call Stripe/PayPal API)
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Add funds to user (only if payment succeeds)
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const userIndex = users.findIndex(u => u.id === currentUser.id || u.email === currentUser.email);
        
        if (userIndex === -1) {
          throw new Error('User not found');
        }

        const user = users[userIndex];
        const previousBalance = user.balance || 0;
        user.balance = previousBalance + amount;
        users[userIndex] = user;
        localStorage.setItem('users', JSON.stringify(users));

        // Log transaction
        const fundsLog = JSON.parse(localStorage.getItem('fundsTransactions') || '[]');
        fundsLog.push({
          id: 'FUNDS_' + Date.now(),
          email: user.email,
          amount: amount,
          previousBalance: previousBalance,
          newBalance: user.balance,
          cardLast4: cardNumber.slice(-4),
          timestamp: new Date().toISOString(),
          status: 'completed'
        });
        localStorage.setItem('fundsTransactions', JSON.stringify(fundsLog));

        // Show success
        errorDiv.textContent = ` Payment processed! Added $${amount.toFixed(2)} to your wallet!`;
        errorDiv.style.color = '#00ff88';
        errorDiv.classList.add('show');

        console.log(` CHARGED: $${amount.toFixed(2)} to card ending in ${cardNumber.slice(-4)}`);
        console.log(`   Previous Balance: $${previousBalance.toFixed(2)}  New Balance: $${user.balance.toFixed(2)}`);

        // Refresh navbar to show new balance
        updateNavBar(currentUser);

        // Clear form
        document.getElementById('fundsCardName').value = '';
        document.getElementById('fundsCardNumber').value = '';
        document.getElementById('fundsCardExpiry').value = '';
        document.getElementById('fundsCardCVV').value = '';
        document.getElementById('fundsAmount').value = '';

        setTimeout(() => {
          closeAddFundsModal();
          showToast(`Wallet updated! New balance: $${user.balance.toFixed(2)}`, 'success');
        }, 1500);

      } catch (error) {
        errorDiv.textContent = ' ' + error.message;
        errorDiv.style.color = '#ff6b6b';
        errorDiv.classList.add('show');
        console.error('Funds error:', error);
      }
    }

    function getUserBalance() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) return 0;

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === currentUser.id || u.email === currentUser.email);
      return user?.balance || 0;
    }

    // ===== SIDEBAR MENU FUNCTIONS =====
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar-menu');
      const overlay = document.querySelector('.sidebar-overlay');
      const hamburger = document.querySelector('.hamburger-menu');
      
      if (sidebar && overlay) {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        
        // Hide hamburger when sidebar is open
        if (hamburger) {
          hamburger.classList.toggle('hidden');
        }
      }
    }

    // ===== ORDER HISTORY =====
    function openOrderHistory() {
      const modal = document.getElementById('orderHistoryModal');
      const content = document.getElementById('orderHistoryContent');
      
      if (!modal) return;

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      let userEmail = currentUser?.email || null;

      if (!userEmail) {
        content.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">Please log in to view order history.</p>';
      } else {
        const userOrders = paymentSystem.orders.filter(o => o.customer.email === userEmail);

        if (userOrders.length === 0) {
          content.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">No orders yet. Make your first purchase!</p>';
        } else {
          content.innerHTML = userOrders
            .reverse()
            .map(order => `
              <div class="transaction-item">
                <div class="transaction-info">
                  <div class="transaction-id">${order.id}</div>
                  <div class="transaction-product">${order.product.name}</div>
                  <div class="transaction-date">${new Date(order.timestamp).toLocaleString()}</div>
                  <div style="color: #aaa; font-size: 0.8rem; margin-top: 0.25rem;">Access Key: <span style="font-family: monospace; color: var(--accent);">${order.accessKey}</span></div>
                </div>
                <div class="transaction-status ${order.status}">${order.status}</div>
                <div class="transaction-amount">$${order.amount.toFixed(2)}</div>
              </div>
            `)
            .join('');
        }
      }

      modal.style.display = 'flex';
      toggleSidebar();
    }

    function closeOrderHistory() {
      document.getElementById('orderHistoryModal').style.display = 'none';
    }

    // ===== SUPPORT/TICKETS =====
    function openSupport() {
      const modal = document.getElementById('supportModal');
      loadTickets();
      updateTicketBadge();
      modal.style.display = 'flex';
      toggleSidebar(); // Close sidebar
    }

    function closeSupport() {
      document.getElementById('supportModal').style.display = 'none';
    }

    function switchSupportTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.modal-tab').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.getElementById('ticketsTab').classList.remove('active');
      document.getElementById('newTicketTab').classList.remove('active');
      document.getElementById('allTicketsTab').classList.remove('active');
      
      if (tab === 'tickets') {
        document.getElementById('ticketsTab').classList.add('active');
        loadTickets();
      } else if (tab === 'new') {
        document.getElementById('newTicketTab').classList.add('active');
      } else if (tab === 'all') {
        document.getElementById('allTicketsTab').classList.add('active');
        loadAllTickets();
      }
    }

    function loadTickets() {
      const ticketsList = document.getElementById('ticketsList');
      const userKey = JSON.parse(localStorage.getItem('userActiveKey') || 'null');
      const userEmail = userKey ? 'guest_' + Date.now() : null;
      
      const allTickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      const userTickets = userEmail ? allTickets.filter(t => t.userId === userEmail) : [];
      
      if (userTickets.length === 0) {
        ticketsList.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">No tickets yet.</p>';
        return;
      }
      
      let ticketsHTML = '';
      userTickets.forEach(ticket => {
        const date = new Date(ticket.date).toLocaleString();
        const messageCount = ticket.messages ? ticket.messages.length : 0;
        const lastMessage = ticket.messages && ticket.messages.length > 0 ? ticket.messages[ticket.messages.length - 1].text : '';
        ticketsHTML += `
          <div class="ticket-card" onclick="openTicketChat(${ticket.id})" style="cursor: pointer;">
            <div class="ticket-header">
              <div>
                <span class="ticket-status ${ticket.status}">${ticket.status.replace('-', ' ')}</span>
                <span class="ticket-priority ${ticket.priority}" style="margin-left: 0.5rem;">${ticket.priority}</span>
              </div>
              <small style="color: #888;">#${ticket.id}</small>
            </div>
            <h4 style="margin: 0 0 0.5rem 0;">${ticket.subject}</h4>
            <p style="color: #aaa; margin-bottom: 0.5rem; font-size: 0.9rem;">${lastMessage.substring(0, 80)}${lastMessage.length > 80 ? '...' : ''}</p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <small style="color: #666;">${date}</small>
              <small style="color: #a855f7;">${messageCount} message${messageCount !== 1 ? 's' : ''}</small>
            </div>
          </div>
        `;
      });
      
      ticketsList.innerHTML = ticketsHTML;
    }

    function loadAllTickets() {
      const allTicketsList = document.getElementById('allTicketsList');
      const allTickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      
      if (allTickets.length === 0) {
        allTicketsList.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">No tickets yet.</p>';
        return;
      }
      
      let ticketsHTML = '';
      allTickets.forEach(ticket => {
        const date = new Date(ticket.date).toLocaleString();
        const messageCount = ticket.messages ? ticket.messages.length : 0;
        const lastMessage = ticket.messages && ticket.messages.length > 0 ? ticket.messages[ticket.messages.length - 1].text : '';
        const unreadBadge = ticket.unreadStaff ? '<span style="background: #ff6b6b; color: #fff; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.75rem; margin-left: 0.5rem;">NEW</span>' : '';
        ticketsHTML += `
          <div class="ticket-card" onclick="openTicketChat(${ticket.id})" style="cursor: pointer;">
            <div class="ticket-header">
              <div>
                <span class="ticket-status ${ticket.status}">${ticket.status.replace('-', ' ')}</span>
                <span class="ticket-priority ${ticket.priority}" style="margin-left: 0.5rem;">${ticket.priority}</span>
                ${unreadBadge}
              </div>
              <small style="color: #888;">#${ticket.id}</small>
            </div>
            <h4 style="margin: 0 0 0.5rem 0;">${ticket.subject}</h4>
            <p style="color: #aaa; margin-bottom: 0.5rem; font-size: 0.9rem;">${lastMessage.substring(0, 80)}${lastMessage.length > 80 ? '...' : ''}</p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <small style="color: #666;">${date} - User: ${ticket.userId}</small>
              <small style="color: #a855f7;">${messageCount} message${messageCount !== 1 ? 's' : ''}</small>
            </div>
          </div>
        `;
      });
      
      allTicketsList.innerHTML = ticketsHTML;
      updateStaffTicketBadge();
    }

    function createTicket(event) {
      event.preventDefault();
      
      const subject = document.getElementById('ticketSubject').value;
      const priority = document.getElementById('ticketPriority').value;
      const message = document.getElementById('ticketMessage').value;
      
      const userId = 'guest_' + Date.now();
      
      const ticket = {
        id: Date.now(),
        userId: userId,
        subject: subject,
        priority: priority,
        status: 'open',
        date: Date.now(),
        messages: [
          {
            sender: 'user',
            senderName: 'You',
            text: message,
            timestamp: Date.now()
          }
        ],
        unreadStaff: true
      };
      
      const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      tickets.push(ticket);
      localStorage.setItem('tickets', JSON.stringify(tickets));
      
      // Notify staff panel holders
      notifyStaffPanelHolders(ticket);
      
      showToast('Ticket created successfully!', 'success');
      document.getElementById('newTicketForm').reset();
      switchSupportTab('tickets');
      loadTickets();
      updateTicketBadge();
    }

    function notifyStaffPanelHolders(ticket) {
      // This creates a notification marker for staff
      const staffNotifications = JSON.parse(localStorage.getItem('staffNotifications') || '[]');
      staffNotifications.push({
        type: 'new_ticket',
        ticketId: ticket.id,
        subject: ticket.subject,
        timestamp: Date.now()
      });
      localStorage.setItem('staffNotifications', JSON.stringify(staffNotifications));
    }

    function openTicketChat(ticketId) {
      const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      const ticket = tickets.find(t => t.id === ticketId);
      
      if (!ticket) {
        showToast('Ticket not found', 'error');
        return;
      }
      
      // Mark as read for staff
      const userKey = JSON.parse(localStorage.getItem('userActiveKey') || 'null');
      if (userKey && ['admin', 'moderator', 'custom'].includes(userKey.type)) {
        ticket.unreadStaff = false;
        const ticketIndex = tickets.findIndex(t => t.id === ticketId);
        tickets[ticketIndex] = ticket;
        localStorage.setItem('tickets', JSON.stringify(tickets));
      }
      
      document.getElementById('chatTicketId').textContent = ticket.id;
      document.getElementById('chatTicketSubject').textContent = ticket.subject;
      document.getElementById('chatTicketStatus').textContent = ticket.status.replace('-', ' ');
      document.getElementById('chatTicketStatus').className = 'ticket-status ' + ticket.status;
      document.getElementById('chatTicketPriority').textContent = ticket.priority;
      document.getElementById('chatTicketPriority').className = 'ticket-priority ' + ticket.priority;
      document.getElementById('chatTicketDate').textContent = new Date(ticket.date).toLocaleString();
      
      // Load messages
      loadTicketMessages(ticket);
      
      // Show close button if staff
      if (userKey && ['admin', 'moderator', 'custom'].includes(userKey.type)) {
        document.getElementById('ticketCloseSection').style.display = 'block';
      } else {
        document.getElementById('ticketCloseSection').style.display = 'none';
      }
      
      closeSupport();
      document.getElementById('ticketChatModal').classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Scroll to bottom
      setTimeout(() => {
        const container = document.getElementById('ticketMessagesContainer');
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function closeTicketChat() {
      document.getElementById('ticketChatModal').classList.remove('active');
      document.body.style.overflow = '';
      loadTickets();
      loadAllTickets();
    }

    function loadTicketMessages(ticket) {
      const container = document.getElementById('ticketMessagesContainer');
      let messagesHTML = '';
      
      if (ticket.messages && ticket.messages.length > 0) {
        ticket.messages.forEach(msg => {
          const time = new Date(msg.timestamp).toLocaleString();
          const isStaff = msg.sender === 'staff';
          const alignment = isStaff ? 'flex-start' : 'flex-end';
          const bgColor = isStaff ? '#a855f7' : '#0a0a0c';
          const textColor = isStaff ? '#000' : '#fff';
          
          messagesHTML += `
            <div style="display: flex; justify-content: ${alignment}; margin-bottom: 1rem;">
              <div style="max-width: 70%; background: ${bgColor}; color: ${textColor}; padding: 0.8rem 1rem; border-radius: 12px;">
                <div style="font-weight: 600; margin-bottom: 0.3rem; font-size: 0.85rem; opacity: 0.9;">${msg.senderName}</div>
                <div style="margin-bottom: 0.3rem;">${msg.text}</div>
                <div style="font-size: 0.75rem; opacity: 0.7;">${time}</div>
              </div>
            </div>
          `;
        });
      } else {
        messagesHTML = '<p style="text-align: center; color: #888;">No messages yet.</p>';
      }
      
      container.innerHTML = messagesHTML;
    }

    function sendTicketMessage(event) {
      event.preventDefault();
      
      const ticketId = parseInt(document.getElementById('chatTicketId').textContent);
      const messageText = document.getElementById('ticketReplyInput').value.trim();
      
      if (!messageText) return;
      
      const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      const ticketIndex = tickets.findIndex(t => t.id === ticketId);
      
      if (ticketIndex === -1) {
        showToast('Ticket not found', 'error');
        return;
      }
      
      const userKey = JSON.parse(localStorage.getItem('userActiveKey') || 'null');
      const isStaff = userKey && ['admin', 'moderator', 'custom'].includes(userKey.type);
      
      const message = {
        sender: isStaff ? 'staff' : 'user',
        senderName: isStaff ? 'Support Staff' : 'You',
        text: messageText,
        timestamp: Date.now()
      };
      
      if (!tickets[ticketIndex].messages) {
        tickets[ticketIndex].messages = [];
      }
      
      tickets[ticketIndex].messages.push(message);
      
      // Mark unread for staff if user sent message
      if (!isStaff) {
        tickets[ticketIndex].unreadStaff = true;
      }
      
      localStorage.setItem('tickets', JSON.stringify(tickets));
      
      document.getElementById('ticketReplyInput').value = '';
      loadTicketMessages(tickets[ticketIndex]);
      
      // Scroll to bottom
      setTimeout(() => {
        const container = document.getElementById('ticketMessagesContainer');
        container.scrollTop = container.scrollHeight;
      }, 100);
      
      showToast('Message sent', 'success');
    }

    function closeTicketByStaff() {
      const ticketId = parseInt(document.getElementById('chatTicketId').textContent);
      const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      const ticketIndex = tickets.findIndex(t => t.id === ticketId);
      
      if (ticketIndex === -1) return;
      
      tickets[ticketIndex].status = 'closed';
      localStorage.setItem('tickets', JSON.stringify(tickets));
      
      showToast('Ticket closed', 'success');
      closeTicketChat();
    }

    function updateStaffTicketBadge() {
      const userKey = JSON.parse(localStorage.getItem('userActiveKey') || 'null');
      if (!userKey || !['admin', 'moderator', 'custom'].includes(userKey.type)) return;
      
      const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      const unreadCount = tickets.filter(t => t.unreadStaff && t.status !== 'closed').length;
      
      const badge = document.getElementById('staffTicketBadge');
      if (badge && unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'inline-block';
      } else if (badge) {
        badge.style.display = 'none';
      }
    }

    function updateTicketBadge() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) return;
      
      const allTickets = JSON.parse(localStorage.getItem('tickets') || '[]');
      const openTickets = allTickets.filter(t => t.userId === currentUser.email && t.status === 'open').length;
      
      const badge = document.getElementById('ticketBadge');
      if (badge) {
        if (openTickets > 0) {
          badge.textContent = openTickets;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // ===== SETTINGS =====
    function openSettings() {
      // Open settings in new tab
      window.open('settings.html', '_blank');
      toggleSidebar(); // Close sidebar
    }

    // Update navigation bar based on auth state
    function updateNavBar(user) {
      return;
    }

    // ====== STRIPE PAYMENT INTERFACE ======

    let stripeCardElement = null;
    let stripeElements = null;

    function initializeStripeElements() {
      if (!stripe) {
        showToast('Stripe not configured. Add your API keys first.', 'error');
        return false;
      }

      try {
        if (!stripeElements) {
          stripeElements = stripe.elements();
          stripeCardElement = stripeElements.create('card', {
            style: {
              base: {
                color: '#fff',
                fontFamily: 'Sora, sans-serif',
                fontSize: '16px',
                '::placeholder': {
                  color: '#888'
                }
              },
              invalid: {
                color: '#ff6b6b'
              }
            }
          });
        }
        return true;
      } catch (error) {
        console.error('Stripe elements error:', error);
        return false;
      }
    }

    function openStripePaymentModal(amount, productName) {
      if (!initializeStripePayment()) {
        showToast('Stripe payment not available. Configure API keys first.', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.id = 'stripePaymentModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      const content = document.createElement('div');
      content.style.cssText = `
        background: #1a1a2e;
        border: 2px solid #00d4ff;
        border-radius: 12px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
      `;

      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="color: #00d4ff; margin: 0;"> Stripe Payment</h2>
          <button onclick="document.getElementById('stripePaymentModal').remove();" style="background: none; border: none; color: #00d4ff; font-size: 24px; cursor: pointer;"></button>
        </div>

        <div style="background: #0f3460; border-radius: 6px; padding: 12px; margin-bottom: 20px;">
          <div style="color: #888; font-size: 12px;">Amount to Charge</div>
          <div style="color: #00ff88; font-size: 24px; font-weight: bold;">$${amount.toFixed(2)}</div>
          <div style="color: #888; font-size: 12px; margin-top: 4px;">${productName}</div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="color: #ccc; display: block; margin-bottom: 8px; font-size: 14px;">Card Details</label>
          <div id="stripe-card-element" style="background: #0f3460; border: 1px solid #00d4ff; border-radius: 6px; padding: 12px;"></div>
          <div id="stripe-card-errors" style="color: #ff6b6b; margin-top: 8px; font-size: 12px;"></div>
        </div>

        <button onclick="processStripePayment('${amount}', '${productName}');" style="width: 100%; padding: 12px; background: #00d4ff; color: #000; border: none; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer; margin-bottom: 10px;">
          Pay $${amount.toFixed(2)} with Stripe
        </button>

        <button onclick="document.getElementById('stripePaymentModal').remove();" style="width: 100%; padding: 12px; background: #16213e; color: #00d4ff; border: 1px solid #00d4ff; border-radius: 6px; font-weight: bold; cursor: pointer;">
          Cancel
        </button>

        <div style="color: #888; font-size: 11px; margin-top: 15px; text-align: center;">
          Test Card: 4242 4242 4242 4242 | Any Future Date | Any CVC
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      // Mount Stripe card element
      setTimeout(() => {
        if (stripeCardElement && document.getElementById('stripe-card-element')) {
          stripeCardElement.mount('#stripe-card-element');
          stripeCardElement.addEventListener('change', (event) => {
            const displayError = document.getElementById('stripe-card-errors');
            if (event.error) {
              displayError.textContent = event.error.message;
            } else {
              displayError.textContent = '';
            }
          });
        }
      }, 100);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    function initializeStripePayment() {
      if (!stripe) {
        stripe = initializeStripe();
      }
      return initializeStripeElements();
    }

    async function processStripePayment(amount, productName) {
      const errorDiv = document.getElementById('stripe-card-errors');
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));

      if (!currentUser) {
        errorDiv.textContent = 'Please log in first';
        return;
      }

      errorDiv.textContent = ' Processing...';

      try {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const user = users.find(u => u.id === currentUser.id || u.email === currentUser.email);

        const transaction = {
          id: paymentSystem.generateTransactionId(),
          orderId: paymentSystem.generateOrderId(),
          timestamp: new Date().toISOString(),
          amount: parseFloat(amount),
          currency: 'USD',
          method: 'stripe',
          status: 'processing',
          isReal: true,
          customer: {
            email: user.email,
            name: user.name
          },
          product: { label: productName }
        };

        // Process via Stripe
        const result = await paymentSystem.processStripePayment(transaction, stripeCardElement);

        if (result.success) {
          errorDiv.textContent = ' Payment successful!';
          errorDiv.style.color = '#00ff88';

          // Deduct from balance (demo - in production, webhook handles this)
          const userIndex = users.findIndex(u => u.id === user.id);
          user.balance = (user.balance || 0) - parseFloat(amount);
          users[userIndex] = user;
          localStorage.setItem('users', JSON.stringify(users));

          // Add to owner earnings
          const currentOwnerBalance = parseFloat(localStorage.getItem('ownerBalance') || '0');
          const newOwnerBalance = currentOwnerBalance + parseFloat(amount);
          localStorage.setItem('ownerBalance', newOwnerBalance.toString());

          updateNavBar(currentUser);

          setTimeout(() => {
            document.getElementById('stripePaymentModal').remove();
            showToast(' Payment processed successfully!', 'success');
          }, 1500);
        }
      } catch (error) {
        errorDiv.textContent = ' ' + error.message;
        errorDiv.style.color = '#ff6b6b';
      }
    }

    // ====== OWNER EARNINGS DASHBOARD ======

    function getOwnerBalance() {
      return parseFloat(localStorage.getItem('ownerBalance') || '0');
    }

    function openEarningsDashboard() {
      const modal = document.createElement('div');
      modal.id = 'earningsDashboardModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      const content = document.createElement('div');
      content.style.cssText = `
        background: #1a1a2e;
        border: 2px solid #00d4ff;
        border-radius: 12px;
        padding: 30px;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
      `;

      const ownerBalance = getOwnerBalance();
      const earnings = JSON.parse(localStorage.getItem('ownerEarnings') || '[]');
      
      let earningsHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h2 style="color: #00ff88; margin: 0; font-size: 24px;"> Owner Earnings Dashboard</h2>
        </div>

        <div style="background: #16213e; border: 1px solid #00d4ff; border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <div style="color: #888; font-size: 14px; margin-bottom: 5px;">Total Earnings</div>
          <div style="color: #00ff88; font-size: 36px; font-weight: bold;">$${ownerBalance.toFixed(2)}</div>
          <div style="color: #888; font-size: 12px; margin-top: 8px;">${earnings.length} transactions</div>
        </div>
      `;

      if (earnings.length === 0) {
        earningsHTML += `
          <div style="text-align: center; color: #888; padding: 20px;">
            <p>No earnings yet. Earnings will appear here when customers make purchases.</p>
          </div>
        `;
      } else {
        earningsHTML += `
          <div style="margin-bottom: 20px;">
            <h3 style="color: #00d4ff; margin-top: 0;">Recent Transactions</h3>
            <div style="background: #0f3460; border-radius: 8px; overflow: hidden;">
        `;

        earnings.slice().reverse().slice(0, 10).forEach((earning, idx) => {
          const date = new Date(earning.timestamp).toLocaleDateString();
          earningsHTML += `
            <div style="padding: 12px; border-bottom: 1px solid #16213e; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="color: #fff; font-weight: bold;">+$${earning.amount.toFixed(2)}</div>
                <div style="color: #888; font-size: 12px;">${earning.customerName}</div>
                <div style="color: #666; font-size: 11px;">${earning.product}</div>
              </div>
              <div style="text-align: right;">
                <div style="color: #888; font-size: 12px;">${date}</div>
              </div>
            </div>
          `;
        });

        earningsHTML += `
            </div>
          </div>
        `;
      }

      earningsHTML += `
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button onclick="document.getElementById('earningsDashboardModal').remove();" style="flex: 1; padding: 10px; background: #00d4ff; color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Close</button>
          <button onclick="openWithdrawalModal();" style="flex: 1; padding: 10px; background: #00ff88; color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Withdrawal Info</button>
        </div>
      `;

      content.innerHTML = earningsHTML;
      modal.appendChild(content);
      document.body.appendChild(modal);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    function openWithdrawalModal() {
      const ownerBalance = getOwnerBalance();
      const modal = document.createElement('div');
      modal.id = 'withdrawalModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
      `;

      const content = document.createElement('div');
      content.style.cssText = `
        background: #1a1a2e;
        border: 2px solid #00ff88;
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 255, 136, 0.2);
      `;

      content.innerHTML = `
        <h2 style="color: #00ff88; margin-top: 0;"> Withdrawal & Payout Info</h2>
        
        <div style="background: #0f3460; border-left: 4px solid #00ff88; padding: 15px; margin: 15px 0; border-radius: 4px;">
          <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Available Balance</div>
          <div style="color: #00ff88; font-size: 28px; font-weight: bold;">$${ownerBalance.toFixed(2)}</div>
        </div>

        <h3 style="color: #00d4ff; margin-top: 20px;">How to Get Your Money:</h3>
        <ol style="color: #ccc; line-height: 1.8;">
          <li><strong>Set up a payment processor</strong> (Stripe, PayPal, Square) when you turn 18</li>
          <li><strong>Connect your bank account</strong> to receive payouts</li>
          <li><strong>Verify your identity</strong> with the payment processor</li>
          <li><strong>Withdraw your earnings</strong> to your bank account</li>
        </ol>

        <div style="background: #16213e; border: 1px solid #ffa500; padding: 12px; margin-top: 15px; border-radius: 6px; color: #ffa500; font-size: 12px;">
           <strong>Note:</strong> Since you're 14, you'll need to wait until you're 18 to set up a payment processor and withdraw real money. For now, this shows you how much you would earn!
        </div>

        <button onclick="document.getElementById('withdrawalModal').remove(); openEarningsDashboard();" style="width: 100%; padding: 12px; margin-top: 20px; background: #00d4ff; color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Back to Earnings</button>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          openEarningsDashboard();
        }
      });
    }

    // ====== HEAD STAFF PANEL FUNCTIONS ======

    function openHeadStaffPanel() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) {
        showToast('Access denied. Head Staff privileges required.', 'error');
        return;
      }

      const flags = getCurrentUserFlags();
      if (!flags.isHeadStaff) {
        showToast('Access denied. Head Staff privileges required.', 'error');
        return;
      }

      document.getElementById('headStaffPanel').classList.add('active');
      loadHeadStaffPanel();
    }

    function closeHeadStaffPanel() {
      document.getElementById('headStaffPanel').classList.remove('active');
    }

    function loadHeadStaffPanel() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const now = new Date();

      // Calculate stats
      const totalUsers = users.length;
      const activeUsers = users.filter(u => !u.blacklisted && (!u.timeoutUntil || new Date(u.timeoutUntil) <= now)).length;
      const blacklisted = users.filter(u => u.blacklisted).length;
      const timedOut = users.filter(u => u.timeoutUntil && new Date(u.timeoutUntil) > now).length;

      document.getElementById('head-stat-total-users').textContent = totalUsers;
      document.getElementById('head-stat-active-users').textContent = activeUsers;
      document.getElementById('head-stat-blacklisted').textContent = blacklisted;
      document.getElementById('head-stat-timed-out').textContent = timedOut;

      // Load users list
      const container = document.getElementById('head-users-container');
      container.innerHTML = '';

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No users registered yet.</p>';
        return;
      }

      users.forEach(user => {
        const isBlacklisted = user.blacklisted || false;
        const isTimedOut = user.timeoutUntil && new Date(user.timeoutUntil) > now;
        const isStaff = user.isStaff || false;
        const isHeadStaff = user.isHeadStaff || false;
        const isDev = user.isDev || false;
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const isSelf = user.id === currentUser.id;

        let statusClass = '';
        if (isBlacklisted) statusClass = 'blacklisted';
        else if (isTimedOut) statusClass = 'timed-out';

        let timeoutInfo = '';
        if (isTimedOut) {
          const timeLeft = Math.ceil((new Date(user.timeoutUntil) - now) / 60000);
          timeoutInfo = `<p><i class="fas fa-clock"></i> Timeout expires in ${timeLeft} minutes</p>`;
        }

        const userDiv = document.createElement('div');
        userDiv.className = `user-item ${statusClass}`;
        userDiv.innerHTML = `
          <div class="user-info">
            <div class="user-details">
              <h4><i class="fas fa-user"></i> ${sanitizeInput(user.name || 'User')}</h4>
              <p><i class="fas fa-envelope"></i> ${sanitizeInput(user.email)}</p>
              <p><i class="fas fa-calendar"></i> Joined: ${new Date(user.createdAt).toLocaleDateString()}</p>
              ${timeoutInfo}
              <div class="user-badges">
                ${isDev ? '<span class="badge badge-dev"><i class="fas fa-code"></i> DEVELOPER</span>' : ''}
                ${isHeadStaff ? '<span class="badge badge-head-staff"><i class="fas fa-crown"></i> HEAD STAFF</span>' : ''}
                ${isStaff ? '<span class="badge badge-staff"><i class="fas fa-shield-alt"></i> STAFF</span>' : ''}
                ${isBlacklisted ? '<span class="badge badge-blacklisted"><i class="fas fa-ban"></i> BLACKLISTED</span>' : ''}
                ${isTimedOut ? '<span class="badge badge-timeout"><i class="fas fa-clock"></i> TIMED OUT</span>' : ''}
              </div>
            </div>
            <div class="user-actions">
              ${!isSelf && !isStaff && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-staff" onclick="makeStaffFromHead(${user.id})">Make Staff</button>` : ''}
              ${!isSelf && !isTimedOut && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-timeout" onclick="timeoutUserFromHead(${user.id})"><i class="fas fa-clock"></i> Timeout</button>` : ''}
              ${!isSelf && !isBlacklisted && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-blacklist" onclick="blacklistUserFromHead(${user.id})"><i class="fas fa-ban"></i> Blacklist</button>` : ''}
              ${!isSelf && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-request" onclick="openBanRequestModalById(${user.id}, 'head-staff-message')"><i class="fas fa-flag"></i> Ban Request</button>` : ''}
              ${!isSelf && (isBlacklisted || isTimedOut) && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-restore" onclick="restoreUserFromHead(${user.id})"><i class="fas fa-undo"></i> Restore Access</button>` : ''}
              ${isSelf ? '<span style="color: #888; font-size: 0.85rem;"><i class="fas fa-info-circle"></i> You (cannot modify)</span>' : ''}
            </div>
          </div>
        `;
        container.appendChild(userDiv);
      });
    }

    function apiBanFromHead() {
      const emailInput = document.getElementById('head-api-email');
      const email = emailInput ? emailInput.value.trim().toLowerCase() : '';
      if (!email) {
        showPanelMessage('head-staff-message', 'Please enter an email address.', 'error');
        return;
      }

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.email === email);

      if (!user) {
        showPanelMessage('head-staff-message', 'User not found.', 'error');
        return;
      }

      if (user.isDev) {
        showPanelMessage('head-staff-message', 'Cannot API ban developer accounts.', 'error');
        return;
      }

      const apiBans = JSON.parse(localStorage.getItem('apiBans') || '[]');
      if (apiBans.includes(email)) {
        showPanelMessage('head-staff-message', 'This user is already API banned.', 'error');
        return;
      }

      openActionModal({
        title: 'Ban API Access',
        message: `Ban API access for ${email}?`,
        confirmText: 'Ban',
        confirmClass: 'danger',
        onConfirm: () => {
          apiBans.push(email);
          localStorage.setItem('apiBans', JSON.stringify(apiBans));

          showUniversalBanMessage();
          if (emailInput) emailInput.value = '';
          showPanelMessage('head-staff-message', 'User API banned.', 'success');
          renderApiBansForHead();
        }
      });
    }

    function viewAPIBansFromHead() {
      const container = document.getElementById('head-api-bans');
      if (!container) return;

      const isHidden = container.style.display === 'none' || container.style.display === '';
      container.style.display = isHidden ? 'block' : 'none';
      if (isHidden) {
        renderApiBansForHead();
      }
    }

    function renderApiBansForHead() {
      const container = document.getElementById('head-api-bans');
      if (!container) return;

      const apiBans = JSON.parse(localStorage.getItem('apiBans') || '[]');
      container.innerHTML = '';

      if (apiBans.length === 0) {
        container.innerHTML = '<p style="color: #888;">No API bans.</p>';
        return;
      }

      apiBans.forEach(email => {
        const row = document.createElement('div');
        row.className = 'ban-item';
        row.innerHTML = `
          <span>${sanitizeInput(email)}</span>
          <button type="button" onclick="unbanApi('${email}')">Unban</button>
        `;
        container.appendChild(row);
      });
    }

    function makeStaffFromHead(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('head-staff-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Promote to Staff',
        message: `Promote ${target.email} to Staff?`,
        confirmText: 'Promote',
        onConfirm: () => {
          users[userIndex].isStaff = true;
          localStorage.setItem('users', JSON.stringify(users));

          showPanelMessage('head-staff-message', 'User promoted to Staff.', 'success');
          loadHeadStaffPanel();
        }
      });
    }

    function timeoutUserFromHead(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('head-staff-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      const duration = { minutes: 30, label: '30 minutes' };

      openActionModal({
        title: 'Timeout User',
        message: `Timeout ${target.email} for ${duration.label}?`,
        confirmText: 'Timeout',
        confirmClass: 'warning',
        onConfirm: () => {
          const timeoutUntil = new Date();
          timeoutUntil.setMinutes(timeoutUntil.getMinutes() + duration.minutes);
          
          users[userIndex].timeoutUntil = timeoutUntil.toISOString();
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
          if (currentUser && currentUser.id === userId) {
            localStorage.removeItem('currentUser');
          }

          showPanelMessage('head-staff-message', `User timed out for ${duration.label}.`, 'success');
          loadHeadStaffPanel();
        }
      });
    }

    function blacklistUserFromHead(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('head-staff-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Blacklist User',
        message: `Blacklist ${target.email}? This will block all access.`,
        confirmText: 'Blacklist',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].blacklisted = true;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showUniversalBanMessage();

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
          if (currentUser && currentUser.id === userId) {
            localStorage.removeItem('currentUser');
          }

          showPanelMessage('head-staff-message', 'User permanently blacklisted.', 'success');
          loadHeadStaffPanel();
        }
      });
    }

    function restoreUserFromHead(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('head-staff-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Restore Access',
        message: `Restore access for ${target.email}?`,
        confirmText: 'Restore',
        onConfirm: () => {
          users[userIndex].blacklisted = false;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showPanelMessage('head-staff-message', 'User access restored.', 'success');
          loadHeadStaffPanel();
        }
      });
    }


    // ====== DEV PANEL FUNCTIONS ======

    function checkMaintenanceMode() {
      const maintenanceMode = localStorage.getItem('maintenanceMode') === 'true';
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      
      if (maintenanceMode) {
        // Check if user is developer
        if (currentUser) {
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const user = users.find(u => u.id === currentUser.id);
          if (user && user.isDev) {
            // Developer can bypass maintenance mode
            document.getElementById('maintenanceOverlay').classList.remove('active');
            return;
          }
        }
        
        // Show maintenance mode for everyone else
        document.getElementById('maintenanceOverlay').classList.add('active');
      } else {
        document.getElementById('maintenanceOverlay').classList.remove('active');
      }
    }

    function openDevPanel() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) {
        showToast('Access denied. Developer privileges required.', 'error');
        return;
      }

      const flags = getCurrentUserFlags();
      if (!flags.isDev) {
        showToast('Access denied. Developer privileges required.', 'error');
        return;
      }

      document.getElementById('devPanel').classList.add('active');
      loadDevPanel();
      markAllDevNotificationsRead();
    }

    function closeDevPanel() {
      document.getElementById('devPanel').classList.remove('active');
    }

    function loadDevPanel() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const ipBans = JSON.parse(localStorage.getItem('ipBans') || '[]');
      const apiBans = JSON.parse(localStorage.getItem('apiBans') || '[]');
      const priceLimits = JSON.parse(localStorage.getItem('priceLimits') || '{"min":1,"max":10000}');

      // Update analytics
      const totalUsers = users.length;
      const staffCount = users.filter(u => u.isStaff || u.isDev).length;
      const bannedCount = users.filter(u => u.blacklisted).length;
      const now = new Date();
      const activeUsers = users.filter(u => !u.blacklisted && (!u.timeoutUntil || new Date(u.timeoutUntil) <= now)).length;

      // Update overview
      document.getElementById('overview-total-users').textContent = totalUsers;
      document.getElementById('overview-active-users').textContent = activeUsers;
      document.getElementById('overview-staff-count').textContent = staffCount;
      document.getElementById('overview-banned-count').textContent = bannedCount;

      // Update user overview list
      const overviewContainer = document.getElementById('dev-user-overview');
      overviewContainer.innerHTML = '';
      users.forEach(user => {
        const item = document.createElement('div');
        item.style.padding = '0.75rem';
        item.style.borderBottom = '1px solid var(--border)';
        item.style.fontSize = '0.9rem';
        item.innerHTML = `
          <strong>${sanitizeInput(user.name)}</strong> - ${sanitizeInput(user.email)}
          ${user.isDev ? '<span style="color: #ff0080; margin-left: 0.5rem;"><i class="fas fa-code"></i> Dev</span>' : ''}
          ${user.isHeadStaff ? '<span style="color: #dc2626; margin-left: 0.5rem;"><i class="fas fa-crown"></i> Head Staff</span>' : ''}
          ${user.isStaff ? '<span style="color: #a855f7; margin-left: 0.5rem;"><i class="fas fa-shield-alt"></i> Staff</span>' : ''}
          ${user.blacklisted ? '<span style="color: #ff6b6b; margin-left: 0.5rem;"><i class="fas fa-ban"></i> Banned</span>' : ''}
        `;
        overviewContainer.appendChild(item);
      });

      // Update ban counts
      document.getElementById('ipBanCount').textContent = ipBans.length;
      document.getElementById('apiBanCount').textContent = apiBans.length;

      // Update price inputs
      const devMinPrice = document.getElementById('dev-min-price');
      if (devMinPrice) devMinPrice.value = priceLimits.min;
      const devMaxPrice = document.getElementById('dev-max-price');
      if (devMaxPrice) devMaxPrice.value = priceLimits.max;

      // Update maintenance button
      const maintenanceMode = localStorage.getItem('maintenanceMode') === 'true';
      const maintenanceText = document.getElementById('maintenanceText');
      if (maintenanceText) {
        maintenanceText.textContent = maintenanceMode ? 'Disable Maintenance' : 'Enable Maintenance';
      }

      renderIpBans();
      renderApiBans();

      // Load moderation list
      loadDevUserModerationList();

      // Load permissions list
      loadDevPermissionsList();

      // Load ban requests
      renderBanRequests();
    }

    function loadDevUserModerationList() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const now = new Date();
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      const container = document.getElementById('dev-users-container');
      container.innerHTML = '';

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No users registered yet.</p>';
        return;
      }

      users.forEach(user => {
        const isBlacklisted = user.blacklisted || false;
        const isTimedOut = user.timeoutUntil && new Date(user.timeoutUntil) > now;
        const isHeadStaff = user.isHeadStaff || false;
        const isDev = user.isDev || false;
        const isSelf = currentUser && user.id === currentUser.id;

        let statusClass = '';
        if (isBlacklisted) statusClass = 'blacklisted';
        else if (isTimedOut) statusClass = 'timed-out';

        let timeoutInfo = '';
        if (isTimedOut) {
          const timeLeft = Math.ceil((new Date(user.timeoutUntil) - now) / 60000);
          timeoutInfo = `<p><i class="fas fa-clock"></i> Timeout expires in ${timeLeft} minutes</p>`;
        }

        const userDiv = document.createElement('div');
        userDiv.className = `user-item ${statusClass}`;
        userDiv.innerHTML = `
          <div class="user-info">
            <div class="user-details">
              <h4><i class="fas fa-user"></i> ${sanitizeInput(user.name || 'User')}</h4>
              <p><i class="fas fa-envelope"></i> ${sanitizeInput(user.email)}</p>
              <p><i class="fas fa-calendar"></i> Joined: ${new Date(user.createdAt).toLocaleDateString()}</p>
              ${timeoutInfo}
              <div class="user-badges">
                ${isDev ? '<span class="badge badge-dev"><i class="fas fa-code"></i> DEVELOPER</span>' : ''}
                ${isHeadStaff ? '<span class="badge badge-head-staff"><i class="fas fa-crown"></i> HEAD STAFF</span>' : ''}
                ${user.isStaff ? '<span class="badge badge-staff"><i class="fas fa-shield-alt"></i> STAFF</span>' : ''}
                ${isBlacklisted ? '<span class="badge badge-blacklisted"><i class="fas fa-ban"></i> BLACKLISTED</span>' : ''}
                ${isTimedOut ? '<span class="badge badge-timeout"><i class="fas fa-clock"></i> TIMED OUT</span>' : ''}
              </div>
            </div>
            <div class="user-actions">
              ${!isSelf && !isDev && !isTimedOut ? `<button class="action-btn action-btn-timeout" onclick="timeoutUserFromDev(${user.id})"><i class="fas fa-clock"></i> Timeout</button>` : ''}
              ${!isSelf && !isDev && !isBlacklisted ? `<button class="action-btn action-btn-blacklist" onclick="blacklistUserFromDev(${user.id})"><i class="fas fa-ban"></i> Blacklist</button>` : ''}
              ${!isSelf && (isBlacklisted || isTimedOut) ? `<button class="action-btn action-btn-restore" onclick="restoreUserFromDev(${user.id})"><i class="fas fa-undo"></i> Restore Access</button>` : ''}
              ${isSelf ? '<span style="color: #888; font-size: 0.85rem;"><i class="fas fa-info-circle"></i> You (cannot modify)</span>' : ''}
            </div>
          </div>
        `;
        container.appendChild(userDiv);
      });
    }

    function renderIpBans() {
      const container = document.getElementById('dev-ip-bans');
      if (!container) return;

      const ipBans = JSON.parse(localStorage.getItem('ipBans') || '[]');
      container.innerHTML = '';

      if (ipBans.length === 0) {
        container.innerHTML = '<p style="color: #888;">No IP bans.</p>';
        return;
      }

      ipBans.forEach(ip => {
        const row = document.createElement('div');
        row.className = 'ban-item';
        row.innerHTML = `
          <span>${sanitizeInput(ip)}</span>
          <button type="button" onclick="unbanIp('${ip}')">Unban</button>
        `;
        container.appendChild(row);
      });
    }

    function renderApiBans() {
      const container = document.getElementById('dev-api-bans');
      if (!container) return;

      const apiBans = JSON.parse(localStorage.getItem('apiBans') || '[]');
      container.innerHTML = '';

      if (apiBans.length === 0) {
        container.innerHTML = '<p style="color: #888;">No API bans.</p>';
        return;
      }

      apiBans.forEach(email => {
        const row = document.createElement('div');
        row.className = 'ban-item';
        row.innerHTML = `
          <span>${sanitizeInput(email)}</span>
          <button type="button" onclick="unbanApi('${email}')">Unban</button>
        `;
        container.appendChild(row);
      });
    }

    function renderBanRequests() {
      const container = document.getElementById('dev-ban-requests');
      if (!container) return;

      const requests = JSON.parse(localStorage.getItem('banRequests') || '[]');
      container.innerHTML = '';

      if (requests.length === 0) {
        container.innerHTML = '<p style="color: #888;">No ban requests.</p>';
        return;
      }

      requests.forEach(request => {
        const isFocused = focusedBanRequestId && request.id === focusedBanRequestId;
        const status = request.status || 'pending';
        const statusLabel = status === 'approved'
          ? 'Approved'
          : status === 'denied'
            ? 'Denied'
            : 'Pending';

        const item = document.createElement('div');
        item.className = `request-item${isFocused ? ' highlight' : ''}`;
        item.dataset.requestId = request.id;
        item.innerHTML = `
          <strong>${sanitizeInput(request.targetEmail)}</strong>
          <div class="request-meta">Requested by ${sanitizeInput(request.requestedByName || 'User')}  ${new Date(request.createdAt).toLocaleString()}  ${statusLabel}</div>
          <div>${sanitizeInput(request.reason)}</div>
          <div class="request-actions">
            ${status === 'pending' ? `
              <button type="button" class="approve-btn" onclick="approveBanRequest(${request.id})">Approve</button>
              <button type="button" class="deny-btn" onclick="denyBanRequest(${request.id})">Deny</button>
            ` : ''}
          </div>
        `;
        container.appendChild(item);
      });

      if (focusedBanRequestId) {
        const focusedItem = container.querySelector(`[data-request-id="${focusedBanRequestId}"]`);
        if (focusedItem) {
          focusedItem.scrollIntoView({ behavior: 'smooth', block: 'start' });
          setTimeout(() => {
            focusedItem.classList.remove('highlight');
          }, 2500);
        } else {
          showPanelMessage('dev-message', 'Ban request not found for that notification.', 'info');
        }
        focusedBanRequestId = null;
      }
    }

    function approveBanRequest(requestId) {
      const requests = JSON.parse(localStorage.getItem('banRequests') || '[]');
      const requestIndex = requests.findIndex(r => r.id === requestId);
      if (requestIndex === -1) {
        showPanelMessage('dev-message', 'Ban request not found.', 'error');
        return;
      }

      const request = requests[requestIndex];
      openActionModal({
        title: 'Approve Ban Request',
        message: `Blacklist ${request.targetEmail}?`,
        confirmText: 'Approve',
        confirmClass: 'danger',
        onConfirm: () => {
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const userIndex = users.findIndex(u => u.id === request.targetUserId || u.email === request.targetEmail);
          if (userIndex === -1) {
            showPanelMessage('dev-message', 'Target user not found.', 'error');
            return;
          }

          users[userIndex].blacklisted = true;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showUniversalBanMessage();

          requests[requestIndex].status = 'approved';
          requests[requestIndex].resolvedAt = new Date().toISOString();
          localStorage.setItem('banRequests', JSON.stringify(requests));

          showPanelMessage('dev-message', 'Ban request approved and user blacklisted.', 'success');
          loadDevPanel();
        }
      });
    }

    function denyBanRequest(requestId) {
      const requests = JSON.parse(localStorage.getItem('banRequests') || '[]');
      const requestIndex = requests.findIndex(r => r.id === requestId);
      if (requestIndex === -1) {
        showPanelMessage('dev-message', 'Ban request not found.', 'error');
        return;
      }

      openActionModal({
        title: 'Deny Ban Request',
        message: `Deny ban request for ${requests[requestIndex].targetEmail}?`,
        confirmText: 'Deny',
        confirmClass: 'warning',
        onConfirm: () => {
          requests[requestIndex].status = 'denied';
          requests[requestIndex].resolvedAt = new Date().toISOString();
          localStorage.setItem('banRequests', JSON.stringify(requests));

          showPanelMessage('dev-message', 'Ban request denied.', 'success');
          renderBanRequests();
        }
      });
    }

    function unbanIp(ip) {
      openActionModal({
        title: 'Unban IP',
        message: `Unban IP ${ip}?`,
        confirmText: 'Unban',
        onConfirm: () => {
          const ipBans = JSON.parse(localStorage.getItem('ipBans') || '[]');
          const index = ipBans.indexOf(ip);
          if (index === -1) {
            showPanelMessage('dev-message', 'IP not found in ban list.', 'error');
            return;
          }

          ipBans.splice(index, 1);
          localStorage.setItem('ipBans', JSON.stringify(ipBans));
          showPanelMessage('dev-message', 'IP unbanned.', 'success');
          loadDevPanel();
        }
      });
    }

    function unbanApi(email) {
      openActionModal({
        title: 'Unban API User',
        message: `Unban API access for ${email}?`,
        confirmText: 'Unban',
        onConfirm: () => {
          const apiBans = JSON.parse(localStorage.getItem('apiBans') || '[]');
          const index = apiBans.indexOf(email);
          if (index === -1) {
            showPanelMessage('dev-message', 'Email not found in API ban list.', 'error');
            return;
          }

          apiBans.splice(index, 1);
          localStorage.setItem('apiBans', JSON.stringify(apiBans));
          showPanelMessage('dev-message', 'API user unbanned.', 'success');
          loadDevPanel();
        }
      });
    }

    function loadDevPermissionsList() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      const container = document.getElementById('dev-permissions-list');
      container.innerHTML = '';

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No users registered yet.</p>';
        return;
      }

      users.forEach(user => {
        const isStaff = user.isStaff || false;
        const isHeadStaff = user.isHeadStaff || false;
        const isDev = user.isDev || false;
        const isSelf = user.id === currentUser.id;

        const userDiv = document.createElement('div');
        userDiv.className = 'permission-item';
        userDiv.style.marginBottom = '1rem';
        userDiv.innerHTML = `
          <div class="permission-info">
            <div class="permission-details">
              <h4><i class="fas fa-user"></i> ${sanitizeInput(user.name || 'User')}</h4>
              <p><i class="fas fa-envelope"></i> ${sanitizeInput(user.email)}</p>
              <p><i class="fas fa-calendar"></i> Joined: ${new Date(user.createdAt).toLocaleDateString()}</p>
              <div class="user-badges" style="margin-top: 0.5rem;">
                ${isDev ? '<span class="badge badge-dev"><i class="fas fa-code"></i> DEVELOPER</span>' : ''}
                ${isHeadStaff ? '<span class="badge badge-head-staff"><i class="fas fa-crown"></i> HEAD STAFF</span>' : ''}
                ${isStaff ? '<span class="badge badge-staff"><i class="fas fa-shield-alt"></i> STAFF</span>' : ''}
              </div>
            </div>
            <div class="permission-actions">
              ${!isSelf && !isStaff ? `<button class="grant-btn grant-btn-staff" onclick="devGrantStaff(${user.id})"><i class="fas fa-shield-alt"></i> Grant Staff</button>` : ''}
              ${!isSelf && isStaff && !isDev && !isHeadStaff ? `<button class="grant-btn grant-btn-revoke" onclick="devRevokeStaff(${user.id})"><i class="fas fa-times"></i> Revoke Staff</button>` : ''}
              ${!isSelf && !isHeadStaff && !isDev ? `<button class="grant-btn grant-btn-staff" style="background: #dc2626;" onclick="devGrantHeadStaff(${user.id})"><i class="fas fa-crown"></i> Grant Head Staff</button>` : ''}
              ${!isSelf && isHeadStaff && !isDev ? `<button class="grant-btn grant-btn-revoke" onclick="devRevokeHeadStaff(${user.id})"><i class="fas fa-times"></i> Revoke Head Staff</button>` : ''}
              ${!isSelf && !isDev ? `<button class="grant-btn grant-btn-dev" onclick="devGrantDev(${user.id})"><i class="fas fa-code"></i> Grant Dev</button>` : ''}
              ${!isSelf && isDev ? `<button class="grant-btn grant-btn-revoke" onclick="devRevokeDev(${user.id})"><i class="fas fa-times"></i> Revoke Dev</button>` : ''}
              ${!isSelf ? `<button class="grant-btn" style="background: #10b981; color: #04120b;" onclick="devGrantAllPanels(${user.id})"><i class="fas fa-unlock-alt"></i> Grant All Panels</button>` : ''}
              ${isSelf ? '<span style="color: #888; font-size: 0.85rem;"><i class="fas fa-info-circle"></i> You (cannot modify)</span>' : ''}
            </div>
          </div>
        `;
        container.appendChild(userDiv);
      });
    }

    function devGrantStaff(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Grant Staff Access',
        message: `Grant Staff Panel access to ${target.email}?`,
        confirmText: 'Grant',
        onConfirm: () => {
          users[userIndex].isStaff = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          showPanelMessage('dev-message', 'Staff access granted.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function devRevokeStaff(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Revoke Staff Access',
        message: `Revoke Staff Panel access from ${target.email}?`,
        confirmText: 'Revoke',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].isStaff = false;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          showPanelMessage('dev-message', 'Staff access revoked.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function devGrantHeadStaff(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Grant Head Staff',
        message: `Grant Head Staff access to ${target.email}?`,
        confirmText: 'Grant',
        onConfirm: () => {
          users[userIndex].isHeadStaff = true;
          users[userIndex].isStaff = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          showPanelMessage('dev-message', 'Head Staff access granted.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function devRevokeHeadStaff(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Revoke Head Staff',
        message: `Revoke Head Staff access from ${target.email}?`,
        confirmText: 'Revoke',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].isHeadStaff = false;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          showPanelMessage('dev-message', 'Head Staff access revoked.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function devGrantAllPanels(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);

      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Grant All Panels',
        message: `Grant Staff, Head Staff, and Dev access to ${target.email}?`,
        confirmText: 'Grant All',
        confirmClass: 'warning',
        onConfirm: () => {
          users[userIndex].isStaff = true;
          users[userIndex].isHeadStaff = true;
          users[userIndex].isDev = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          showPanelMessage('dev-message', 'All panels access granted.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function grantAllPanelsByEmail() {
      const emailInput = document.getElementById('dev-grant-email');
      const email = emailInput ? emailInput.value.trim().toLowerCase() : '';
      if (!email) {
        showPanelMessage('dev-message', 'Please enter an email address.', 'error');
        return;
      }

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.email === email);

      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      openActionModal({
        title: 'Grant All Panels',
        message: `Grant Staff, Head Staff, and Dev access to ${email}?`,
        confirmText: 'Grant All',
        confirmClass: 'warning',
        onConfirm: () => {
          users[userIndex].isStaff = true;
          users[userIndex].isHeadStaff = true;
          users[userIndex].isDev = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === users[userIndex].id) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          if (emailInput) emailInput.value = '';
          showPanelMessage('dev-message', 'All panels access granted.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function devGrantDev(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Grant Developer Access',
        message: `Grant Developer access to ${target.email}? This gives full control.`,
        confirmText: 'Grant',
        confirmClass: 'warning',
        onConfirm: () => {
          users[userIndex].isDev = true;
          users[userIndex].isStaff = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          showPanelMessage('dev-message', 'Developer access granted.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function devRevokeDev(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      // Check how many devs will remain
      const remainingDevs = users.filter(u => u.isDev && u.id !== userId).length;
      if (remainingDevs === 0) {
        showPanelMessage('dev-message', 'At least one developer must remain.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Revoke Developer Access',
        message: `Revoke Developer access from ${target.email}?`,
        confirmText: 'Revoke',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].isDev = false;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
            updateCurrentUserProfileOnServer(buildProfileUpdatesFromFlags({
              isDev: !!users[userIndex].isDev,
              isStaff: !!users[userIndex].isStaff,
              isHeadStaff: !!users[userIndex].isHeadStaff
            }));
          }

          showPanelMessage('dev-message', 'Developer access revoked.', 'success');
          loadDevPermissionsList();
        }
      });
    }

    function timeoutUserFromDev(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      const duration = getTimeoutDuration('dev-timeout-duration');
      if (!duration) {
        showPanelMessage('dev-message', 'Select a valid timeout duration.', 'error');
        return;
      }

      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Timeout User',
        message: `Timeout ${target.email} for ${duration.label}?`,
        confirmText: 'Timeout',
        confirmClass: 'warning',
        onConfirm: () => {
          const timeoutUntil = new Date();
          timeoutUntil.setMinutes(timeoutUntil.getMinutes() + duration.minutes);
          
          users[userIndex].timeoutUntil = timeoutUntil.toISOString();
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
          if (currentUser && currentUser.id === userId) {
            localStorage.removeItem('currentUser');
          }

          showPanelMessage('dev-message', `User timed out for ${duration.label}.`, 'success');
          loadDevUserModerationList();
        }
      });
    }

    function blacklistUserFromDev(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Blacklist User',
        message: `Blacklist ${target.email}? This will block all access.`,
        confirmText: 'Blacklist',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].blacklisted = true;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showUniversalBanMessage();

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
          if (currentUser && currentUser.id === userId) {
            localStorage.removeItem('currentUser');
          }

          showPanelMessage('dev-message', 'User permanently blacklisted.', 'success');
          loadDevUserModerationList();
        }
      });
    }

    function restoreUserFromDev(userId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Restore Access',
        message: `Restore access for ${target.email}?`,
        confirmText: 'Restore',
        onConfirm: () => {
          users[userIndex].blacklisted = false;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showPanelMessage('dev-message', 'User access restored.', 'success');
          loadDevUserModerationList();
        }
      });
    }

    function deleteAccount() {
      const email = document.getElementById('dev-target-email').value.trim().toLowerCase();
      if (!email) {
        showPanelMessage('dev-message', 'Please enter an email address.', 'error');
        return;
      }

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.email === email);

      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      // Check if trying to delete a developer
      if (users[userIndex].isDev) {
        showPanelMessage('dev-message', 'Cannot delete developer accounts.', 'error');
        return;
      }

      openActionModal({
        title: 'Delete Account',
        message: `Permanently delete ${email}? This cannot be undone.`,
        confirmText: 'Delete',
        confirmClass: 'danger',
        onConfirm: () => {
          users.splice(userIndex, 1);
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
          if (currentUser && currentUser.email === email) {
            localStorage.removeItem('currentUser');
          }

          document.getElementById('dev-target-email').value = '';
          showPanelMessage('dev-message', 'Account permanently deleted.', 'success');
          loadDevPanel();
        }
      });
    }

    function permanentBan() {
      const email = document.getElementById('dev-target-email').value.trim().toLowerCase();
      if (!email) {
        showPanelMessage('dev-message', 'Please enter an email address.', 'error');
        return;
      }

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.email === email);

      if (userIndex === -1) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      if (users[userIndex].isDev) {
        showPanelMessage('dev-message', 'Cannot ban developer accounts.', 'error');
        return;
      }

      openActionModal({
        title: 'Permanent Ban',
        message: `Permanently ban ${email}? This will deny all access.`,
        confirmText: 'Ban',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].blacklisted = true;
          users[userIndex].timeoutUntil = null;
          localStorage.setItem('users', JSON.stringify(users));

          showUniversalBanMessage();

          document.getElementById('dev-target-email').value = '';
          showPanelMessage('dev-message', 'User permanently banned.', 'success');
          loadDevPanel();
        }
      });
    }

    function ipBan() {
      const ip = document.getElementById('dev-ip-address').value.trim();
      if (!ip) {
        showPanelMessage('dev-message', 'Please enter an IP address.', 'error');
        return;
      }

      // Basic IP validation
      const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
      if (!ipRegex.test(ip)) {
        showPanelMessage('dev-message', 'Invalid IP address format.', 'error');
        return;
      }

      let ipBans = JSON.parse(localStorage.getItem('ipBans') || '[]');
      
      if (ipBans.includes(ip)) {
        showPanelMessage('dev-message', 'This IP is already banned.', 'error');
        return;
      }

      openActionModal({
        title: 'Ban IP Address',
        message: `Ban IP address ${ip}? This will block all requests.`,
        confirmText: 'Ban',
        confirmClass: 'danger',
        onConfirm: () => {
          ipBans.push(ip);
          localStorage.setItem('ipBans', JSON.stringify(ipBans));

          showUniversalBanMessage();

          document.getElementById('dev-ip-address').value = '';
          showPanelMessage('dev-message', 'IP address banned.', 'success');
          loadDevPanel();
        }
      });
    }

    function viewIPBans() {
      const container = document.getElementById('dev-ip-bans');
      if (!container) return;

      const isHidden = container.style.display === 'none' || container.style.display === '';
      container.style.display = isHidden ? 'block' : 'none';
      if (isHidden) {
        renderIpBans();
      }
    }

    function apiBan() {
      const email = document.getElementById('dev-api-email').value.trim().toLowerCase();
      if (!email) {
        showPanelMessage('dev-message', 'Please enter an email address.', 'error');
        return;
      }

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.email === email);

      if (!user) {
        showPanelMessage('dev-message', 'User not found.', 'error');
        return;
      }

      if (user.isDev) {
        showPanelMessage('dev-message', 'Cannot API ban developer accounts.', 'error');
        return;
      }

      let apiBans = JSON.parse(localStorage.getItem('apiBans') || '[]');
      
      if (apiBans.includes(email)) {
        showPanelMessage('dev-message', 'This user is already API banned.', 'error');
        return;
      }

      openActionModal({
        title: 'Ban API Access',
        message: `Ban API access for ${email}?`,
        confirmText: 'Ban',
        confirmClass: 'danger',
        onConfirm: () => {
          apiBans.push(email);
          localStorage.setItem('apiBans', JSON.stringify(apiBans));

          showUniversalBanMessage();

          document.getElementById('dev-api-email').value = '';
          showPanelMessage('dev-message', 'User API banned.', 'success');
          loadDevPanel();
        }
      });
    }

    function viewAPIBans() {
      const container = document.getElementById('dev-api-bans');
      if (!container) return;

      const isHidden = container.style.display === 'none' || container.style.display === '';
      container.style.display = isHidden ? 'block' : 'none';
      if (isHidden) {
        renderApiBans();
      }
    }

    function updatePriceLimits() {
      const minPrice = parseFloat(document.getElementById('dev-min-price').value);
      const maxPrice = parseFloat(document.getElementById('dev-max-price').value);

      if (isNaN(minPrice) || isNaN(maxPrice)) {
        showPanelMessage('dev-message', 'Please enter valid price values.', 'error');
        return;
      }

      if (minPrice < 0) {
        showPanelMessage('dev-message', 'Minimum price cannot be negative.', 'error');
        return;
      }

      if (maxPrice <= minPrice) {
        showPanelMessage('dev-message', 'Maximum price must be greater than minimum price.', 'error');
        return;
      }

      const priceLimits = { min: minPrice, max: maxPrice };
      localStorage.setItem('priceLimits', JSON.stringify(priceLimits));

      showPanelMessage('dev-message', `Price limits updated. Min: $${minPrice} Max: $${maxPrice}`, 'success');
    }

    function toggleMaintenance() {
      const maintenanceMode = localStorage.getItem('maintenanceMode') === 'true';
      const newMode = !maintenanceMode;

      openActionModal({
        title: newMode ? 'Enable Maintenance' : 'Disable Maintenance',
        message: newMode
          ? 'Enable maintenance mode? This blocks non-developers.'
          : 'Disable maintenance mode and restore normal access?',
        confirmText: newMode ? 'Enable' : 'Disable',
        confirmClass: newMode ? 'warning' : '',
        onConfirm: () => {
          localStorage.setItem('maintenanceMode', newMode.toString());
          checkMaintenanceMode();
          loadDevPanel();
          showPanelMessage('dev-message', newMode ? 'Maintenance mode enabled.' : 'Maintenance mode disabled.', 'success');
        }
      });
    }

    function clearAllData() {
      openActionModal({
        title: 'Clear All Data',
        message: 'Clear ALL data? This deletes users, bans, and settings. This cannot be undone.',
        confirmText: 'Clear All',
        confirmClass: 'danger',
        onConfirm: () => {
          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          
          localStorage.clear();
          
          if (currentUser) {
            const devUser = {
              id: Date.now(),
              name: currentUser.name,
              email: currentUser.email,
              password: '',
              isDev: true,
              createdAt: new Date().toISOString()
            };
            localStorage.setItem('users', JSON.stringify([devUser]));
            localStorage.setItem('currentUser', JSON.stringify({ id: devUser.id, name: devUser.name, email: devUser.email }));
          }

          showPanelMessage('dev-message', 'All data cleared. Reloading...', 'success');
          setTimeout(() => location.reload(), 600);
        }
      });
    }

    function exportData() {
      const data = {
        users: JSON.parse(localStorage.getItem('users') || '[]'),
        ipBans: JSON.parse(localStorage.getItem('ipBans') || '[]'),
        apiBans: JSON.parse(localStorage.getItem('apiBans') || '[]'),
        priceLimits: JSON.parse(localStorage.getItem('priceLimits') || '{"min":1,"max":10000}'),
        maintenanceMode: localStorage.getItem('maintenanceMode') === 'true',
        exportDate: new Date().toISOString()
      };

      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `atlasfn-data-${Date.now()}.json`;
      link.click();
      URL.revokeObjectURL(url);

      showPanelMessage('dev-message', 'Data exported successfully.', 'success');
    }

    // ====== OWNER PANEL FUNCTIONS ======

    function openOwnerPanel() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === currentUser.id);

      if (!user || !user.isDev) {
        showToast('Access denied. Owner privileges required.', 'error');
        return;
      }

      document.getElementById('ownerPanel').style.display = 'flex';
      loadOwnerPanel();
    }

    // Wipe all users except dev@atlasfn.com
    function wipeAllUsers() {
      // No confirmation - dev knows what they're doing
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      
      // Keep only dev@atlasfn.com
      const devUser = users.find(u => u.email === 'dev@atlasfn.com');
      
      if (devUser) {
        localStorage.setItem('users', JSON.stringify([devUser]));
        showPanelMessage('dev-message', ' All users have been wiped except dev@atlasfn.com', 'success');
      } else {
        localStorage.setItem('users', JSON.stringify([]));
        showPanelMessage('dev-message', ' All users have been wiped', 'success');
      }
      
      // Also clear tickets, orders, and bans related to deleted users
      localStorage.setItem('tickets', JSON.stringify([]));
      localStorage.setItem('orders', JSON.stringify([]));
      localStorage.setItem('bans', JSON.stringify([]));
      localStorage.setItem('ipBans', JSON.stringify([]));
      localStorage.setItem('apiBans', JSON.stringify([]));
      
      // Reload panel to reflect changes
      setTimeout(() => {
        loadDevPanel();
        location.reload();
      }, 1000);
    }

    function closeOwnerPanel() {
      document.getElementById('ownerPanel').style.display = 'none';
    }

    function loadOwnerPanel() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const now = new Date();

      // Calculate stats
      const totalUsers = users.length;
      const activeUsers = users.filter(u => !u.blacklisted && (!u.timeoutUntil || new Date(u.timeoutUntil) <= now)).length;
      const staffCount = users.filter(u => u.isStaff).length;
      const devCount = users.filter(u => u.isDev).length;

      document.getElementById('owner-total-users').textContent = totalUsers;
      document.getElementById('owner-active-users').textContent = activeUsers;
      document.getElementById('owner-staff-count').textContent = staffCount;
      document.getElementById('owner-dev-count').textContent = devCount;

      // Load users list
      const container = document.getElementById('owner-users-container');
      container.innerHTML = '';

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No users registered yet.</p>';
        return;
      }

      users.forEach(user => {
        const isBlacklisted = user.blacklisted || false;
        const isTimedOut = user.timeoutUntil && new Date(user.timeoutUntil) > now;
        const isStaff = user.isStaff || false;
        const isHeadStaff = user.isHeadStaff || false;
        const isDev = user.isDev || false;

        let statusClass = '';
        if (isBlacklisted) statusClass = 'blacklisted';
        else if (isTimedOut) statusClass = 'timed-out';

        const userDiv = document.createElement('div');
        userDiv.className = `user-item ${statusClass}`;
        userDiv.innerHTML = `
          <div class="user-info">
            <div class="user-details">
              <h4><i class="fas fa-user"></i> ${sanitizeInput(user.name || 'User')}</h4>
              <p><i class="fas fa-envelope"></i> ${sanitizeInput(user.email)}</p>
              <p><i class="fas fa-calendar"></i> Joined: ${new Date(user.createdAt).toLocaleDateString()}</p>
              <div class="user-badges">
                ${isDev ? '<span class="badge badge-dev"><i class="fas fa-code"></i> DEVELOPER</span>' : ''}
                ${isHeadStaff ? '<span class="badge badge-head-staff"><i class="fas fa-crown"></i> HEAD STAFF</span>' : ''}
                ${isStaff ? '<span class="badge badge-staff"><i class="fas fa-shield-alt"></i> STAFF</span>' : ''}
                ${isBlacklisted ? '<span class="badge badge-blacklisted"><i class="fas fa-ban"></i> BLACKLISTED</span>' : ''}
                ${isTimedOut ? '<span class="badge badge-timeout"><i class="fas fa-clock"></i> TIMED OUT</span>' : ''}
              </div>
            </div>
            <div class="user-actions">
              ${!isStaff && !isDev ? `<button class="action-btn action-btn-staff" onclick="ownerGrantStaff(${user.id})">Grant Staff</button>` : ''}
              ${isStaff && !isDev && !isHeadStaff ? `<button class="action-btn action-btn-staff" style="background: #dc2626;" onclick="ownerGrantHeadStaff(${user.id})">Grant Head Staff</button>` : ''}
              ${!isDev ? `<button class="action-btn action-btn-staff" style="background: #ff0080;" onclick="ownerGrantDev(${user.id})">Grant Dev</button>` : ''}
              ${isDev ? `<button class="action-btn action-btn-revoke" onclick="ownerRevokeDev(${user.id})">Revoke Dev</button>` : ''}
            </div>
          </div>
        `;
        container.appendChild(userDiv);
      });
    }

    function ownerGrantStaff(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('owner-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Grant Staff Access',
        message: `Grant Staff access to ${target.email}?`,
        confirmText: 'Grant',
        onConfirm: () => {
          users[userIndex].isStaff = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
          }

          showPanelMessage('owner-message', 'Staff access granted.', 'success');
          loadOwnerPanel();
        }
      });
    }

    function ownerGrantHeadStaff(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('owner-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Grant Head Staff',
        message: `Grant Head Staff access to ${target.email}?`,
        confirmText: 'Grant',
        onConfirm: () => {
          users[userIndex].isHeadStaff = true;
          users[userIndex].isStaff = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
          }

          showPanelMessage('owner-message', 'Head Staff access granted.', 'success');
          loadOwnerPanel();
        }
      });
    }

    function ownerGrantDev(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('owner-message', 'User not found.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Grant Developer Access',
        message: `Grant Developer access to ${target.email}? This gives full control.`,
        confirmText: 'Grant',
        confirmClass: 'warning',
        onConfirm: () => {
          users[userIndex].isDev = true;
          users[userIndex].isStaff = true;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
          }

          showPanelMessage('owner-message', 'Developer access granted.', 'success');
          loadOwnerPanel();
        }
      });
    }

    function ownerRevokeDev(userId) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex === -1) {
        showPanelMessage('owner-message', 'User not found.', 'error');
        return;
      }

      // Check how many devs will remain
      const remainingDevs = users.filter(u => u.isDev && u.id !== userId).length;
      if (remainingDevs === 0) {
        showPanelMessage('owner-message', 'At least one developer must remain.', 'error');
        return;
      }

      const target = users[userIndex];
      openActionModal({
        title: 'Revoke Developer Access',
        message: `Revoke Developer access from ${target.email}?`,
        confirmText: 'Revoke',
        confirmClass: 'danger',
        onConfirm: () => {
          users[userIndex].isDev = false;
          localStorage.setItem('users', JSON.stringify(users));

          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          if (currentUser && currentUser.id === userId) {
            updateNavBar(currentUser);
          }

          showPanelMessage('owner-message', 'Developer access revoked.', 'success');
          loadOwnerPanel();
        }
      });
    }

    function setTestModeBannerVisible(show) {
      const banner = document.getElementById('testModeBanner');
      if (!banner) return;
      banner.classList.toggle('show', !!show);
    }

    function applyTestModeOnLoad() {
      const isActive = sessionStorage.getItem('testModeActive') === 'true';
      if (!isActive) return;
      setTestModeBannerVisible(true);
    }

    function enterTestMode() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      if (!currentUser) {
        showToast('You must be logged in to use test mode.', 'error');
        return;
      }

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex === -1) {
        showToast('User not found.', 'error');
        return;
      }

      const originalPerms = {
        isDev: !!users[userIndex].isDev,
        isStaff: !!users[userIndex].isStaff,
        isHeadStaff: !!users[userIndex].isHeadStaff
      };

      sessionStorage.setItem('testModeActive', 'true');
      sessionStorage.setItem('testModeOriginalPerms', JSON.stringify(originalPerms));

      users[userIndex].isDev = false;
      users[userIndex].isStaff = false;
      users[userIndex].isHeadStaff = false;
      localStorage.setItem('users', JSON.stringify(users));

      setTestModeBannerVisible(true);
      location.reload();
    }

    function exitTestMode(skipReload) {
      const isActive = sessionStorage.getItem('testModeActive') === 'true';
      if (!isActive) return;

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const originalPerms = JSON.parse(sessionStorage.getItem('testModeOriginalPerms') || 'null');
      const userIndex = currentUser ? users.findIndex(u => u.id === currentUser.id) : -1;

      if (userIndex !== -1 && originalPerms) {
        users[userIndex].isDev = !!originalPerms.isDev;
        users[userIndex].isStaff = !!originalPerms.isStaff;
        users[userIndex].isHeadStaff = !!originalPerms.isHeadStaff;
        localStorage.setItem('users', JSON.stringify(users));
      }

      sessionStorage.removeItem('testModeActive');
      sessionStorage.removeItem('testModeOriginalPerms');
      setTestModeBannerVisible(false);

      if (!skipReload) {
        location.reload();
      }
    }

    // Check maintenance mode on page load
    window.addEventListener('DOMContentLoaded', () => {
      checkMaintenanceMode();
    });

    // Show error message
    function showError(element, message) {
      element.textContent = ' ' + message;
      element.classList.add('show');
    }

    // Wipe all fake revenue and payout data
    function wipeAllRevenueData() {
      // Clear all transaction and payout data from localStorage
      localStorage.removeItem('atlasfn_transactions');
      localStorage.removeItem('atlasfn_orders');
      localStorage.removeItem('atlasfn_payouts');
      localStorage.removeItem('atlasfn_payment_methods');
      
      // Reset paymentSystem
      paymentSystem.transactions = [];
      paymentSystem.orders = [];
      paymentSystem.saveTransactions();
      paymentSystem.saveOrders();
      
      // Reset payoutSystem
      payoutSystem.paymentMethods = [];
      payoutSystem.payouts = [];
      payoutSystem.savePaymentMethods();
      payoutSystem.savePayouts();
      
      console.log(' All fake revenue and payout data wiped successfully!');
      showToast(' All fake revenue data cleared!', 'success');
      
      // Refresh owner panel if open
      if (document.getElementById('ownerPanel').style.display === 'flex') {
        refreshOwnerPanel();
      }
    }

    // ====== PERFORMANCE OPTIMIZED: CROSSHAIR AND HEX EFFECTS ======
    // Simple initialization - runs after DOM is ready
    function initializeEffects() {
      console.log(' Initializing crosshair and hex effects...');
      
      // Crosshair setup
      const crosshair = document.getElementById('crosshair');
      if (crosshair) {
        console.log(' Crosshair found');
        crosshair.style.left = window.innerWidth / 2 + 'px';
        crosshair.style.top = window.innerHeight / 2 + 'px';
        crosshair.style.opacity = '1';
        console.log(' Crosshair positioned at center');
        
        document.addEventListener('mousemove', (e) => {
          crosshair.style.left = e.clientX + 'px';
          crosshair.style.top = e.clientY + 'px';
        }, { passive: true });
        
        // Click animation
        document.addEventListener('click', () => {
          crosshair.style.transform = 'translate(-50%, -50%) scale(0.8)';
          setTimeout(() => {
            crosshair.style.transform = 'translate(-50%, -50%) scale(1)';
          }, 100);
        }, { passive: true });
      } else {
        console.error(' Crosshair element NOT found');
      }

      // Hex canvas setup
      const canvas = document.getElementById('hexCanvas');
      if (!canvas) {
        console.error(' Canvas not found');
        return;
      }
      
      console.log(' Canvas found');
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        console.error(' Canvas context failed');
        return;
      }
      
      console.log(' Canvas context ready');
      let hexMouseX = 0, hexMouseY = 0;
      let hexagons = [];
      let lastUpdateTime = 0;
      const updateInterval = 1000 / 60;
      const hexRadius = 30;
      const hexHeight = Math.sin(Math.PI / 3) * hexRadius;
      
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        console.log(' Canvas resized to', canvas.width, 'x', canvas.height);
        hexagons = [];
        const cols = Math.ceil(canvas.width / (hexRadius * 1.5)) + 1;
        const rows = Math.ceil(canvas.height / (hexHeight * 2)) + 1;
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const x = col * hexRadius * 1.5;
            const y = row * hexHeight * 2 + (col % 2 === 0 ? 0 : hexHeight);
            hexagons.push({ x, y });
          }
        }
        console.log(' Generated', hexagons.length, 'hexagons');
      }
      
      const hexAngles = [];
      for (let i = 0; i < 6; i++) {
        hexAngles.push((Math.PI / 3) * i);
      }
      
      function drawHexagon(x, y, radius, opacity) {
        if (opacity < 0.02) return;
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
          const angle = hexAngles[i];
          const hx = x + radius * Math.cos(angle);
          const hy = y + radius * Math.sin(angle);
          if (i === 0) ctx.moveTo(hx, hy);
          else ctx.lineTo(hx, hy);
        }
        ctx.closePath();
        ctx.strokeStyle = `rgba(168, 85, 247, ${opacity})`;
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      
      let frameCount = 0;
      function animate() {
        const now = performance.now();
        if (now - lastUpdateTime < updateInterval) {
          requestAnimationFrame(animate);
          return;
        }
        lastUpdateTime = now;
        frameCount++;
        
        if (frameCount === 1) {
          console.log(' Animation started - first frame rendered');
        }
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(168, 85, 247, 0.03)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < hexagons.length; i++) {
          const hex = hexagons[i];
          const dx = hexMouseX - hex.x;
          const dy = hexMouseY - hex.y;
          const distSq = dx * dx + dy * dy;
          const maxDistSq = 200 * 200;
          
          if (distSq < maxDistSq) {
            const distance = Math.sqrt(distSq);
            const opacity = (1 - distance / 200) * 0.9;
            drawHexagon(hex.x, hex.y, hexRadius, opacity);
          } else {
            drawHexagon(hex.x, hex.y, hexRadius, 0.2);
          }
        }
        
        requestAnimationFrame(animate);
      }
      
      document.addEventListener('mousemove', (e) => {
        hexMouseX = e.clientX;
        hexMouseY = e.clientY;
      }, { passive: true });
      
      window.addEventListener('resize', resizeCanvas);
      
      resizeCanvas();
      animate();
      console.log(' All effects initialized successfully');
    }
    
    // Wait a bit to ensure DOM is fully ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeEffects);
      console.log(' Waiting for DOMContentLoaded...');
    } else {
      console.log(' DOM already ready, initializing now...');
      initializeEffects();
    }
    
    // ====== PAYMENT MANAGEMENT FUNCTIONS ======

    function refreshPaymentStats() {
      const totalTransactions = document.getElementById('totalTransactions');
      const totalRevenue = document.getElementById('totalRevenue');
      
      if (!totalTransactions || !totalRevenue) return;

      // Count only real transactions (test transactions are never saved to localStorage)
      const transactions = paymentSystem.transactions.filter(t => t.status === 'completed' && t.isReal);
      const revenue = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);

      totalTransactions.textContent = transactions.length;
      totalRevenue.textContent = '$' + revenue.toFixed(2);

      // Render transaction list
      if (document.getElementById('dev-transactions-list')) {
        const transactionsList = paymentSystem.getAllTransactions(20);
        document.getElementById('dev-transactions-list').innerHTML = transactionsList
          .map(t => `
            <div class="transaction-item">
              <div class="transaction-info">
                <div class="transaction-id">${t.id}</div>
                <div class="transaction-product">${t.customer.email}</div>
                <div class="transaction-date">${new Date(t.timestamp).toLocaleString()}</div>
              </div>
              <div class="transaction-status ${t.status}">${t.status}</div>
              <div class="transaction-amount">$${t.amount.toFixed(2)}</div>
            </div>
          `)
          .join('');
      }

      showToast('Payment stats refreshed!', 'success');
    }

    function exportTransactions() {
      const transactions = paymentSystem.getAllTransactions();
      
      if (transactions.length === 0) {
        showToast('No transactions to export', 'info');
        return;
      }

      let csv = 'Transaction ID,Order ID,Method,Amount,Status,Customer Email,Date\n';
      
      transactions.forEach(t => {
        csv += `"${t.id}","${t.orderId}","${t.method}","${t.amount}","${t.status}","${t.customer.email}","${t.timestamp}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `atlasfn_transactions_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      showToast('Transactions exported successfully!', 'success');
    }

    function processPaymentRefund(transactionId) {
      const result = paymentSystem.processRefund(transactionId, 'Admin refund');
      
      if (result.success) {
        showToast('Refund processed successfully', 'success');
        refreshPaymentStats();
      } else {
        showToast('Refund failed: ' + result.error, 'error');
      }
    }

    // ====== OWNER PANEL / PAYOUT SYSTEM ======

    const payoutSystem = {
      paymentMethods: [],
      payouts: [],
      
      init() {
        this.loadPaymentMethods();
        this.loadPayouts();
      },
      
      loadPaymentMethods() {
        const stored = localStorage.getItem('atlasfn_payment_methods');
        this.paymentMethods = stored ? JSON.parse(stored) : [];
      },
      
      loadPayouts() {
        const stored = localStorage.getItem('atlasfn_payouts');
        this.payouts = stored ? JSON.parse(stored) : [];
      },
      
      savePaymentMethods() {
        localStorage.setItem('atlasfn_payment_methods', JSON.stringify(this.paymentMethods));
      },
      
      savePayouts() {
        localStorage.setItem('atlasfn_payouts', JSON.stringify(this.payouts));
      },
      
      addPaymentMethod(method) {
        const id = 'PM_' + Date.now();
        const paymentMethod = {
          id,
          type: method.type,
          lastFour: this.getLastFour(method),
          holder: method.holder,
          isDefault: this.paymentMethods.length === 0,
          createdAt: new Date().toISOString(),
          // Encrypted data (basic masking for demo)
          data: btoa(JSON.stringify(method))
        };
        
        // Remove default from others if this is default
        if (paymentMethod.isDefault) {
          this.paymentMethods.forEach(pm => pm.isDefault = false);
        }
        
        this.paymentMethods.push(paymentMethod);
        this.savePaymentMethods();
        return paymentMethod;
      },
      
      getLastFour(method) {
        if (method.type === 'credit_card') {
          return method.cardNumber?.slice(-4) || '****';
        } else if (method.type === 'bank_account') {
          return method.bankAccount?.slice(-4) || '****';
        } else if (method.type === 'paypal') {
          return method.paypalEmail?.split('@')[0]?.slice(-4) || '****';
        }
        return '****';
      },
      
      deletePaymentMethod(id) {
        this.paymentMethods = this.paymentMethods.filter(pm => pm.id !== id);
        this.savePaymentMethods();
      },
      
      setDefaultPaymentMethod(id) {
        this.paymentMethods.forEach(pm => {
          pm.isDefault = pm.id === id;
        });
        this.savePaymentMethods();
      },
      
      processWithdrawal(amount, methodId, notes) {
        const method = this.paymentMethods.find(pm => pm.id === methodId);
        if (!method) {
          return { success: false, error: 'Payment method not found' };
        }
        
        // Calculate fee
        const fee = Math.max(amount * 0.025 + 0.30, 0);
        const totalAmount = amount + fee;
        
        // Check balance
        const balance = this.getAvailableBalance();
        if (totalAmount > balance) {
          return { success: false, error: 'Insufficient balance' };
        }
        
        const payout = {
          id: 'PAYOUT_' + Date.now(),
          amount,
          fee,
          totalAmount,
          methodId,
          methodType: method.type,
          status: 'processing',
          notes,
          createdAt: new Date().toISOString(),
          completedAt: null
        };
        
        this.payouts.push(payout);
        this.savePayouts();
        
        // Simulate processing
        setTimeout(() => {
          const payoutIndex = this.payouts.findIndex(p => p.id === payout.id);
          if (payoutIndex !== -1) {
            this.payouts[payoutIndex].status = 'completed';
            this.payouts[payoutIndex].completedAt = new Date().toISOString();
            this.savePayouts();
            showToast('Payout completed successfully!', 'success');
            refreshOwnerPanel();
          }
        }, 3000);
        
        return { success: true, payout };
      },
      
      getAvailableBalance() {
        // Only real transactions are saved to localStorage (test transactions are never persisted)
        const completed = paymentSystem.transactions.filter(t => t.status === 'completed' && t.isReal);
        const totalRevenue = completed.reduce((sum, t) => sum + (t.amount || 0), 0);
        const totalPaidOut = this.payouts
          .filter(p => p.status === 'completed')
          .reduce((sum, p) => sum + (p.totalAmount || 0), 0);
        return Math.max(totalRevenue - totalPaidOut, 0);
      }
    };

    function switchOwnerTab(tabName) {
      // Hide all tabs
      document.getElementById('owner-overview-tab').style.display = 'none';
      document.getElementById('owner-payouts-tab').style.display = 'none';
      document.getElementById('owner-payment-methods-tab').style.display = 'none';
      document.getElementById('owner-users-tab').style.display = 'none';
      
      // Remove active class from all buttons
      document.querySelectorAll('.owner-tab-btn').forEach(btn => {
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = '#888';
      });
      
      // Show selected tab
      const tabEl = document.getElementById('owner-' + tabName + '-tab');
      if (tabEl) {
        tabEl.style.display = 'block';
      }
      
      // Highlight button
      event.target.style.borderBottomColor = '#ff6b00';
      event.target.style.color = 'var(--text)';
      
      // Load tab data
      if (tabName === 'payouts') {
        loadPayoutHistory();
        updatePayoutStats();
      } else if (tabName === 'payment-methods') {
        loadPaymentMethods();
      } else if (tabName === 'users') {
        loadOwnerUsers();
      }
    }

    function openAddCardModal() {
      document.getElementById('addCardModal').style.display = 'flex';
      document.getElementById('cardType').value = 'credit_card';
      showCardFields('credit_card');
    }

    function closeAddCardModal() {
      document.getElementById('addCardModal').style.display = 'none';
      document.getElementById('addCardForm').reset();
    }

    function showCardFields(type) {
      document.getElementById('credit-card-fields').style.display = type === 'credit_card' ? 'block' : 'none';
      document.getElementById('bank-account-fields').style.display = type === 'bank_account' ? 'block' : 'none';
      document.getElementById('paypal-fields').style.display = type === 'paypal' ? 'block' : 'none';
    }

    document.getElementById('cardType')?.addEventListener('change', (e) => {
      showCardFields(e.target.value);
    });

    function formatCardNumber(input) {
      let value = input.value.replace(/\s/g, '');
      let formatted = value.replace(/(\d{4})/g, '$1 ').trim();
      input.value = formatted;
    }

    function formatExpiry(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
      }
      input.value = value;
    }

    function savePaymentMethod(event) {
      event.preventDefault();
      
      const cardType = document.getElementById('cardType').value;
      let method = { type: cardType };
      
      if (cardType === 'credit_card') {
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        if (cardNumber.length < 13) {
          showToast('Invalid card number', 'error');
          return;
        }
        method.holder = document.getElementById('cardName').value;
        method.cardNumber = cardNumber;
        method.expiry = document.getElementById('cardExpiry').value;
        method.cvv = document.getElementById('cardCVV').value;
      } else if (cardType === 'bank_account') {
        method.holder = document.getElementById('bankName').value;
        method.routing = document.getElementById('bankRouting').value;
        method.bankAccount = document.getElementById('bankAccount').value.replace(/\D/g, '');
      } else if (cardType === 'paypal') {
        method.paypalEmail = document.getElementById('paypalEmail').value;
        method.holder = method.paypalEmail.split('@')[0];
      }
      
      const paymentMethod = payoutSystem.addPaymentMethod(method);
      showToast('Payment method added successfully!', 'success');
      closeAddCardModal();
      loadPaymentMethods();
    }

    function loadPaymentMethods() {
      const container = document.getElementById('owner-cards-list');
      if (!container) return;
      
      if (payoutSystem.paymentMethods.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">No payment methods added yet</p>';
        return;
      }
      
      container.innerHTML = payoutSystem.paymentMethods.map(method => {
        const typeLabel = {
          'credit_card': ' Credit Card',
          'bank_account': ' Bank Account',
          'paypal': ' PayPal'
        }[method.type] || 'Payment Method';
        
        return `
          <div class="payment-card">
            <div class="payment-card-info">
              ${method.isDefault ? '<span class="payment-card-badge payment-card-default">Default</span>' : ''}
              <span class="payment-card-badge">${typeLabel}</span>
              <div class="payment-card-number">   ${method.lastFour}</div>
              <div class="payment-card-holder">${method.holder || 'Account Holder'}</div>
              <div class="payment-card-expiry">Added ${new Date(method.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="payment-card-actions">
              ${!method.isDefault ? `<button class="payment-card-btn" style="background: #a855f7; color: white;" onclick="setDefaultPaymentMethod('${method.id}')">Set Default</button>` : ''}
              <button class="payment-card-btn payment-card-btn-delete" onclick="deletePaymentMethodConfirm('${method.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function setDefaultPaymentMethod(id) {
      payoutSystem.setDefaultPaymentMethod(id);
      loadPaymentMethods();
      showToast('Default payment method updated', 'success');
    }

    function deletePaymentMethodConfirm(id) {
      if (confirm('Are you sure you want to delete this payment method?')) {
        payoutSystem.deletePaymentMethod(id);
        loadPaymentMethods();
        showToast('Payment method deleted', 'success');
      }
    }

    function openWithdrawModal() {
      const balance = payoutSystem.getAvailableBalance();
      document.getElementById('withdraw-available').textContent = '$' + balance.toFixed(2);
      
      const methodSelect = document.getElementById('withdrawMethod');
      methodSelect.innerHTML = '<option value="">-- Choose a payment method --</option>';
      
      if (payoutSystem.paymentMethods.length === 0) {
        methodSelect.innerHTML += '<option disabled>Add a payment method first</option>';
      } else {
        payoutSystem.paymentMethods.forEach(method => {
          methodSelect.innerHTML += `<option value="${method.id}">${method.holder || 'Account'} ( ${method.lastFour})</option>`;
        });
      }
      
      document.getElementById('withdrawModal').style.display = 'flex';
    }

    function closeWithdrawModal() {
      document.getElementById('withdrawModal').style.display = 'none';
      document.getElementById('withdrawForm').reset();
    }

    function processWithdrawal(event) {
      event.preventDefault();
      
      const amount = parseFloat(document.getElementById('withdrawAmount').value);
      const methodId = document.getElementById('withdrawMethod').value;
      const notes = document.getElementById('withdrawNotes').value;
      
      if (amount < 10) {
        showToast('Minimum withdrawal is $10.00', 'error');
        return;
      }
      
      if (!methodId) {
        showToast('Please select a payment method', 'error');
        return;
      }
      
      const result = payoutSystem.processWithdrawal(amount, methodId, notes);
      
      if (result.success) {
        showToast('Withdrawal initiated! Processing in 3 seconds...', 'success');
        closeWithdrawModal();
        setTimeout(() => {
          refreshOwnerPanel();
        }, 3500);
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    }

    function loadPayoutHistory() {
      const container = document.getElementById('owner-payout-history');
      
      if (payoutSystem.payouts.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">No payouts yet</p>';
        return;
      }
      
      container.innerHTML = payoutSystem.payouts
        .reverse()
        .map(payout => `
          <div class="payout-item">
            <div class="payout-info">
              <div style="color: var(--text); font-weight: 600;">Withdrawal to  ${payoutSystem.paymentMethods.find(m => m.id === payout.methodId)?.lastFour || '****'}</div>
              <div class="payout-date">${new Date(payout.createdAt).toLocaleString()}</div>
              <div style="color: #888; font-size: 0.8rem; margin-top: 0.25rem;">Amount: $${payout.amount.toFixed(2)} | Fee: $${payout.fee.toFixed(2)}</div>
            </div>
            <div style="text-align: right;">
              <div class="payout-status ${payout.status}">${payout.status.toUpperCase()}</div>
              <div class="payout-amount">$${payout.amount.toFixed(2)}</div>
            </div>
          </div>
        `)
        .join('');
    }

    function updatePayoutStats() {
      const balance = payoutSystem.getAvailableBalance();
      document.getElementById('available-balance').textContent = '$' + balance.toFixed(2);
      
      // Only real transactions are saved to localStorage (test transactions are never persisted)
      const completed = paymentSystem.transactions.filter(t => t.status === 'completed' && t.isReal);
      const totalRevenue = completed.reduce((sum, t) => sum + (t.amount || 0), 0);
      const totalPaidOut = payoutSystem.payouts
        .filter(p => p.status === 'completed')
        .reduce((sum, p) => sum + (p.totalAmount || 0), 0);
      
      document.getElementById('owner-pending-payout').textContent = '$' + balance.toFixed(2);
      document.getElementById('owner-total-revenue').textContent = '$' + totalRevenue.toFixed(2);
      document.getElementById('owner-total-payouts').textContent = '$' + totalPaidOut.toFixed(2);
    }

    function refreshOwnerPanel() {
      updatePayoutStats();
      loadPayoutHistory();
      loadTransactionsList();
    }

    function loadTransactionsList() {
      const container = document.getElementById('owner-transactions-list');
      if (!container) return;
      
      const transactions = paymentSystem.getAllTransactions(10);
      
      if (transactions.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">No transactions yet</p>';
        return;
      }
      
      container.innerHTML = transactions.map(t => `
        <div class="transaction-item">
          <div class="transaction-info">
            <div class="transaction-id">${t.id}</div>
            <div class="transaction-product">${t.product?.name || 'Unknown'}</div>
            <div class="transaction-date">${new Date(t.timestamp).toLocaleString()}</div>
          </div>
          <div class="transaction-status ${t.status}">${t.status}</div>
          <div class="transaction-amount">$${t.amount.toFixed(2)}</div>
        </div>
      `).join('');
    }

    function loadOwnerUsers() {
      const container = document.getElementById('owner-users-container');
      if (!container) return;
      
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      
      if (users.length === 0) {
        container.innerHTML = '<p style="color: #888; text-align: center;">No users</p>';
        return;
      }
      
      container.innerHTML = users.slice(0, 10).map(user => `
        <div class="user-item">
          <div class="user-info">
            <div class="user-details">
              <h4>${user.name || user.email}</h4>
              <p>${user.email}</p>
              <p>Joined: ${new Date(user.createdAt || 0).toLocaleDateString()}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Update ticket badge on page load
    window.addEventListener('DOMContentLoaded', () => {
      updateTicketBadge();
      
      // Close modals when clicking outside
      const modals = ['orderHistoryModal', 'supportModal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.style.display = 'none';
            }
          });
        }
      });
      
      // Close sidebar when clicking overlay
      const sidebarOverlay = document.querySelector('.sidebar-overlay');
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', toggleSidebar);
      }

      // Receipt page handler
      window.addEventListener('hashchange', () => {
        if (window.location.hash === '#receipt') {
          showReceiptPage();
        } else {
          hideReceiptPage();
        }
      });

      // Check on load if should show receipt
      if (window.location.hash === '#receipt') {
        showReceiptPage();
      }

      function hideReceiptPage() {
        const receiptModal = document.getElementById('receiptPageModal');
        if (receiptModal) {
          receiptModal.style.display = 'none';
        }
      }

      function showReceiptPage() {
        const lastOrder = localStorage.getItem('lastOrder');
        if (!lastOrder) {
          window.location.href = '#';
          return;
        }

        const order = JSON.parse(lastOrder);
        let receiptModal = document.getElementById('receiptPageModal');
        
        // Create receipt modal if it doesn't exist
        if (!receiptModal) {
          receiptModal = document.createElement('div');
          receiptModal.id = 'receiptPageModal';
          receiptModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; overflow-y: auto; padding: 2rem;';
          document.body.appendChild(receiptModal);
        }
        
        receiptModal.innerHTML = `
          <div style="max-width: 600px; width: 100%;">
            <div style="background: rgba(0, 212, 255, 0.1); border: 2px solid #00d4ff; border-radius: 16px; padding: 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 64px; margin-bottom: 1rem;"></div>
                <h1 style="color: #00ff88; margin-bottom: 0.5rem;">Payment Successful!</h1>
                <p style="color: #888;">Your access key has been activated</p>
              </div>

              <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="margin-bottom: 1rem;">
                  <div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.3rem;">Invoice ID</div>
                  <div style="color: #00d4ff; font-size: 18px; font-weight: 700; font-family: monospace;">${order.transactionId || 'N/A'}</div>
                </div>

                <div style="margin-bottom: 1rem;">
                  <div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.3rem;">Purchase ID</div>
                  <div style="color: #00d4ff; font-size: 18px; font-weight: 700; font-family: monospace;">${order.id || 'N/A'}</div>
                </div>

                <div style="margin-bottom: 1rem;">
                  <div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.3rem;">License Key</div>
                  <div style="color: #00ff88; font-size: 18px; font-weight: 700; font-family: monospace; word-break: break-all;">${order.accessKey || 'N/A'}</div>
                </div>

                <div style="margin-bottom: 0;">
                  <div style="color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.3rem;">Amount Paid</div>
                  <div style="color: #00d4ff; font-size: 18px; font-weight: 700;">$${order.amount?.toFixed(2) || '0.00'}</div>
                </div>
              </div>

              <div style="background: rgba(255, 107, 0, 0.05); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <p style="color: #ff6b00; margin: 0; font-size: 14px;"><i class="fas fa-info-circle"></i> Save your License Key in a safe place. You'll need it to access your purchased content.</p>
              </div>

              <div style="display: grid; gap: 0.5rem;">
                <button onclick="copyLicenseKey('${order.accessKey}')" style="width: 100%; padding: 0.8rem; background: linear-gradient(135deg, #00d4ff, #0099cc); border: none; border-radius: 8px; color: #000; font-weight: 600; cursor: pointer; font-size: 14px; transition: 0.3s;">
                  <i class="fas fa-copy"></i> Copy License Key
                </button>
                <button onclick="document.getElementById('receiptPageModal').remove(); window.location.hash = ''; window.location.reload();" style="width: 100%; padding: 0.8rem; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-weight: 600; cursor: pointer; font-size: 14px; transition: 0.3s;">
                  <i class="fas fa-arrow-left"></i> Back to Home
                </button>
              </div>
            </div>

            <div style="text-align: center; margin-top: 2rem; color: #888; font-size: 12px;">
              <p>Order Date: ${new Date(order.timestamp).toLocaleString()}</p>
              <p>A confirmation email has been sent to ${order.email}</p>
            </div>
          </div>
        `;
        receiptModal.style.display = 'flex';
      }

      function copyLicenseKey(key) {
        navigator.clipboard.writeText(key);
        showToast('License key copied to clipboard!', 'success');
      }
    });
  </script>

</body>
</html>